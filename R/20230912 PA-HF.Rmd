---
title: "Physical activity and HF"
author: "Valirie N. Agbor"
date: "`r Sys.Date()`"
output: html_document
---


# Workflow 

1. Import packages and import data 
2. Explore and clean data - taking note of variables with missing observations (Done)
3. Determine the number of participants included at baseline and perform exclusions (Done)
4. Explore variations in levels of physical activity by sex and area (Done)
5. Create Table 1 (Adjust means and proportions using direct standardisation) (Done)
6. Perform univariate survival analyses (Done)
7. Perform multivariable cox regression analysis (All done)
   - Modelling and variable selection
   - Consider performing age-sex-specific analysis 
   - Assessing model assumption 
8. Perform subgroup analyses 
9. Perform sensitivity analyses 



# Import packages and read data 

```{r Import packages and data}


rm (list = ls())

#Loading required packages

pacman::p_load(# Descriptive tables 
               DirectStandardisation, compareGroups, Epi, lubridate, qvcalc, broom,
               
               # Data manipulation 
               tidyverse, purrr, stringr,forcats, skimr, gtools, lmtest,
               
               #For plotting 
               Jasper, ggplot2, gridExtra,
               
               #Survival analysis
               survival,survminer)

# Import custom fonts 
# font_import()
# loadfonts(device = c("all", "pdf", "postscript", "win"), quiet = TRUE)

#loading baseline data

baseline <- read_csv(
  "K:/kadoorie/Staff_Folders/Valirien/DAR-2022-00245-V1 - Copy/data_baseline_questionnaires.csv", 
  col_types = cols())
endpoint <- read_csv(
  "K:/kadoorie/Staff_Folders/Valirien/DAR-2022-00245-V1 - Copy/endpoints.csv", 
  col_types = cols())



knitr::opts_chunk$set(echo = FALSE, root.dir = "J:/Physical activity and HF/R codes")
```


## Function to compute standardised means and proportions
The `make_standardised_ckb_data` function is a wrapper for the DirectStandardisation package 


```{r}

# Load custom function for data manipulation and more 
source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/recode01_fn.R")
source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/make_standardised_baseline_ckb_data.R")
source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/df_transpose.R")
source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/make_quartile_var_labels.R")
source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/string_add_and.R")
source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/trim_and_scale.R")
source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/Merge_Resurvey_data.R")

# Line plots
source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/ggLinePlot.R")
source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/Make_LineData_Mean.R")
source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/Make_LineData_Prop.R")

# Cox regression 
source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/standardised incidence.R")
source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/non_linearity_test.R")
source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/regresssion_dilution_ratio_peto.R")
source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/regresssion_dilution_ratio_rosner.R")

# Assess variables that improve model fit
source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/lrtest_model_fit.R")
source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/Cox_shape_strength_data_fn.R")
source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/trend_het_test.R")
source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/Cox_interaction.R")
source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/lrtest_change_chi2.R")
source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/order_row.R")
source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/add_table_header.R")

```


```{r}

# Number of participants at baseline 
format(
  nrow(baseline), 
  big.mark   = ",", 
  scientific = FALSE
)



```

# Data wrangling 


```{r Endpoint data}

# Endpoint headers

end_new_names <- c("PHD", "HF","RD",  
                   "COPD", "Acute_MI", "IHD")

end_pattern   <- c("ep_CKB0012", "ep_CKB0080", "ep_CKB0032", 
                   "ep_CKB0033", "ep_CKB0004", "ep_CKB0003")


# select and rename relevant endpoints

endpoint <- endpoint %>% select(csid, contains(end_pattern))

for (i in 1:length(end_new_names)) {
  
  colnames(endpoint) <- str_replace_all (names(endpoint), end_pattern[i], end_new_names[i])
  
}

 
```



```{r merging all data sets}

# baseline_resurv <-  merge(baseline, resurveys, by = "csid", all = TRUE)
# merged_data <- merge(baseline_resurv, endpoint, by = "csid", all=TRUE)

merged_data <- merge(baseline, endpoint, by = "csid", all=TRUE)

```


Variables with missing data
- bmi_calc (n=2)

```{r Explore dataset for missing data}

# skim(merged_data)

#detach("package:skimr", unload = TRUE)



```


## Perform exclusion 

```{r Exclusion}

# Variables for exclusion 
merged_data <- 
  merged_data %>% 
  dplyr::mutate(
    missing_bmi = ifelse(is.na(bmi_calc), 1, 0),
    rhd_present = case_when(rheum_heart_dis_diag == 1 | rheum_heart_dis_now == 1 ~ 1, TRUE ~ 0), 
    chd_present = case_when(chd_diag == 1 | chd_now == 1 ~ 1, TRUE ~ 0),
    stroke_present = case_when(stroke_or_tia_diag == 1 | stroke_or_tia_now == 1 ~ 1, TRUE ~ 0),
    cancer_present = case_when(cancer_diag == 1 | cancer_now == 1 ~ 1,TRUE ~ 0)
    )

# Numbers excluded 
exclu_vars <- c("missing_bmi", "rhd_present", "chd_present", "stroke_present", "cancer_present")

n_excluded <- map(
  .x = exclu_vars, 
  ~ merged_data %>% 
        dplyr::group_by(merged_data[[.x]]) %>% 
        dplyr::summarise(n = n()) %>% 
        dplyr::slice(-1) %>% 
        pull(n)
  )

names(n_excluded) <- exclu_vars

merged_data <- merged_data %>% filter(missing_bmi    != 1 & 
                                      rhd_present    != 1 &  
                                      chd_present    != 1 &
                                      stroke_present != 1 &
                                      cancer_present != 1
                                      ) 


# New number of participants 
format(
  nrow(merged_data), 
  big.mark   = ",", 
  scientific = FALSE
)

512724 - 486374
```


                                      
**Quintiles of physical activity:** c("[0,8.72]", "(8.72,14.2]", "(14.2,21.8]", "(21.8,33.2]", "(33.2,133]")


```{r Data wrangling - Baseline characteristics}

# Main exposure 
# Calculate quantile of physical activity by sex 
# Derive occupational and non-occupational MET and create Q5

merged_data <- 
  merged_data %>%  
  dplyr::mutate(
    met_q5 = factor(quantcut(met, 5), labels = paste0("Q", 1:5)), 
    met_work_q5 = factor(quantcut(met_work, 5), labels = paste0("Q", 1:5)), 
    met_nonwork = met - met_work, 
    met_nonwork_q5 = factor(quantcut(met_nonwork, 5), labels = paste0("Q", 1:5))
    ) 




#1. Demographic characteristics: ------

# Age, sex, area, region, marital status, education, household income, occupation

# Load custom function to recode binary variables labelled 0 and 1
source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/recode01_fn.R")

 merged_data <- merged_data %>% 
  
                 mutate(age = age_at_study_date_x100/100, # Age in years 
                        
                        #5-year age groups 
                        age5         = cut(age, 
                                           breaks         = seq(30, 80, 5), 
                                           include.lowest = TRUE, 
                                           right          = FALSE, 
                                           labels         = c("30-34", "35-39", "40-44", 
                                                              "45-49", "50-54", "55-59", 
                                                              "60-64", "65-69", "70-74", "75-79")
                                           ),
                        
                        #10 years age groups 
                        age10        = cut(age, 
                                           breaks         = seq(30, 80, 10), 
                                           include.lowest = TRUE,
                                           right          = FALSE, 
                                           labels         = c("30-39", "40-49", "50-59", "60-69", "70-79")), 
                        
                        age_group3  = factor(case_when(age <  50 ~ "Below 50", 
                                                       age >= 50 & age < 70 ~ "50-69", 
                                                       age >= 70 ~ "70+")),
                        
                        age65       = factor(ifelse(age >= 65, "65 and over", "Below 65")),
                         
                        
                        #Sex
                        sex = factor(ifelse(is_female == 1, "Women", "Men")), 
                        
                        #Area (urban and rural)
                        area = factor(region_is_urban, 
                                             levels = c(1, 0), 
                                             labels = c("Urban", "Rural")), 
                        
                        #Region (All 10 regions)
                        region = factor(region_code,
                                         levels = c(12, 16, 26, 36, 46, 52, 58, 68, 78, 88),
                                         labels = c("Qingdao", "Harbin", "Haikou", "Suzhou", "Liuzhou",
                                                    "Sichuan", "Gansu", "Henan", "Zhejiang", "Hunan")), 
                        
                        #Seasons
                        
                        
                        #Marital status 
                        marital_status_married = as.factor(ifelse(marital_status == 0, "Married", "Other")),
          
                        #Level of education
                        edu = factor(case_when(highest_education == 0 ~ "No formal", 
                                               highest_education == 1 ~ "Primary", 
                                               highest_education == 2 ~ "Middle", 
                                               highest_education >= 3 ~ "High school or higher"), 
                                     
                                     levels = c("No formal", "Primary", "Middle", "High school or higher")),
                        
                        edu_bin = factor(case_when(edu == "No formal" ~ "No formal", 
                                                   edu == "Primary"   ~ "Primary", 
                                                   TRUE ~ "Middle school or higher")),
                        
                        #Household income 
                        h_income = factor(case_when(household_income <= 2 ~ "<10k", 
                                                    household_income == 3 ~ "10k-29.9k", 
                                                    household_income == 4 ~ "30k-34.9k", 
                                                    TRUE ~ ">=35k"), 
                                          
                                          levels = c("<10k", "10k-29.9k", "30k-34.9k", ">=35k")),
                        
                        h_income_bin = factor(ifelse(household_income <= 2 & !is.na(household_income), "<10k", "10k and over")),
                        
                        #Occupation 
                        occupation_fct = as.factor(occupation), 
                        occupation = fct_recode(occupation_fct, agriculture_and_related   = "0",  
                                                                factory_worker            = "1", 
                                                                administrator_or_manager  = "2", 
                                                                professional_or_technical = "3", 
                                                                sales_and_service_workers = "4", 
                                                                retired                   = "5", 
                                                                housewife_or_husband      = "6", 
                                                                self_employed             = "7", 
                                                                unemployed                = "8", 
                                                                other_or_not_stated       = "9"),
                        
                        agric_factory = factor(case_when(occupation == "agriculture_and_related" | 
                                                         occupation == "factory_worker" ~ "Agriculture or factor worker", 
                                                         TRUE ~ "Others"), 
                                               
                                               levels = c("Agriculture or factor worker", "Others")), 
                        
                        occu_farmer = factor(ifelse(occupation == "agriculture_and_related", "agriculture_and_related", "Others")))

 

#2. Lifestyle factors: -------------------------------------------------------------------------------------------------------------
 
#Ever-regular smokers, weekly drinkers, total physical activity 

merged_data %>% 
      mutate(smoking_status = factor(case_when(smoking_category == 1 ~ "Never smoker", 
                                               smoking_category == 2 | smoking_category == 3 ~ "Ever-smoker", 
                                               TRUE ~ "Current")),              
             
             ever_reg_smoker = factor(ifelse(smoking_status != "Never smoker", "Ever regular", "Never")),
             
             #Weekly drinkers 
             alcohol_category = as.factor(alcohol_category),
             alcohol_category = fct_recode(alcohol_category, "Never regular drinkers" = "1", 
                                                             "Ex-regular drinkers"    = "2", 
                                                             "Reduced intake"         = "3", 
                                                             "Occasional drinkers"    = "4", 
                                                             "Occasional drinkers"    = "5", 
                                                             "Regular drinker"        = "6"), 
             
             alcohol_recode  = factor(case_when (alcohol_category == "Regular drinker"        ~ "Current",
                                                 alcohol_category == "Ex-regular drinkers"    ~ "Ex-drinkers",
                                                 alcohol_category == "Never regular drinkers" ~ "Never", 
                                                 TRUE ~ "Others"
                                                 ),
                                      
                                      levels = c("Current", "Ex-drinkers", "Never", "Others")), 
             
             current_drinkers = factor(ifelse(alcohol_category == "Regular drinker", "Yes", "No"), 
                                       levels = c("Yes", "No")
                                       ),
             
             # Sedentary time in hours per day
             sed_time_hr      = tv_reading_hours/7,
             
             # Waist circumference
             waist_circ_cm    = waist_mm/10, 
             
             # % Fat 
             fat_percent      = fat_percent_x10/10,

             #BMI 
             bmi_cat = factor(
               
               case_when(
                 
                 bmi_calc  < 18.5 ~ "Underweight (< 18.5)", 
                 bmi_calc >= 18.5 & bmi_calc < 23 ~ "Normal (18.5 to <23)", 
                 bmi_calc >= 23 & bmi_calc < 25 ~ "Overweight (23 to <25)", 
                 bmi_calc >= 25 ~ "Obesity (25+)", 
                 TRUE ~ as.character(NA)
                 
                 ), 
               
               levels = c(
                 "Underweight (< 18.5)", 
                 "Normal (18.5 to <23)", 
                 "Overweight (23 to <25)", 
                 "Obesity (25+)"
                 )
                              
               ), 
             
             obese   = factor(case_when(bmi_cat == "Obesity" ~ "Yes", 
                                        bmi_cat != "Obesity" ~ "No", 
                                        TRUE ~ as.character(NA)), 
                                                 levels = c("Yes", "No")))       ->  merged_data 

 
   #4. Self reported health and prevalent disease

lab_yesno <- c("Yes", "No")

# Recode 0 and 1 variables 

var_names_old <- list("has_diabetes", "has_copd", "tb_diag", "emph_bronc_diag", "asthma_diag", 
                       "cirrhosis_hep_diag", "rheum_arthritis_diag", "kidney_dis_diag")

var_names_new <- list("diabetes","copd", "tuberculosis", "emphysema_bronchitis", 
                      "asthma", "cirr_hepb", "rheum_art", "kidney_dis")


 
if (length(var_names_old) != length(var_names_new) ) {
  
  warning("Length of vectors do not match.\nCheck that the old and new names match")
  
}



for (i in seq_along(var_names_old)) {
  
  
  merged_data <- my_recode01_fn(data       = merged_data, 
                              col_name_old = var_names_old[[i]], 
                              col_name_new = var_names_new[[i]], 
                              to_factor    = TRUE)
  
}


merged_data <- merged_data %>%  
                  mutate(## CVD and metabolic diseases
                         
                         HTN        = factor(ifelse(hypertension_diag == 1          |
                                                    used_blood_pressure_drugs == 1 |
                                                    sbp_mean >= 140               |
                                                    dbp_mean >= 90, "Yes", "No"),
                                             levels = lab_yesno),

                         # Chronic lung disease

                         emphy_bronc_asthma   = factor(ifelse(emphysema_bronchitis == "Yes" |
                                                            asthma == "Yes", "Yes", "No"), levels = lab_yesno),

                         CLD = factor(case_when(emphy_bronc_asthma == "Yes" |
                                                      tuberculosis == "Yes" | copd == "Yes" ~ "Yes",

                                                TRUE ~ "No"), levels = lab_yesno),

                         SOB_walking = factor(ifelse(walking_short_of_breath == 0, "Yes", "No"), levels = lab_yesno),                         
                         
                         # Others
                         
                         self_rated_health = factor(case_when(self_rated_health <= 1 ~ "Excellent or good", 
                                                              self_rated_health == 2 ~ "Fair", 
                                                              self_rated_health == 3 ~ "Poor")),
                         
                         poor_health = factor(ifelse(self_rated_health == "Poor", "Yes", "No"))) #For summary table 



rm("baseline", "endpoint")



```


## Figure 1 - Compute age-sex-specific level of physical activity by urban and rural areas

```{r Figure 1 METs by age, sex and area}

# Get age-specific levels of physical activity by sex and area ---------------------------------------------------------------------

stratified_met <- merged_data %>% 
                         dplyr::group_by(area, sex, age5) %>% 
                  
                                summarise(n        = n(), 
                                          sd_met   = sd(met), 
                                          se_met   = sd_met / sqrt(n), 
                                          mean_met = mean(met),
                                          lci_met  = mean_met - 1.96*se_met, 
                                          uci_met  = mean_met + 1.96*se_met, 
                                          mean_age = mean(age)
                                          ) %>% 
                  
                                select(area, sex, age5, mean_met:mean_age) %>% 
                                
                          # Split dataset by urban and rural
                          dplyr::group_by(area) %>% 
                                 group_split()
                                


# Get  standardised mean (SD) PA for men and women by area --------------------------------------------------------------------------


PA_sex_region <- map(.x = levels(merged_data$area),
                       
                       ~ adjmeans(data                   = merged_data %>% filter(area == .x), 
                                  outcome_vars           = "met", 
                                  categorical_vars       = "sex", 
                                  adjustment_vars        = "age5"
                                  ) %>% 
                         
                         dplyr::transmute(sd_met   = round(met.se * sqrt(met.N.Freq), 1), 
                                          mean_sd  = paste0(round(met.mean, 1), " (", sd_met, ")"),
                                          variable = met.variable, 
                                          levels   = met.levels, 
                                          strata   = .x
                                       ) %>% 
                        
                        `row.names<-`(NULL)
     )


## Explore the variations in adjusted levels of physical activity by age, sex and area ----------------------------------------------

plot_list <- map2(.x = stratified_met, 
                  .y = seq_along(stratified_met), 
                   
                    ~ ggplot(data = .x,  mapping = aes(x = mean_age, y = mean_met, color = sex)) +
                        geom_line() +
                        geom_point() + 
                        geom_errorbar(mapping = aes(x     = mean_age, 
                                                    y     = mean_met, 
                                                    ymin  = lci_met, 
                                                    ymax  = uci_met,
                                                    color = sex)) +
                      # Themes 
                      theme_void() + 
                      
                      theme(axis.text.x  = element_text(size = 13, vjust = 0),
                            axis.text.y  = element_text(size = 13, hjust = 1), 
                            axis.title.x = element_text(size = 14, vjust = -1), 
                            axis.title.y = element_text(size = 14, angle = 90, vjust = 8)) +
              
                      geom_segment(mapping = aes(x = 28, xend = 28, y = 5, yend = 40),linewidth = 0.7, color = "black") + 
                      geom_segment(mapping = aes(x = 30, xend = 80, y = 4, yend = 4), linewidth = 0.7, color = "black") +
                    
                      theme(axis.ticks        = element_line(linewidth = 0.6),
                            axis.ticks.length = unit(0.25, "cm"), 
                            plot.margin       = unit(c(1.5, 1, 1, 1), "cm"), 
                            legend.position   = list(c(0.15, 0.2), "none")[[.y]]) + 
                     
                     guides(color = guide_legend(title      = "", 
                                                title.theme = element_text(size = 10.2,face = "bold"), 
                                                title.hjust = 0,  
                                                label.theme = element_text(size = 10.2), 
                                                label.hjust = 0)) +
              
                      # Scales 
                      scale_x_continuous(limits = c(28, 80), 
                                         expand = c(0, 0), 
                                         breaks = seq(30, 80, 10), 
                                         labels = seq(30, 80, 10)) + 
                      
                      scale_y_continuous(limits = c(4, 40),
                                         expand = c(0, 0), 
                                         breaks = seq(5, 40, 5), 
                                         labels = seq(5, 40, 5)) + 
                     
                     scale_color_manual(values  = c("black", "#B30437"), 
                                        labels  = unique(.x$sex)) +
              
                      coord_cartesian(xlim = c(28, 80), ylim = c(4, 40), clip = "off") + 
                    
                     # Title for group means 
                      annotate (geom       = "text",
                                 x          = 31, 
                                 y          = 39, 
                                 label      = "Physical activity, mean (SD)", 
                                 size       = 4, 
                                 fontface   = 2,
                                 color      = "black", 
                                 lineheight = 1, 
                                 hjust      = 0) +
                    
                    # Text for group levels
                     annotate (geom       = "text",
                               x          = 31,
                               y          = 36.5,
                               label      = paste0(PA_sex_region[[.y]]$levels, ":", collapse = "\n"),
                               size       = 4,
                               color      = "black",
                               hjust      = 0) +

                    # Text for group means
                     annotate (geom       = "text",
                               x          = 41,
                               y          = 36.5,
                               label      = paste0(PA_sex_region[[.y]]$mean_sd, collapse = "\n"),
                               size       = 4,
                               color      = "black",
                               hjust      = 0) +

                     # Text for group level
                     geom_text(x        = 55,
                               y        = 42,
                               label    = paste0(LETTERS[.y], ". ", unique(.x$area), "\n"),
                               size     = 5,
                               hjust    = 0.5,
                               fontface = 2,
                               color    = "black") +

                     # Axis titles  
                     ylab( list("Mean physical activity, MET-hour/day (95% CI)", NULL)[[.y]] ) + 
                     xlab("\nAge at baseline, year")
     )
                    

## Export plot 
plot <- ggarrange (plotlist = plot_list, 
                   ncol       = 2,
                   widths     = rep(1, 2), 
                   heights    = rep(1.5,2)
                   )

 png("Figure 1 PA by age, sex, and area.png", units = "in", width = 10, height = 9, pointsize = 2, res = 600)
 
 
 
 annotate_figure(plot, 
                 top = text_grob("Figure 1: Variations in age-specific levels of total physical activity by sex and area\n", 
                                 color = "black", 
                                 face  = "bold", 
                                 size  = 16))
 
 dev.off()

 

```


### Levels of physical activity by mean temperature 

```{r}

min(merged_data$mean_temp, na.rm = TRUE)
max(merged_data$mean_temp, na.rm = TRUE)

merged_data$mean_temp_cat <- cut(merged_data$mean_temp, 
                                 breaks         = seq(-24.3, 34.6, 10), 
                                 include.lowest = TRUE, 
                                 right          = FALSE)

merged_data %>% dplyr::group_by(sex, mean_temp_cat) %>% 
                       summarise(mean_met = mean(met, na.rm = TRUE), 
                                 mean_temp = mean(mean_temp, na.rm = TRUE)) %>% 
                       filter(!is.na(mean_temp_cat)) %>% 
  
  ggplot( mapping = aes (x = mean_temp, y = mean_met, color = sex)) + geom_point() +  geom_smooth() 


```



## Table 1 - Calculating standard deviation from the adjmeans function after standardisation

```{r Table 1 - Standardised by age, sex, and area}

# Standardise numeric variables --------------------------------------------------------------------------------------------------

numeric_vars        <- c("met", "sbp_mean", "dbp_mean", "heart_rate_mean", "bmi_calc", 
                         "waist_circ_cm", "fat_percent")

numeric_vars_labels <- c("Total physical activity, MET-hour/day", "SBP, mmHg", 
                         "DBP, mmHg",  "Resting heart rate, bpm", "BMI, kg/m2", 
                         "Waist circumference, cm", "Body fat percentage, %")

adjust_vars  <- c("age5", "sex", "region")

# Set a dataframe name for this operation to avoid errors
df_name <- merged_data

numeric_vars_df <- map(.x = numeric_vars, 
                           
                           # Loop over numeric variables and standardise
                           ~ adjmeans(data                   = df_name, 
                                      outcome_vars           = .x,
                                      categorical_vars       = "met_q5", 
                                      adjustment_vars        = adjust_vars) %>% 
                           
                           # Wrangling 
                             transmute(cat_var_lab = !!sym(paste0(.x, ".levels")),
                                       stdev       = !!sym(paste0(.x, ".se")) * sqrt( !!sym(paste0(.x, ".N.Freq")) ), 
                                       mean_sd     = paste0(round( !!sym(paste0(.x, ".mean")) , 1), " (", 
                                                            round(stdev, 1), ")"
                                                           )
                                         ) %>% 
                             
                             select(-stdev) %>% 
                             
                             pivot_wider(names_from = cat_var_lab, values_from = mean_sd) %>% 
                            
                             mutate(exposure = .x, 
                                    ALL      = paste0(round(mean(df_name [ , .x], na.rm = TRUE), 1), " (", 
                                                      round(sd  (df_name [ , .x], na.rm = TRUE), 1), ")")
                                    ) %>% 
                             
                             relocate(.before = 1, exposure)

                           ) %>% 
  
                       #Bind dataframes 
                         map_dfr( ~rbind(.x))


# Assign labels 
numeric_vars_df$exposure <- numeric_vars_labels



# Standardise age, sex and area

age_var <- "age"

age_df <- adjmeans(data                   = df_name, 
                   outcome_vars           = age_var,
                   categorical_vars       = "met_q5", 
                   adjustment_vars        = c("sex", "region")) %>% 
         
         # Wrangling 
           transmute(cat_var_lab = !!sym(paste0(age_var, ".levels")),
                     stdev       = !!sym(paste0(age_var, ".se")) * sqrt( !!sym(paste0(age_var, ".N.Freq")) ), 
                     mean_sd     = paste0(round( !!sym(paste0(age_var, ".mean")) , 1), " (", 
                                          round(stdev, 1), ")"
                                         )
                       ) %>% 
           
           select(-stdev) %>% 
           
           pivot_wider(names_from = cat_var_lab, values_from = mean_sd) %>% 
          
           mutate(exposure = age_var, 
                  ALL      = paste0(round(mean(df_name [ , age_var], na.rm = TRUE), 1), " (", 
                                    round(sd  (df_name [ , age_var], na.rm = TRUE), 1), ")")
                  ) %>% 
           
           relocate(.before = 1, exposure)

age_df$exposure <- "Age, mean (SD), years"


# Merge age to all numeric variables 
numeric_vars_df <- rbind(age_df, numeric_vars_df)




# Stndardise categorical variables --------------------------------------------------------------------------------------------

cat_vars     <- c( # Sociodemographic status
                   "marital_status_married", "edu_bin", "h_income_bin", "agric_factory",
              
                   # Prior disease"
                   "HTN",  "diabetes", "copd", "emphysema_bronchitis", 
                   "asthma", "SOB_walking", "poor_health"
                   )

cat_var_labels <- c("Married", "Level of education", "Annual household income", "Farming",
                   
                   "Hypertension", "Diabetes", "COPD", "Emphysema or bronchitis", "Asthma",
                   "Shortness of breath on walking", "Poor self-rated health"
                   )


cat_var_list <- map(.x = cat_vars,  
                  
                  ~ adjprop(dataset                = df_name,
                            outcome_vars           = .x,
                            categorical_vars       = "met_q5",
                            adjustment_vars        = adjust_vars) %>% 
                    
                    dplyr::mutate_at(vars(contains("proportion")), ~round(.*100, 1)) %>% 
                  
                    select(contains(c("levels", "Freq", "proportion"))) %>% 
                    `row.names<-` (paste0("Q", 1:5)) %>%  
                    t(.) %>% 
                    
                    `row.names<-` (str_replace_all(string      = row.names(.), 
                                                   pattern     = paste0(.x, "."), 
                                                   replacement = ""
                                                   ) %>% 
                                     
                                  str_replace_all(pattern      = "proportion.", 
                                                  replacement  = ""
                                                  )
                                   ) %>% 
                    
                    as.data.frame(.) %>% 
                    dplyr::mutate(exposure = paste0(.x, "_", row.names(.))) %>% 
                    relocate("exposure", .before = "Q1") %>%
                    
                    `row.names<-`(NULL) %>% 
                    slice(-c(1:2))
                    
                  ) 

# Get overall group proportions
prop_overall <- map(.x = cat_vars, ~ df_name %>% 
                                       dplyr::group_by( .data[[.x]] ) %>% 
                                       dplyr::summarise(n       = n(), 
                                                        N       = length( df_name[[.x]] ), 
                                                        prop100 = round((n/N)*100, 1) 
                                                        ) %>% 
                                       dplyr::select(all_of(.x), prop100)
                    )

cat_var_df <- map2_dfr(.x = cat_var_list, 
                       .y = prop_overall, 
                   
                       ~ .x %>% dplyr::mutate(ALL = .y$prop100))
 

# Alcohol and smoker by sex -------------------------------------------------

sex_groups        <- levels(df_name$sex)
sex_specific_vars <- c("ever_reg_smoker", "current_drinkers")

sex_list          <- list()
prop_sex          <- list()


for (cc in sex_groups) {
  
      sex_list[[cc]] <- map(.x = sex_specific_vars,  
                      
                            ~ adjprop(dataset                = df_name %>% filter(sex == cc),
                                      outcome_vars           = .x,
                                      categorical_vars       = "met_q5",
                                      adjustment_vars        = c("age5", "region")
                                      ) %>% 
                              
                              dplyr::mutate_at(vars(contains("proportion")), ~round(.*100, 1)) %>% 
                            
                              select(contains(c("levels", "Freq", "proportion"))) %>% 
                              `row.names<-` (paste0("Q", 1:5)) %>%  
                              t(.) %>% 
                              
                              `row.names<-` (str_replace_all(string      = row.names(.), 
                                                             pattern     = paste0(.x, "."), 
                                                             replacement = ""
                                                             ) %>% 
                                               
                                            str_replace_all(pattern      = "proportion.", 
                                                            replacement  = ""
                                                            )
                                             ) %>% 
                              
                              as.data.frame(.) %>% 
                              dplyr::mutate(exposure = paste0(cc, "_", .x, "_", row.names(.))) %>% 
                              relocate("exposure", .before = "Q1") %>%
                              
                              `row.names<-`(NULL) %>% 
                              slice(-c(1:2))
                        
                      ) 

      # Get proportions
      prop_sex[[cc]] <- map(.x = sex_specific_vars, 
                
                            ~ df_name %>% 
                                  filter(sex == cc) %>% 
                                  dplyr::group_by(!!rlang::sym(.x)) %>% 
                                  summarise(n       = n(), 
                                            N       = nrow(df_name %>% filter(sex == cc)), 
                                            prop100 = round((n/N)*100, 1)) %>%  
                              select(all_of(.x), prop100)
                
                )
      
}

sex_list_flat <- flatten(sex_list)
prop_sex_flat <- flatten(prop_sex)


sex_specific_df <- map2_dfr(.x = sex_list_flat, 
                            .y = prop_sex_flat, 
                   
                            ~ .x %>% dplyr::mutate(ALL = .y$prop100))


# Standardise sex and area --------------------------------------------------
adjust_vars2 <- list(sex = c("age5", "region"), 
                     area = c("age5", "sex"))

cat_vars2    <- c("sex", "area")


cat_vars_list2 <- map2(.x = cat_vars2,
                       .y = adjust_vars2, 
              
                        ~ adjprop(dataset                = df_name,
                                  outcome_vars           = .x,
                                  categorical_vars       = "met_q5",
                                  adjustment_vars        = .y) %>% 
                          
                          dplyr::mutate_at(vars(contains("proportion")), ~round(.*100, 1)) %>% 
                        
                          select(contains(c("levels", "Freq", "proportion"))) %>% 
                          `row.names<-` (paste0("Q", 1:5)) %>%  
                          t(.) %>% 
                          
                          `row.names<-` (str_replace_all(string      = row.names(.), 
                                                         pattern     = paste0(.x, "."), 
                                                         replacement = ""
                                                         ) %>% 
                                           
                                        str_replace_all(pattern      = "proportion.", 
                                                        replacement  = ""
                                                        )
                                         ) %>% 
                          
                          as.data.frame(.) %>% 
                          dplyr::mutate(exposure = paste0(.x, "_", row.names(.))) %>% 
                          relocate("exposure", .before = "Q1") %>%
                          
                          `row.names<-`(NULL) %>% 
                          slice(-c(1:2))
                    
                         ) 

prop_overall2 <- map(.x = cat_vars2, ~ df_name %>% 
                                       dplyr::group_by( .data[[.x]] ) %>% 
                                       dplyr::summarise(n       = n(), 
                                                        N       = length( df_name[[.x]] ), 
                                                        prop100 = round((n/N)*100, 1) 
                                                        ) %>% 
                                       dplyr::select(all_of(.x), prop100)
                    )
 
cat_var_df2 <- map2_dfr(.x = cat_vars_list2, 
                      .y = prop_overall2, 
                   
                      ~ .x %>% dplyr::mutate(ALL = .y$prop100))


cat_var_df_all <- rbind(cat_var_df2, 
                        sex_specific_df, 
                        cat_var_df
                       ) %>% 
                       dplyr::mutate(across(.cols = everything(), ~as.character(.)))





# Merge all datasets for numeric and categorical variables -----------------------------------------------------------------
 
table1_df <- rbind(numeric_vars_df, cat_var_df_all) 

merged_data %>% dplyr::group_by(met_q5) %>% summarise(n = n())

# write.csv(table1_df, file = "Table 1 - standardised means and props.csv")


rm("df_name", "data_temp")

```


# Cox regression 

Time-scale = Participant's age, 
Follow-up time split by age at risk and used for the stratified Cox analysis 



## Determine sex-specific quintile for associations

## Select variable for Cox regression 

```{r}

numeric_covs <- c("age", 
                  "heart_rate_mean", 
                  "waist_circ_cm", 
                  "bmi_calc", 
                  "sed_time_hr"
                  )

ordinal_covs <- c("age10", "h_income", "edu")

nominal_covs <- c("area", 
                  "agric_factory", 
                  "smoking_status", 
                  "alcohol_recode", 
                  "copd", 
                  "emphysema_bronchitis", 
                  "diabetes", 
                  "HTN",
                  "bmi_cat")


strata_vars <- c("sex","region")
expos       <- c("met_q5", "met")
expos2      <- c("met_nonwork", "met_nonwork_q5", "met_work", "met_work_q5")
exclusion   <- c("poor_health", "SOB_walking", "CLD")
exit_status <- c("HF_combined_ep", "PHD_combined_ep")

date_vars   <- c("HF_combined_datedeveloped", 
                 "PHD_combined_datedeveloped", 
                 "study_date", 
                 "censoring_date", 
                 "dob_anon") 


regress_vars <- c(
      "csid", 
      numeric_covs, 
      ordinal_covs, 
      nominal_covs, 
      strata_vars, 
      expos,  
      expos2,
      exclusion, 
      exit_status,
      date_vars)

df_reduced <- merged_data %>% select(all_of(regress_vars))

```


## Create sex-specific MET quintiles 

```{r}

df_reduced <- 
  
  df_reduced %>% 
     dplyr::group_by(sex) %>% 
     dplyr::group_split() %>% 
     map( 
       ~dplyr::mutate(
         .x, 
         met_q5_sex = factor(quantcut(met, 5), labels = paste0("Q", 1:5)), 
         met_work_q5_sex = factor(quantcut(met_work, 5), labels = paste0("Q", 1:5)), 
         met_nonwork_q5_sex = factor(quantcut(met_nonwork, 5), labels = paste0("Q", 1:5)))
       ) %>% 

     map_dfr( ~rbind(.x)) 
     

```



## Expand data by time in study (Lexis Expansion)

```{r Expand data}

source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/standardised incidence.R")

 
# Vectors of necessary labels 
exit_date_lab   <- c("HF_combined_datedeveloped", "PHD_combined_datedeveloped")
exit_status_lab <- c("HF_combined_ep", "PHD_combined_ep")


# Expand dataset
# Create a list of two datasets (one for HF and the other for PHD)
# Drop variable for follow-up time for PHD in the HF dataset and vice versa
    # Take note of the order of the `futime_vars`
# Attribute a common name to follow up times in both datasets

data_expanded <-  
  
  map2(
    
    .x = exit_status_lab, 
    .y = seq_along(exit_status_lab),
                       
     ~ lexis_expansion(
       
       data          = df_reduced, 
       birth_date    = "dob_anon", 
       entry_date    = "study_date", 
       exit_date     = exit_date_lab[.y],
       agegrp_breaks = c(30, 50, 60, 70, 80, 100),
       status        = exit_status_lab[.y]
                       
       ) 
      
    ) 

# Five-year age at risk groups

data_expanded <- 
  
  map(
    .x = data_expanded,
    ~ .x %>% 
      dplyr::mutate(
        
        age_lexis5 = cut(age_lexis, 
                         breaks         = seq(30, 80, 5), 
                         include.lowest = TRUE, 
                         right          = FALSE
                         )
        
      )
  )


# Descriptives: Number of events and length of follow-up 
map(.x = data_expanded, ~ summary.Lexis(.x, timeScales = TRUE))


```



## Run cox regression with sequential adjustments

To do (workflow)
- Create of list of names of all covariates 
- Separate numeric, ordinal and norminal covariates 
- Test for departures from linearity (right a little function to do a quick check)
- After deciding on how to model covariates (perform sequential adjustments)
- Decide on variables to retain in the final multivariable model



- Numeric variables (with missing data):  fat_percent, mean_temp

## Assess departure from linearity

```{r}

source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/non_linearity_test.R")

numeric_covs <- c("age", "heart_rate_mean", "waist_circ_cm", "bmi_calc", "sed_time_hr")

ordinal_covs <- c("age10", "h_income", "edu")

nominal_covs <- c("agric_factory", "smoking_status", "alcohol_recode", "copd", 
                  "emphysema_bronchitis", "diabetes", "HTN")

main_cov     <- "met_q5_sex"


# Testing for non-linearity -------------------------------------------------------------------------------------------------------------
# 
# testing_vars <- c(numeric_covs, ordinal_covs)
# 
# non_lin_test <- list()
# 
# for (vars in testing_vars) {
# 
#     non_lin_test[[vars]] <- map(.x = data_expanded,
# 
#                                 ~ lrtest_non_linearity(
#                                     data        = .x,
#                                     adjust_var  = main_cov,
#                                     test_var    = vars,
#                                     strata_vars = c("age_lexis5", "sex", "region"))
#                                   )
# 
# }

# Significant evidence of departure from linearity
# DECISION: Categorise numeric covariates; Adjust for age and age2 at baseline


# Create new variables -----------

data_expanded <- map(
  .x = data_expanded,
  ~mutate(
    .x, 
    across(.cols = numeric_covs[-1], 
           ~factor(quantcut(.x, 4), labels = paste0("Q", 1:4)),
           .names = "{.col}_Q4"),
    age_sq = age^2
    )
  )

# Relabel quintiles to be more informative for forest plots 

# Generate labels 
# Only use labels for HF

num_var_q     <- paste0(numeric_covs[-1], "_Q4")
num_var_new   <- numeric_covs[-1]

q_numeric_cov <- 
  
  map2(.x = num_var_q,
       .y = num_var_new,
       
        ~data_expanded[[1]] %>% 
          dplyr::group_by(.data[[.x]]) %>% 
        
          summarise(
            
            var_min = min(.data[[.y ]]), 
            var_max = max(.data[[.y ]])
            
            ) %>% 
        
          dplyr::mutate(
            
            q_level  = .data[[.x ]],
            q_labels = case_when(
              
              q_level == "Q1" ~ paste0(q_level, " (<", round(var_max), ")"),
              q_level == "Q4" ~ paste0(q_level, " (", round(var_min), "+)"),
              TRUE            ~ paste0(q_level, " (",round(var_min), " to <", round(var_max), ")")
                                            
              )
                        
            ) %>%
         
          pull(q_labels)

      )

# Relabel variables 
for (df in seq_along(data_expanded)) {
  
  for (vi in seq_along(num_var_q)) {
  
  data_expanded[[df]][ , num_var_q[[vi]] ] <- factor(data_expanded[[df]][[num_var_q[[vi]]]], 
                                              labels = q_numeric_cov[[vi]])
  
  }
  
}




```


## Modelling 

Do not adjust for marital status as most participants in the CKB are married. 

```{r Model fit}

# Variable grouping 
fu_time        <- "lex.dur"
events_i       <- "lex.Xst"

main_cov       <- "met_q5_sex" 

stratify       <- c("age_lexis5", "sex", "region")

ses_vars       <- c("h_income", "edu", "agric_factory")
lifestyle_vars <- c("smoking_status", "alcohol_recode", "sed_time_hr_Q4")
phys_measure   <- c("heart_rate_mean_Q4", "waist_circ_cm_Q4", "bmi_calc_Q4")
med_history    <- c("copd", "emphysema_bronchitis", "diabetes", "HTN")


# Assess variables that improve model fit
source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/lrtest_model_fit.R")

# SES
ses_list <- list()

for (df in seq_along(data_expanded)){
  
  ses_list[[df]] <- map_dfr(.x = ses_vars, 
      
                          ~lrtest_model_fit(data             = data_expanded[[df]], 
                                             test_var        = .x, 
                                             adjustment_vars = main_cov, 
                                             strata_vars     = stratify, 
                                             futime          = "lex.dur", 
                                             event_var       = "lex.Xst") %>% 
                          pluck(., 2)
                        )
  
}
  

# Lifestyle
lstyle_list <- list()

for (df in seq_along(data_expanded)){
  
lstyle_list[[df]] <- map_dfr(.x = lifestyle_vars, 
      
                    ~lrtest_model_fit(data             = data_expanded[[df]], 
                                       test_var        = .x, 
                                       adjustment_vars = c(main_cov, ses_vars), 
                                       strata_vars     = stratify, 
                                       futime          = "lex.dur", 
                                       event_var       = "lex.Xst"
                                      ) %>% 
                    pluck(., 2)
                  )
  
}


# Medical history

medhist_list <- list()

for (df in seq_along(data_expanded)){
  
medhist_list[[df]] <- 
  
  map_dfr(
  
  .x = c(med_history, "heart_rate_mean_Q4"), 
      
  ~lrtest_model_fit(data             = data_expanded[[df]], 
                     test_var        = .x, 
                     adjustment_vars = c(main_cov, ses_vars, lifestyle_vars), 
                     strata_vars     = stratify, 
                     futime          = "lex.dur", 
                     event_var       = "lex.Xst"
                    ) %>% 
  pluck(., 2)
      )
  
}



```


## Main effect model and model assumptions

Model adjusted for 

**Minimal adjustment**
1. stratified by Age at risk (5-year bands), sex, and region
2. age and age^2 at baseline

**Further adjustment**
3. SES (income, education and manual work)
4. Lifestyle (smoking, alcohol, and sedentary time)
5. Physical measurement (resting heart rate)
6. Medical history (COPD and emphysema)

> Note: No adjusted was done for diabetes, adiposity, and HTN are these were
        considered effect modifiers


### Custom function for stratified Cox regression 
Runs

1. Regression by categorical exposure and obtains FAR. 
2. Regression by continuous exposure and corrects for regression dilution if specified

Returns a named list of
1. Model object that can be used for further analysis
2. Model summary
2. Dataframe of relevant model statistics
  **For categorical exposure**
    - Original parameters
    - FAR variance and se (if specified)
    - number of events per exposure category
  **For continuous exposure (including standard deviation)**
    - Original regression paraters
    - beta and se corrected for regression dilution (if specified) 

```{r}

Cox_shape_strength_data <- 
  
  function(dataset,
           exposure_var_cat            = NULL,
           exposure_var_cont           = NULL, 
           exposure_var_sd             = NULL,
           expo_type_shape             = FALSE,        # Categorical form
           expo_type_continuous        = FALSE,       # For continuous level
           expo_type_sd                = FALSE,       # Per SD change
           correct_regression_dilution = FALSE,       # Only for continuous exposure
           regression_dilution_ratio   = NULL,
           event_var                   = "lex.Xst",
           fu.time                     = "lex.dur", 
           stratify_vars               = c("age_lexis5", "sex","region"), 
           adjustment_vars             = c("age")
  ) {
    
    # Create formula for stratified Cox analysis
    left_side     <- paste0("Surv(", fu.time, ", ", event_var, ")")
    
    strata_vars   <- paste0("strata(", 
                            paste(stratify_vars, collapse = ", "), 
                            ")"
    )
    
    
    # Get FAR for categorical expo for shape plot 
    
    if(expo_type_shape == TRUE) {
      
      # Make formula
      covariates   <- paste(c(exposure_var_cat,adjustment_vars), collapse = " + ")
      
      form         <- as.formula(paste0(left_side, " ~ ", paste(covariates, strata_vars, sep = " + ")))
      
      # Length of factor levels
      expo_var_lev <- levels(dataset[[exposure_var_cat]])
      n_levels_exp <- length(levels(dataset[[exposure_var_cat]]))
      
      # Events (N)
      n_events <- 
        dataset %>% 
        dplyr::group_by(.data[[exposure_var_cat]]) %>% 
        dplyr::summarise(n_events = sum(.data[[event_var]])) %>% pull(n_events)
      
      
      # Fit model 
      model_fn   <- coxph(formula = form, data = dataset) 
      model_summ <- summary(model_fn)
      
      model_df   <- 
        
        broom::tidy(model_fn) %>% 
        dplyr::filter(grepl(pattern = exposure_var_cat, term)) %>% 
        add_row(.before = 1) %>% 
        
        dplyr::transmute(
          
          exposure     = expo_var_lev, 
          est_untrans  = estimate, 
          se_untrans   = std.error, 
          p.value      = p.value
          
        )
      
      FAR    <- 
        
        qvcalc(model_fn, exposure_var_cat)$qvframe %>% 
        
        dplyr::mutate(
          
          far_levels = row.names(.), 
          n = n_events
          
        ) %>% 
        
        `row.names<-`(NULL) 
      
      df_model_far <- cbind(model_df, FAR)
      
      
      # Return the model summary and FAR dataframe
      return(list("model_summary" = model_summ,
                  "dataframe"     = df_model_far)) 
      
      
    } 
    
    
    # Continuous exposure -----------------------------------------------------------------------------------------------
    
    ## Correct for regression dilution 
    
    if(expo_type_continuous       == TRUE && 
       correct_regression_dilution == TRUE) {
      
      
      if(all(
        is.null(exposure_var_cont) | is.null(regression_dilution_ratio)
      )) {
        
        stop("`exposure_var_cont` and `regression_dilution_ratio` must be provided\n")
      }
      
      
      if(!is.null(exposure_var_cat)) 
        stop("`exposure_var_cat` must be set to NULL if `expo_type_continuous` == TRUE\n")
      
      
      if(!is.null(exposure_var_sd)) 
        stop("`exposure_var_sd` must be set to NULL if `expo_type_continuous` == TRUE\n")
      
      # Make formula
      covariates   <- paste(c(exposure_var_cont,adjustment_vars), collapse = " + ")
      
      form         <- as.formula(paste0(left_side, " ~ ", paste(covariates, strata_vars, sep = " + ")))
      
      model_cont      <- coxph(form, data = dataset)
      model_cont_summ <- summary(model_cont)
      
      model_cont  <- broom::tidy(model_cont) %>% 
        dplyr::filter(grepl(pattern = exposure_var_cont, term)) %>% 
        dplyr::mutate(est_corrected = estimate / RDR,    # Correct estimate/se for regression dilution
                      se_corrected  = std.error / RDR,
                      hr_corrected  = exp(est_corrected), 
                      lci_corrected = exp(est_corrected - 1.96*se_corrected), 
                      uci_corrected = exp(est_corrected + 1.96*se_corrected)
        ) %>% 
        dplyr::select(-statistic)
      
      
      return(list("model_summary" = model_cont_summ,
                  "dataframe"     = model_cont)) 
      
    }
    
    ## DO NOT correct for regression dilution 
    
    if(expo_type_continuous       == TRUE && 
       correct_regression_dilution == FALSE) {
      
      # Make formula
      covariates   <- paste(c(exposure_var_cont,adjustment_vars), collapse = " + ")
      
      form         <- as.formula(paste0(left_side, " ~ ", paste(covariates, strata_vars, sep = " + ")))
      
      
      model_cont      <- coxph(form, data = dataset)
      model_cont_summ <- summary(model_cont)
      
      model_cont      <- broom::tidy(model_cont) %>% 
        dplyr::filter(grepl(pattern = exposure_var_cont, term)) %>% 
        dplyr::mutate(hr  = exp(estimate), 
                      lci = exp(estimate - 1.96*std.error), 
                      uci = exp(estimate + 1.96*std.error)
        ) %>% 
        dplyr::select(-statistic)
      
      
      return(list("model_summary" = model_cont_summ,
                  "dataframe"     = model_cont))
      
    }    
    
    
    # Per SD change in exposure ------------------------------------------------------------------------------------------
    
    ## Correct for regression dilution 
    #=================================
    
    if(expo_type_sd == TRUE && correct_regression_dilution == TRUE)
      
      if(is.null(exposure_var_sd)) { 
        
        stop("`exposure_var_sd` is needed")
  
      } else{
        
        
    
    # Make formula
    covariates   <- paste(c(exposure_var_sd,adjustment_vars), collapse = " + ")
    
    form         <- as.formula(paste0(left_side, " ~ ", paste(covariates, strata_vars, sep = " + ")))
    
    model_cont_metsd      <- coxph(form, data = dataset)
    model_cont_metsd_summ <- summary(model_cont_metsd)
    
    
    model_cont_metsd  <- 
      broom::tidy(model_cont_metsd) %>% 
      dplyr::filter(grepl(pattern = exposure_var_sd, term)) %>% 
      dplyr::mutate(
        
        est_corrected  = estimate/RDR,
        se_corrected   = std.error / RDR, 
        hr_corrected   = exp(est_corrected), 
        lci_corrected  = exp(est_corrected - 1.96*se_corrected), 
        uci_corrected  = exp(est_corrected + 1.96*se_corrected)
        
     )%>% 
      
      dplyr::select(-statistic)
    
    
    return(list("model_summary" = model_cont_metsd_summ,
                "dataframe"     = model_cont_metsd))                                                                                                       
    
  }
    
    
    ## Do not correct for regression dilution 
    #=========================================
    
    if(expo_type_sd == TRUE && correct_regression_dilution == FALSE)
      
      if(is.null(exposure_var_sd)) stop("`exposure_var_sd` is needed")
    
    # Make formula
    covariates   <- paste(c(exposure_var_sd,adjustment_vars), collapse = " + ")
    
    form         <- as.formula(paste0(left_side, " ~ ", paste(covariates, strata_vars, sep = " + ")))
    
    model_cont_metsd      <- coxph(form, data = dataset)
    model_cont_metsd_summ <- summary(model_cont_metsd)
    
    
    model_cont_metsd      <- broom::tidy(model_cont_metsd) %>% 
                              dplyr::filter(grepl(pattern = exposure_var_sd, term)) %>% 
                              dplyr::mutate(hr   = exp(estimate), 
                                            lci  = exp(estimate - 1.96*std.error), 
                                            uci  = exp(estimate + 1.96*std.error)
                              )%>% 
                              dplyr::select(-statistic)
    
    
    return(list("model_summary" = model_cont_metsd_summ,
                "dataframe"     = model_cont_metsd))                                                                                                       
    
  }


```



## Import resurvey data and calculate RDR 

### RDR for main analysis 

```{r}

resurvey1 <- read_csv(
  "K:/kadoorie/Staff_Folders/Valirien/DAR-2022-00245-V1 - Copy/data_resurvey1_questionnaires.csv", 
  col_types = cols())

resurvey2 <- read_csv(
  "K:/kadoorie/Staff_Folders/Valirien/DAR-2022-00245-V1 - Copy/data_resurvey2_questionnaires.csv", 
  col_types = cols())


resurv_merged_df <- 
   
  df_reduced %>% 
  select(csid, age, age10, sex, area, region, met_q5, met) %>% 
  
  left_join(., resurvey1 %>% 
                 select(csid, met) %>% 
                 dplyr::transmute(csid = csid, met_rs1 = met), by ="csid") %>% 

  left_join(., resurvey2 %>% 
                 select(csid, met) %>% 
                 dplyr::transmute(csid = csid, met_rs2 = met), by ="csid") %>% 
  
  dplyr::mutate(met_resurv_ave = case_when(!is.na(met_rs1) & !is.na(met_rs2) ~ (met_rs1 + met_rs2)/2, 
                                            TRUE ~ met_rs2))  
  
# Overall RDR -------

## MacMahon Peto #####
resurv_met_df <-
  resurv_merged_df %>%

  # Calculate stratum-specific mean met
  dplyr::group_by(met_q5) %>%
  dplyr::summarise(
    
    mean_met_baseline = mean(met, na.rm = TRUE),
    mean_met_resurvey = mean(met_resurv_ave, na.rm = TRUE),
    min_met_baseline  = min(met, na.rm = TRUE),
    max_met_baseline  = max(met, na.rm = TRUE)
 
    ) %>%
  dplyr::mutate(
    
    baseline_pa_group = case_when(
      
      met_q5 == "Q1" ~paste0(met_q5, " (<", format(round(max_met_baseline, 2), nsmall = 2L), ")"),
      met_q5 == "Q5" ~paste0(met_q5, " (",  format(round(min_met_baseline, 2), nsmall = 2L), "+)"),
      TRUE           ~paste0(met_q5, " (",  format(round(min_met_baseline, 2), nsmall = 2L), " to <",
                                            format(round(max_met_baseline, 2), nsmall = 2L), ")")
                                                 
      )
                   
    )



# # Calculate RDR 
# range_baseline <- range(resurv_met_df$mean_met_baseline) 
# range_resurvey <- range(resurv_met_df$mean_met_resurvey)
# 
# RDR =  (range_resurvey[2] - range_resurvey[1]) / (range_baseline[2] - range_baseline[1])                
# RDR   
# #0.3944968
# 



# Rosner (adjusting for age at baseline, sex, and area) ####

RDR_ci <- 
  lm(formula = met ~ met_resurv_ave + age10 + sex + area, data = resurv_merged_df) %>% 
  broom::tidy(.) %>% 
  filter(term == "met_resurv_ave") %>% 
  dplyr::mutate(
    lci = estimate - 1.96*std.error, 
    uci = estimate + 1.96*std.error, 
    est_ci = paste0(
      format(round(estimate, 2), nsmall = 2), " (", 
      format(round(lci, 2)), " - ", 
      format(round(uci, 2)), ")"
      )
    ) %>% 
  pull(est_ci)

  
RDR <- 
  lm(formula = met ~ met_resurv_ave + age10 + sex + area, data = resurv_merged_df) %>% 
  broom::tidy(.) %>% 
  filter(term == "met_resurv_ave") %>% 
  pull(estimate)



# Make table for reporting 
RDR_report <- 
      resurv_met_df %>%
         select(baseline_pa_group, mean_met_baseline, mean_met_resurvey) %>% 
         dplyr::mutate(
           dilution_ratio = NA, 
           mean_met_baseline = format(round(mean_met_baseline, 2), nsmall = 2L), 
           mean_met_resurvey = format(round(mean_met_resurvey, 2), nsmall = 2L)) %>% 
         add_row(.before = 1, dilution_ratio = RDR_ci) %>% 
         rename(
           "Baseline PA group" = baseline_pa_group,
           "Mean baseline PA"  = mean_met_baseline, 
           "Mean resurvey PA"  = mean_met_resurvey)



RDR_peto <- rdr_peto(dataset = resurv_met_df,
                     baseline_var = "mean_met_baseline", 
                     resurvey_var = "mean_met_resurvey")

# RDR_Peto = 0.3949879

# write.csv(RDR_report, file = "Table S1 - Baseline and resurvey mean PA.csv")
     
rm(resurvey1, resurvey2)

```



### RDR by age-at-risk group and by gender 

- Age-sex specific RDR were adjusted for area

```{r}

# Three categories for age at risk 

resurv_merged_df <- 
  resurv_merged_df %>% 
  dplyr::mutate(age3 =  cut(age, 
                            breaks         = c(30, 60, 70, 81), 
                            include.lowest = TRUE, 
                            right          = FALSE, 
                            labels         = c("30-59", "60-69", "70+")
                            )
                )



age_sex_names <-
      sort(c(paste0(unique(resurv_merged_df$age3), "_", levels(resurv_merged_df$sex)[[1]]), 
        paste0(unique(resurv_merged_df$age3), "_", levels(resurv_merged_df$sex)[[2]])))


RDR_age_sex_df <- 
  resurv_merged_df %>%
  dplyr::group_by(age3, sex) %>% 
  dplyr::group_split() %>% 
  map(
    
    ~lm(formula = met ~ met_resurv_ave + area, data = .x) %>% 
        broom::tidy(.) %>% 
        filter(term == "met_resurv_ave") %>% 
        select(estimate, std.error) %>% 
        dplyr::mutate(
               lci = estimate - 1.96*std.error, 
               uci = estimate + 1.96*std.error, 
               beta_ci = paste0(format(round(estimate, 2), nsmall = 2L), " (", 
                                format(round(lci, 2), nsmall = 2L), " - ", 
                                format(round(uci, 2), nsmall = 2L), ")")
                      )
        
      )%>% 
  setNames(age_sex_names)
  
#Get RDR values
RDR_age_sex <- map(.x = RDR_age_sex_df, ~.x$estimate)



# Make table for reporting 
df_age_sex_rdr <- 
  
resurv_merged_df %>% 
  
  # Calculate stratum-specific mean met
  dplyr::group_by(age3, sex) %>% 
  dplyr::summarise(mean_met_baseline = mean(met, na.rm = TRUE), 
                   mean_met_resurvey = mean(met_resurv_ave, na.rm = TRUE)
                   ) %>% 
  ungroup() %>% 
  dplyr::mutate(RDR_age_sex = map_chr(.x = RDR_age_sex_df, ~.x$beta_ci))


# 
# RDR_report <- 
#       resurv_met_df %>%
#          select(baseline_pa_group, mean_met_baseline, mean_met_resurvey) %>% 
#   
#          dplyr::mutate(dilution_ratio = NA, 
#                        mean_met_baseline = format(round(mean_met_baseline, 2), nsmall = 2L), 
#                        mean_met_resurvey = format(round(mean_met_resurvey, 2), nsmall = 2L)
#                        ) %>% 
#   
#                 add_row(.before        = 1, 
#                         dilution_ratio = round(RDR, 2))
# 
# write.csv(RDR_report, file = "Table S1 - Baseline and resurvey mean PA.csv")
#      
# 


```



### For type of physical activity analysis 


```{r}

resurvey1 <- read_csv(
  "K:/kadoorie/Staff_Folders/Valirien/DAR-2022-00245-V1 - Copy/data_resurvey1_questionnaires.csv", 
  col_types = cols())

resurvey2 <- read_csv(
  "K:/kadoorie/Staff_Folders/Valirien/DAR-2022-00245-V1 - Copy/data_resurvey2_questionnaires.csv", 
  col_types = cols())

n_resurvey_sample  <- map(list(resurvey1, resurvey2), ~nrow(.x)) # Original resurvey sample sizes --
csid_baseline_data <- merged_data$csid # Get id for those included in baseline survey --


# Define non-work  
resurvey1$met_nonwork <- resurvey1$met - resurvey1$met_work
resurvey2$met_nonwork <- resurvey2$met - resurvey2$met_work

# Variable to calculate RDR --
exposures    <- c("met_work", "met_nonwork")
main_cov     <- c("met_work_q5", "met_nonwork_q5") 


RDR_type <- list()
RDR_ci_type <- list()
RDR_peto_type <- list()
resurv_var_ls_type <- list()  # Get dataframe for resurvey variable 


for (j in seq_along(exposures)) {
   
    var_cont   <- exposures[j]
    var_cat    <- main_cov[j]
    
    
    # Merge baseline and resurvey datasets ===========
    
    resurv_merged_df <- 
       
      df_reduced %>% 
      select(
        
        csid, 
        study_date,
        age,  
        sex, 
        area, 
        region,  
        all_of(c(var_cont, var_cat))
        
        ) %>% 
      
      left_join(.,  
        resurvey1 %>% 
           dplyr::transmute(
             csid     = csid, 
             age_rs1  = age_at_study_date_x100/100,
             var_rs1  = .data[[var_cont]],             # Rename exposure
             date_rs1 = study_date),
        by ="csid") %>% 
    
      left_join(., 
        resurvey2 %>% 
           dplyr::transmute(
             csid     = csid, 
             age_rs2  = age_at_study_date_x100/100,
             var_rs2  = .data[[var_cont]], 
             date_rs2 = study_date), 
        by ="csid") %>% 
      
      dplyr::mutate(
        resurv_ave   = case_when(
                          !is.na(var_rs1) & !is.na(var_rs2) ~ (var_rs1 + var_rs2)/2,
                           is.na(var_rs1) & !is.na(var_rs2) ~ var_rs2, 
                          !is.na(var_rs1) &  is.na(var_rs2) ~ var_rs1), 
        time_to_rs1  = interval(study_date, date_rs1)/dyears(1), 
        time_to_rs2  =interval(study_date, date_rs2)/dyears(1))  
      
  
    
    # Calculate RDR (Peto's method) ------
    
    resurv_var_df <-
      
      resurv_merged_df %>%
      dplyr::group_by(.data[[var_cat]]) %>%
      dplyr::summarise(
        mean_var_baseline = mean(.data[[var_cont]], na.rm = TRUE),
        mean_resurvey1    = mean(var_rs1, na.rm = TRUE),
        mean_time_to_rs1  = mean(time_to_rs1, na.rm = TRUE), 
        mean_resurvey2    = mean(var_rs2, na.rm = TRUE),
        mean_time_to_rs2  = mean(time_to_rs2, na.rm = TRUE), 
        mean_var_resurvey = mean(resurv_ave, na.rm = TRUE),
        mean_resurvey_time= (mean_time_to_rs1 + mean_time_to_rs2)/2,
        min_var_baseline  = min(.data[[var_cont]], na.rm = TRUE),
        max_var_baseline  = max(.data[[var_cont]], na.rm = TRUE), 
        .groups = "drop") %>%
      
      dplyr::mutate(
        baseline_group = case_when(
            .data[[var_cat]] == "Q1" ~paste0(
                                       .data[[var_cat]], " (<", 
                                       format(
                                         round(max_var_baseline, j), nsmall = j), ")"),
            
            .data[[var_cat]] == "Q5" ~paste0(
                                        .data[[var_cat]], " (",  
                                        format(round(min_var_baseline, j), nsmall = j), "+)"),
            
            TRUE ~paste0(
              .data[[var_cat]], " (",  
              format(round(min_var_baseline, j), nsmall = j), " to <",
              format(round(max_var_baseline, j), nsmall = j), ")")
            )
        
        )
    
    RDR_peto_type[[j]] <- rdr_peto(dataset = resurv_var_df, 
                                   baseline_var = "mean_var_baseline", 
                                   resurvey_var = "mean_var_resurvey")
    
    
    # Rosner RDR --
    
    RDR_list <- rdr_rosner(dataset = resurv_merged_df, 
                           baseline_var = var_cont, 
                           resurvey_var = "resurv_ave", 
                           adjustment_variables = c("age", "sex", "region"))
    
    
    RDR_ci_type[[j]] <- RDR_list$df_model$est_ci
    RDR_type[[j]]    <- RDR_list$rdr
    
    
    # Make table for reporting ----
    RDR_report <-
        resurv_var_df %>%
           select(baseline_group, mean_var_baseline, mean_var_resurvey) %>%
  
           dplyr::mutate(
             dilution_ratio = NA,
             mean_var_baseline = format(round(mean_var_baseline, 2), nsmall = 2L),
             mean_var_resurvey = format(round(mean_var_resurvey, 2), nsmall = 2L)) %>%
  
           add_row(.before = 1, dilution_ratio = RDR_ci_type[[j]]) %>%
           rename(
             "Baseline group" = baseline_group,
             "Mean baseline"  = mean_var_baseline,
             "Mean resurvey"  = mean_var_resurvey
        )
    
    # write.csv(RDR_report, file = paste0("Table S1 - Baseline and resurvey mean ", var_cont, ".csv"))
     
    
    # Get resurvey summary level data by quintiles of exposures 
    # To be used for subsequent analyses 
    resurv_var_ls_type[[j]] <- resurv_var_df

    
    
# 
# RDR_report <-
#       resurv_met_df %>%
#          select(baseline_pa_group, mean_met_baseline, mean_met_resurvey) %>%
# 
#          dplyr::mutate(dilution_ratio = NA,
#                        mean_met_baseline = format(round(mean_met_baseline, 2), nsmall = 2L),
#                        mean_met_resurvey = format(round(mean_met_resurvey, 2), nsmall = 2L)
#                        ) %>%
# 
#                 add_row(.before        = 1,
#                         dilution_ratio = round(RDR, 2))
# 
# write.csv(RDR_report, file = "Table S1 - Baseline and resurvey mean PA.csv")
# 
#  

   } 

rm(resurvey1, resurvey2) 


```



## Quintile and FAR

```{r}

main_cov  <- "met_q5_sex" 
m_final   <- list()


for (df in seq_along(data_expanded)) {
  

    m_final[[df]] <- 
      
    Cox_shape_strength_data(
      
      dataset          = data_expanded[[df]], 
      exposure_var_cat = main_cov,
      expo_type_shape  = TRUE,
      adjustment_vars  = c(ses_vars,
                          lifestyle_vars,
                          "emphysema_bronchitis",
                          "copd"), 
      print_model_info = FALSE
                            
      )
    

}
 

# Add mean PA to far dataset
FAR <- map(.x = list(m_final[[1]]$dataframe, m_final[[2]]$dataframe), 
           ~dplyr::mutate(.x, mean_met = resurv_met_df$mean_met_resurvey))

## Assess non-linearity in main exposure -------------------------------------------------------------------------------------------
# non_linr <- map(.x = data_expanded,
#                 
#                 ~ lrtest_non_linearity(data  = .x, 
#                               test_var    = "met_q5_sex",                      
#                               adjust_var  = c("age", "age_sq", 
#                                               ses_vars, lifestyle_vars, "heart_rate_mean_Q4", 
#                                               "copd", "emphysema_bronchitis"),            
#                               futime      = "lex.dur",
#                               event_var   = "lex.Xst",
#                               strata_vars = stratify
#                               )
#                 )

## Assess Cox PH assumption --------------------------------------------------------------------------------------------------------
# schoen_resid_hf  <- cox.zph(m_final[[1]]$model_object)
# schoen_resid_phd <- cox.zph(m_final[[2]]$model_object)

# ## Visual assessment
 # map(.x = list(schoen_resid_hf, schoen_resid_phd), ~plot(.x, var=c(1:12)))

```



## HR per change in continuous form of exposure 

```{r}


#Continue variables for main exposure (met4 and metsd) ------------------------ 
data_expanded <- map(.x = data_expanded, ~.x %>% 
                               dplyr::group_by(sex) %>% 
                               dplyr::mutate(met4  = met / 4, 
                                             metsd = scale(met)
                                             ) %>% 
                               dplyr::ungroup()
                    )



# Run regression
# Corrected for regression dilution 

expos      <- c("met4", "metsd")
model_cont <- list()


for(df in seq_along(data_expanded)) {
  
model_cont[[df]] <- 
         map_dfr(.x = expos, 
             ~Cox_shape_strength_data(
                        dataset                     = data_expanded[[df]], 
                        exposure_var_cont           = .x,
                        expo_type_continuous        = TRUE,
                        correct_regression_dilution = TRUE,       
                        regression_dilution_ratio   = RDR,
                        adjustment_vars             = c(ses_vars,
                                                        lifestyle_vars,
                                                        "emphysema_bronchitis",
                                                        "copd"), 
                        print_model_info = FALSE
                        ) %>% 
               
                        pluck(., 2)
            ) %>% 
           rename("exposure" = term)

}



```



### Make shape plot 

```{r}


# select which columns we want, and give them appropriate names
plotdata <- map(.x = FAR, ~data.frame(RF_Level = .x$mean_met, 
                                      Estimate = .x$estimate, 
                                      StdErr   = .x$quasiSE, 
                                      Events   = .x$n, 
                                      exp_est  = exp(.x$estimate)
                                      ) %>% 
                           `row.names<-`(NULL)
                )
 

# headers to put above each column of panels
headers  <- c("A. Heart failure", "B. Pulmonary heart disease")
# events_N <- map_chr(.x = data_expanded, ~paste0(sum(.x$lex.Xst), "/", nrow(merged_data)))
  
# Labels for hazard ratios 
lab_text <- c("4 MET-hour/day", 
              paste0("1 SD (", round(sd(merged_data$met, na.rm = TRUE), 1), " MET-hour/day)")
              )


label_hr  <- map(.x = model_cont, 
                 ~.x %>% 
                   dplyr::mutate(term = lab_text, 
                                 hr_ci = paste0(format(round(hr_corrected, 2)),  " (",
                                                format(round(lci_corrected, 2)), " - ", 
                                                format(round(uci_corrected, 2)), ")") 
                                 ) %>% 
                   select(term:hr_ci)
                 )

# Set page margins: format is c(bottom, left, top, right)
# par(mar=c(7.63354827113009e-05, 2, 7.63354827113009e-05, 2))

# set up the Jasper page
type <- "JPG"
SetPage(orient ="LANDSCAPE", 
        nlong = 2, 
        nshort = 1, 
        page_height =8,
        page_width = 8,
        type=type, 
        page_dpi = 600,
        page_pointsize = 8,
        suppress.date = TRUE,
        titlespace=0.12,
        footer="All analyses were stratified by age-at-risk, sex, and study area and adjusted for income, education, occupation, alcohol, smoking, sedentary time,\n ephysema, bronchitis and COPD\n
        ",
        footer.cex = 1.2,
        footerspace=0.06,
        filestem="Figure 2 Shape Plot PA and heart failure")


# loop over the panels in a slightly strange order, to match data
for (j in seq_along(plotdata)) {
 
	# do the linear plot for this set of data
	LinearPlot(plotdata[[j]], 
	           new.plot          = TRUE, 
	           mainfont          = 1,   
	           YLogScale         = TRUE, 
	           ExponentiateDataOnPlot = TRUE,
	           boxparm.stderr    = 0.025, 
	           xlim              = c(10,30),  
	           xticks            = seq(10,30, 5), 
	           ylim              = c(0.25, 2), 
	           yticks            = c(0.25, 0.5, 1, 2), 
	           margins           = c(5,5,3,2),  
	           xticklabs.cex     = 0.9, 
	           yticklabs.cex     = 0.9,
	           PointLabelsTop    = "exp_est",
	           PointLabelsBottom = "Events",
	           PointLabelsCEX    = 0.9, 
	           TruncateAtPlotLims = FALSE,
	           CIsOnTop           = TRUE)
	
	# add axis labels
	AxisLabels(ylab     = "Hazard ratio (95% CI)", 
	           xlab     = "Usual total physical activity, MET-hour/day", 
	           mainfont = 1.1
	           )
	
	par(xpd=NA)
	
	# add the column heading
	text(x=c(11.5, 15)[j], y=log(2.2), labels=headers[j], font=2, cex = 1.2)
	# text(x=20, y=log(1.7), labels=events_N[j], font=1, cex = 1.15)
	
	# Add labels for HR 
	text(x=10,   y=log(0.26), labels=paste0("Per usual level\n", paste0(label_hr[[j]]$term, ":", collapse = "\n")), font=1, cex = 0.9, adj=c(0, 0))
	text(x=22, y=log(0.26), labels=paste0("HR (95% CI)\n", paste0(label_hr[[j]]$hr_ci, collapse = "\n")), font=1, cex = 0.9, adj=c(0, 0))

}

## Plot title 
text(x      =6, 
     y      = log(2.8), 
     font   =2, 
     cex    = 1.2,
     adj    =c(0.5, 0),
     labels ="Figure 2: Associations of fifths of usual total physical activity with heart failure and \npulmonary heart disease"
     )


closeFile(type)


```


## Run analysis by type of physical activity 

Perform mutual adjustments for occupational and non-occupational physical activity


```{r}

#Create exposure variables (met_work4 and met_worksd) -------------------- 
  
data_expanded <- map(
  .x = data_expanded, 
  ~.x %>% dplyr::group_by(sex) %>% 
  dplyr::mutate(
    #Work
    !!paste0("met_work", 4)       := .data[["met_work"]] / 4, 
    !!paste0("met_work", "sd")    := scale( .data[["met_work"]] ), 
    !!paste0("met_work", "_sq")  := (.data[["met_work"]])^2, 
    
    # Non-work
    !!paste0("met_nonwork", 4)    := .data[["met_nonwork"]] / 4, 
    !!paste0("met_nonwork", "sd") := scale( .data[["met_nonwork"]] ), 
    !!paste0("met_nonwork", "_sq")  := (.data[["met_nonwork"]])^2) %>% 
  
  dplyr::ungroup()
  
)
   


main_cov_type <- c("met_work_q5_sex", "met_nonwork_q5_sex") 

mutual_adj <- list( # Reverse order to ease the iteration
  met_work_adj    = c("met_nonwork", "met_nonwork_sq"), 
  met_nonwork_adj = c("met_work", "met_work_sq")) 


m_final_type  <- list()


for (df in seq_along(data_expanded)) {
  

    m_final_type[[df]] <- 
      
    map2(
      .x = main_cov_type, 
      .y = mutual_adj,
      ~Cox_shape_strength_data(
          dataset          = data_expanded[[df]], 
          exposure_var_cat = .x,
          expo_type_shape  = TRUE,
          adjustment_vars  = c(ses_vars, lifestyle_vars, "emphysema_bronchitis", "copd", .y), 
          print_model_info = FALSE) %>% 
        pluck(., 2)
      )
    

}
 

# Add mean PA to far dataset
main_cov_type2  <- c("met_work_q5", "met_nonwork_q5") 

FAR_type <- list()

for (k in seq_along(m_final_type)) {
  
  FAR_type[[ c("hf", "phd")[k] ]] <- 
    
    map2(
      .x = m_final_type[[k]], 
      .y = seq_along(resurv_var_ls_type),
      
      ~inner_join(
          .x,
          resurv_var_ls_type[[.y]] %>% 
          select(all_of(c(main_cov_type2[[.y]], "mean_var_resurvey"))) %>% 
          mutate(across(
            .cols = all_of(main_cov_type2[[.y]]), 
            .fns = as.character)
            ),
        by = c("exposure" = main_cov_type2[[.y]])
        ) 
        
    )
  
}




```



## HR per change in continuous form of exposure 

```{r}


# Run regression
# Corrected for regression dilution 

expos_type      <- c("met_work4", "met_nonwork4")

mutual_adj <- list(
  met_work_adj    = c("met_nonwork", "met_nonwork_sq"), 
  met_nonwork_adj = c("met_work", "met_work_sq")) 


model_cont_type <- list()


for(df in seq_along(data_expanded)) {
  
model_cont_type[[df]] <- 
         map2(
           .x = expos_type,
           .y = seq_along(RDR_peto_type),
           ~Cox_shape_strength_data(
                  dataset                     = data_expanded[[df]], 
                  exposure_var_cont           = .x,
                  expo_type_continuous        = TRUE,
                  correct_regression_dilution = TRUE,       
                  regression_dilution_ratio   = RDR_peto_type[[.y]],
                  adjustment_vars = c(ses_vars, lifestyle_vars, "emphysema_bronchitis", "copd", mutual_adj[[.y]]), 
                  print_model_info = FALSE
                  ) %>% 
             
             pluck(., 2) %>% 
           rename("exposure" = term)
           )

}

 

```



### Make shape plot for work type 

```{r}


FAR_type_flat <- flatten(FAR_type)
FAR_type_flat <- c(FAR_type_flat[c(1,3,2,4)]) # Rearrange data for plotting 


# select which columns we want, and give them appropriate names
plotdata <- map(
  .x = FAR_type_flat, 
  ~data.frame(
    RF_Level = .x$mean_var_resurvey, 
    Estimate = .x$estimate, 
    StdErr   = .x$quasiSE, 
    Events   = .x$n, 
    exp_est  = exp(.x$estimate)
    ) %>% 
   `row.names<-`(NULL)
  )
 

n_events <- map_chr(.x = plotdata, ~paste0("(n=", sum(.x$Events), ")"))

# headers to put above each column of panels
headers <- c("HF", "PHD", "HF", "PHD")
headers <- map2_chr(
  .x = headers, 
  .y = n_events, 
  ~paste0(.x, "\n", .y)
)

subheaders <- c("A. Occupational physical activity", "", "B. Non-occupational physical activity", "")
# events_N <- map_chr(.x = data_expanded, ~paste0(sum(.x$lex.Xst), "/", nrow(merged_data)))
  

# set up the Jasper page
type <- "JPG"
SetPage(orient ="LANDSCAPE", 
        nlong = 2, 
        nshort = 2, 
        page_height =9.5,
        page_width = 7.5,
        type=type, 
        page_dpi = 300,
        page_pointsize = 12,
        suppress.date = TRUE,
        titlespace=0.07,
        footer="All analyses were stratified by age-at-risk, sex, and study area and adjusted for income, education, occupation, alcohol, smoking, sedentary time,\n ephysema, bronchitis and COPD. Additiionally, occupational and non-occupational PA were mututally adjusted for each other\nHF = Heart failure; PHD = Pulmonary heart disease; PA = Physical activity\n
        ",
        footer.cex = 1.2,
        footerspace=0.09,
        filestem="Figure PA type Shape Plot PA and heart failure")


# loop over the panels in a slightly strange order, to match data
for (j in seq_along(plotdata)) {
 
	# do the linear plot for this set of data
	LinearPlot(plotdata[[j]], 
	           new.plot          = TRUE, 
	           mainfont          = 1,   
	           YLogScale         = TRUE, 
	           ExponentiateDataOnPlot = TRUE,
	           boxparm.stderr    = 0.025, 
	           xlim              = c(0,30),  
	           xticks            = seq(0,30, 5), 
	           xticklabs         = c("0", "", "10", "", "20", "", "30"),
	           ylim              = c(0.25, 2), 
	           yticks            = c(0.25, 0.5, 1, 2), 
	           margins           = c(3,6,5,5),  
	           xticklabs.cex     = 0.9, 
	           yticklabs.cex     = 0.9,
	           PointLabelsTop    = NULL,
	           PointLabelsBottom = NULL,
	           PointLabelsCEX    = 0.8, 
	           TruncateAtPlotLims = FALSE,
	           CIsOnTop           = TRUE)
	
	# add axis labels
	AxisLabels(ylab     = rep(c("Hazard ratio (95% CI)", ""), 2)[j], 
	           xlab     = c("Usual occupational PA, MET-hr/day", 
	                        "Usual occupational PA, MET-hr/day", 
	                        "Usual non-occupational PA, MET-hr/d", 
	                        "Usual non-occupational PA, MET-hr/d")[j], 
	           mainfont = 1
	           )
	
	par(xpd=NA)
	
	# add the column heading
	text(x=15, y=log(1.8), labels=headers[j], font=2, cex = 1)
	text(x=-8, 
	     y=log(2.4), 
	     labels=subheaders[j],
	     adj = c(0,0),
	     font=2, 
	     cex = 1.05)
	# text(x=20, y=log(1.7), labels=events_N[j], font=1, cex = 1.15)
	
	# Add labels for HR 
# 	text(x=10,   y=log(0.26), labels=paste0("Per 4 MET-hr/day usual level\n", paste0(label_hr[[j]]$term, ":", collapse = "\n")), font=1, cex = 0.9, adj=c(0, 0))
# 	text(x=22, y=log(0.26), labels=paste0("HR (95% CI)\n", paste0(label_hr[[j]]$hr_ci, collapse = "\n")), font=1, cex = 0.9, adj=c(0, 0))
# 
 }

## Plot title 
text(x      =-14, 
     y      = log(90), 
     font   =2, 
     cex    = 1.1,
     adj    =c(0.5, 0),
     labels ="eFigure 5: Associations of fifths of usual occupational and non-occupational physical activity\nwith heart failure and pulmonary heart disease"
     )


closeFile(type)


```



## Compute age-sex specific HR 

### met4

- Age-sex specific betas and se were adjusted for age-sex specific RDR
```{r}

source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/trend_het_test.R")

# Wrangling  --------------------------------------------------------------------
data_expanded <- map(.x = data_expanded, 
                     ~.x %>% 
                       dplyr::mutate(
                         
                         age_lexis3 = cut(age_lexis, 
                                          breaks         = c(30, 60, 70, 81), 
                                          include.lowest = TRUE, 
                                          right          = FALSE, 
                                          labels         = c("30-59", "60-69", "70+")
                                          )
                         )
                     ) 



# Redefine age, sex met4 and metSD
# Redefining Met4 and MetSD makes no difference to the results*********

data_expanded <- map(.x = data_expanded, ~.x %>% 
                               dplyr::group_by(age_lexis3, sex) %>% 
                               dplyr::mutate(met4_age_sex  = met / 4, 
                                             metsd_age_sex = scale(met)
                                             ) %>% 
                               dplyr::ungroup()
                    )



prim_cov      <- "met4_age_sex"
age_lexis_var <- "age_lexis3"
sex_var       <- "sex"

coviariates <- paste(c(age_lexis_var, sex_var, 
                       # Program interaction terms 
                       paste0(
                              prim_cov, ":", 
                              paste0(c(age_lexis_var, sex_var), collapse = ":")
                              ), 
                       ses_vars, 
                       lifestyle_vars,  
                       "emphysema_bronchitis",
                       "copd"
                       ), collapse = " + "
                     )

left_side   <- paste0("Surv(", fu_time, ", ", events_i, ")")

form        <- as.formula(paste0(left_side, " ~ ", paste(coviariates, "strata(region)", sep = " + ")))


# Fit regression analysis
cox_strata <- 
  map(.x = data_expanded, 
       ~coxph(form, data = .x) %>% 
         broom::tidy(.) %>% 
         dplyr::filter(grepl(prim_cov, term)) %>% 
                arrange(term) %>% 
                select(-statistic) %>% 
        
        dplyr::mutate(term = str_replace_all(term, 
                                 pattern     = paste0(age_lexis_var, "|", sex_var, "|", ":", prim_cov), 
                                 replacement = ""
                                )
                      ) %>% 
        tidyr::separate(col = term, into = c("age", "sex"), sep = ":")
                  )


# Correct age-sex specific coefficients 
cox_strata <- 
  map(.x = cox_strata, 
      ~.x %>% 
        dplyr::group_by(age, sex) %>% 
        group_split() %>% 
        map2_dfr(.y = RDR_age_sex, 
                 ~.x %>% 
                   dplyr::mutate(estimate_c = estimate/.y, 
                                 se_c       = std.error/.y, 
                                 var        = se_c^2)
                 )
      )



# Perform heterogeneity tests
age_lex3_levels <- levels(data_expanded[[1]]$age_lexis3)

het_sex <- map(.x = cox_strata, 
               
               ~.x %>% 
                 dplyr::group_by(age) %>% 
                 dplyr::group_split() %>% 
                 
                 map_dfr( ~heterogeneity(.x$estimate_c, .x$se_c)) %>% 
                     dplyr::mutate(age       = age_lex3_levels, 
                                   test_type = "Heterogeneity")
               )


# Run IVWMA and get age-specific estimates
ivw_FE_age <- map(.x = cox_strata, 
                  
                  ~ .x %>% 
                     dplyr::group_by(age) %>% 
                            group_split()  %>% 
                            setNames(age_lex3_levels) %>% 
             
              map( ~metafor::rma(yi= estimate_c, vi= var, method = "FE", data = .x)) %>% 
  
              map( ~ tibble(beta    = .x$b[1,1],
                            se      = .x$se,
                            lci     = .x$ci.lb,
                            uci     = .x$ci.ub,
                            est_ci  = paste0(round(exp(beta), 2), " (",
                                        round(exp(lci), 2), " - ", round(exp(uci), 2), ")"
                                        )
                            )
                   ))
 

# Test trend across age-specific IV estimates 
df_ivw_age <- list()

for (i in seq_along(ivw_FE_age)) {
  
  df_ivw_age[[i]] <- map_dfr(.x = ivw_FE_age[[i]], ~rbind(.x))

}

trend_age <- map(.x = df_ivw_age,
                    ~trend(.x$beta, .x$se)) %>% 
                           map( ~tibble(DF         = .x$df, 
                                        test_stats = .x$`test statistic`, 
                                        p.trend    = .x$p) %>%  
                                  
                                  dplyr::mutate(test_type = "Trend")
                                )




cox_strata

```


### Wrangle data and make forest plot 
```{r}

source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/order_row.R")
source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/add_table_header.R")


# Wrangle main dataframe ----------------------------------------------------------------------------------------------

# Number of events by age and sex 
n_event_df <- map(.x = data_expanded, 
               ~.x %>% 
                dplyr::group_by(age_lexis3, sex) %>% 
                    summarise(n_events = sum(lex.Xst)) 
               )

cox_strata <- 
  map2(.x = cox_strata, 
       .y = seq_along(cox_strata), 
       ~.x %>% 
         select(-c(estimate:p.value)) %>% 
         dplyr::mutate(n_event = n_event_df[[.y]]$n_events) )  
  

# Format dataset to make forest plot -----------------------------------------------------------------------------------
# Add stats for trend and heterogeneity 

df_ageS_forest <- list()


for (j in seq_along(cox_strata)) {
  

  df_ageS_forest[[j]] <- 
    
      cox_strata[[j]] %>% 
          dplyr::group_by(age) %>% 
          dplyr::group_split() %>% 
          map2_dfr(.y = seq_along(.), 
                   ~.x  %>% 
                     
                     # Create new relevant columns 
                     dplyr::mutate(Het        = NA, 
                                   Trend      = NA,
                                   DF         = NA, 
                                   chi2       = NA, 
                                   p          = NA,
                                   test_type  = NA, 
                             
                                   IsDiamond  = 0, 
                                   FillColour = 1
                                   ) %>% 
                    
                     # Add a row for the IVW estimates
                     # At the end of each dataframe 
                     add_row(age        = unique(.$age), 
                             sex        = "Both", 
                             estimate_c = ivw_FE_age[[j]][[.y]]$beta, 
                             se_c       = ivw_FE_age[[j]][[.y]]$se,  
                             n_event    = sum(.x$n_event, na.rm = TRUE),
                             
                             DF         = het_sex[[j]]$df[.y], 
                             chi2       = het_sex[[j]]$`test statistic`[.y], 
                             p          = het_sex[[j]]$p[.y], 
                             
                             Het        = paste0(het_sex[[j]]$df[.y],  "," ,
                                                 format(
                                                    round(het_sex[[j]]$`test statistic`[.y], 2), 
                                                    nsmall = 2L),  "," ,
                                                  
                                                 format(round(het_sex[[j]]$p[.y], 4),nsmall = 4L)
                                                 ),
                             Trend      = NA,
                             test_type  = "heterogeneity",
                             
                             IsDiamond  = 1, 
                             FillColour = 0
                             ) 
                   ) 
    all_events <- sum(df_ageS_forest[[j]] %>% 
                        filter(sex == "Both") %>% 
                              pull(n_event), na.rm = TRUE)
    
    # Add table header
    df_ageS_forest[[j]] <- add_table_header(data             = df_ageS_forest[[j]], 
                                            group_var        = age, 
                                            group_level_var  = sex, 
                                            extra_space      = FALSE) %>% 
      
                           dplyr::rename("Heading" = sex) %>% 

      
                           add_row(Heading    = "All", 
                                   estimate_c = model_cont[[j]][model_cont[[j]]$exposure == "met4", ]$est_corrected, 
                                   se_c       = model_cont[[j]][model_cont[[j]]$exposure == "met4", ]$se_corrected,  
                                   n_event    = all_events,
                                   
                                   DF         = trend_age[[j]]$DF, 
                                   chi2       = trend_age[[j]]$test_stats, 
                                   p          = trend_age[[j]]$p.trend, 
                                   
                                   Trend      = paste0(trend_age[[j]]$DF,  "," ,
                                                       format(
                                                          round(trend_age[[j]]$test_stats, 2), 
                                                          nsmall = 2L),  "," ,
                                                        
                                                       format(round(trend_age[[j]]$p.trend, 4),nsmall = 4L)
                                                       ),
                                   Het        = NA,
                                   
                                   test_type  = "trend",
                                   
                                   IsDiamond  = 1, 
                                   FillColour = 0) %>%  as.data.frame(.)

   
   # End of for loop
}
 

```


## Make forest plot for age-sex-specific associations

```{r}



# Format dataset --------------------------------------------------------------------------------------------------------------------


# set up an object that stores the forest and associated metadata
forest1 <- FormatForest(rawdata     = df_ageS_forest[[1]] %>% 
                                      rename("Het1"        = Het, 
                                             "Trend1"      = Trend, 
                                             "IsDiamond1"  = IsDiamond, 
                                             "FillColour1" = FillColour
                                             ), 
                        forest.n    = 1, 
                        EstimateCol = "estimate_c",  
                        StdErrCol   = "se_c",
                        logData     = FALSE, 
                        getBlanks   = TRUE, 
                        getHets     = TRUE, 
                        getTrends   = TRUE)

# set up an object that stores the forest and associated metadata
forest2 <- FormatForest(rawdata     = df_ageS_forest[[2]]%>% 
                                      rename("Het2"        = Het,  
                                             "Trend2"      = Trend, 
                                             "IsDiamond2"  = IsDiamond, 
                                             "FillColour2" = FillColour
                                             ),  
                        forest.n    = 2, 
                        EstimateCol = "estimate_c",  
                        StdErrCol   = "se_c",
                        logData     = FALSE,  
                        getBlanks   = TRUE, 
                        getHets     = TRUE, 
                        getTrends   = TRUE)

blank.rows  <- forest1$blank.rows 

 
# find labels to put in the left most column
left.labels <- convertUnicode(as.character(df_ageS_forest[[1]]$Heading))

# what other columns should be plotted
other.cols  <- "n_event"

# find column headings
print.headings <- parseColHeadings(df_ageS_forest[[1]]$ColHeadings, rd=df_ageS_forest[[1]])


# Make forest plot ------------------------------------------------------------------------------------------
type <- "PNG"

SetPage(orient          = "LANDSCAPE", 
        perpage         = 1, 
        type            = type, 
        png_bg          = "white",
        filestem        = "Figure 3 Age-sex association of PA and HF (met4)", 
        page_dpi        = 600,
        page_pointsize  = 9,
        # page_height     = 14,
        page_width      = 9,
        append_datetime = FALSE, 
        suppress.date   = TRUE, 
        titlespace      = 0.05, 
        footerspace     = 0.08, 
        footer.title.allbold = FALSE,
        footer.cex      = 1.2, 
        footer    = "All analyses were stratified by study area and adjusted for income, education, occupation, smoking status, alcohol, sedentary time, COPD, emphysema, and bronchitis.\n 
The black squares and horizontal lines are the hazard ratios (HRs), 95% confidence intervals (CI), weighted average of group-specific HRs. Standard deviations (SDs) for each trait was recalculated 
for each age-sex strata. Het = Heterogeneity for sex differences
        
        \n \n"
        )

# Set page margins: format is c(bottom, left, top, right)
par(mar=c(4.14537797266251, 2, 8.14537797266251, 2))

mainfont <- 1
blankPlot(c(0,100),c(0,100), mainfont)
par(xpd=NA)

spacing    <- 1.2663
plot.width <- 15
x_label    <- "HR (95% CI) per 4 MET-hour/day usual higher \n total physical activity"

# draw the Forest plot(s)
xaxmin1 <- 25.7542
xaxmax1 <- xaxmin1 + plot.width
locs    <- ForestBasic(forest1,
                    	LogScale          = TRUE,
                    	ExponentiateDataOnPlot=TRUE,
                    	xaxmin            = xaxmin1,
                    	xaxmax            = xaxmax1, 
                    	xlim              = c(0.8, 1.2),
                    	xticks            = seq(0.8, 1.2, by = 0.2),
                    	ticklabs          = seq(0.8, 1.2, by = 0.2),
                    	xlab              = x_label,
                    	NLabel            = FALSE,
                    	mainfont          = 0.95,
                    	ValueLabels       = TRUE,
                    	ValueLabelsHeader = "HR (95% CI)",
                    	ValueDigits       = NULL,
                    	lwd               = 1,
                    	CISecond          = TRUE,
                    	separator         = " - ",
                    	spacing           = spacing/2, 
                    	pointGroupsFactor = 0.9,
                    	verbose           = FALSE,
                    	boxsizeoverride   = FALSE,
                    	boxparm.stderr    = 0.01)

# add titles above forest (may be left empty, change labels="" to what you will)
text(x      = xaxmin1 + (xaxmax1 - xaxmin1 + (spacing) )/2, 
     y      = 110, 
     labels = "A. Heart Failure", 
     adj    = c(0.5,0), 
     font   = 2, 
     cex    = 1.15
     )


# draw the Forest plot(s)
xaxmin2 <- 72.0592
xaxmax2 <- xaxmin2 + plot.width
locs2 <- ForestBasic(forest2,
                    	LogScale          = TRUE,
                    	ExponentiateDataOnPlot = TRUE,
                    	xaxmin            = xaxmin2,
                    	xaxmax            = xaxmax2,
                    	xlim              = c(0.6, 1.2),
                    	xticks            = seq(0.6, 1.2, 0.2),
                    	ticklabs          = seq(0.6, 1.2, 0.2),
                    	xlab              = x_label,
                    	NLabel            = FALSE,
                    	mainfont          = 0.95,
                    	ValueLabels       = TRUE,
                    	ValueLabelsHeader = "HR (95% CI)",
                    	ValueDigits       = NULL,
                    	lwd               = 1,
                    	CISecond          = TRUE,
                    	separator         = " - ",
                    	spacing           = spacing/2,
                    	pointGroupsFactor = 0.9,
                    	verbose           = FALSE,
                    	boxsizeoverride   = FALSE,
                    	boxparm.stderr    = 0.01)

# add titles above forest (may be left empty, change labels="" to what you will)
text(x      = xaxmin2 + (xaxmax2 - xaxmin2 + (spacing) )/2, 
     y      = 110, 
     labels = "B. Pulmonary heart disease", 
     adj    = c(0.5,0), 
     font   = 2, 
     cex    = 1.15
     )



# left hand column of labels
text(x = 0, y = 100, labels = "Age at risk, years\n", adj = c(0,0), font = 2, cex = 1)

text(x      = 0, 
     y      = locs$YLocs, 
     adj    = 0, 
     cex    = 1, 
     font   = ifelse(forest1$IsDiamond, 2,1), 
     labels = left.labels[-blank.rows]
     )

text(x      = 0, 
     y      = locs$BlankLocs, 
     adj    = 0, 
     font   = 2, 
     cex    = 1, 
     labels = left.labels[blank.rows]
     )

# adding other columns ----------------------------------------------------------------------------------------------------------------

# For HF 
column1.xpos <- xaxmin1 - 2

text(x      = column1.xpos, 
     y      = 100, 
     adj    = c(1,0), 
     font   = 2, 
     cex    = 1, 
     labels = convertUnicode("Number of\nevents")
     )

text(x      = column1.xpos, 
     y      = locs$YLocs, 
     font   = ifelse(forest1$IsDiamond, 2, 1),
     adj    = 1, 
     cex    = 1, 
     labels = convertUnicode(as.character(df_ageS_forest[[1]][,other.cols[1]]))[-blank.rows]
     )

text(x      = column1.xpos, 
     y      = locs$BlankLocs, 
     adj    = 1, 
     cex    = 1, 
     labels = convertUnicode(as.character(df_ageS_forest[[1]][,other.cols[1]]))[blank.rows]
     )

# For PHD
column2.xpos <- xaxmin2 - 2

text(x      = column2.xpos, 
     y      = 100, 
     adj    = c(1,0), 
     font   = 2, 
     cex    = 1, 
     labels = convertUnicode("Number of\nevents")
     )

text(x      = column2.xpos, 
     y      = locs$YLocs, 
     font   = ifelse(forest1$IsDiamond, 2, 1),
     adj    = 1, 
     cex    = 1, 
     labels = convertUnicode(as.character(df_ageS_forest[[2]][,other.cols[1]]))[-blank.rows]
     )

text(x      = column2.xpos, 
     y      = locs$BlankLocs, 
     adj    = 1, 
     cex    = 1, 
     labels = convertUnicode(as.character(df_ageS_forest[[2]][,other.cols[1]]))[blank.rows]
     )

##Plot title 
text(x      = 50.5, 
     y      = 119, 
     font   = 2, 
     cex    = 1.2,
     adj    = c(0.5, 0),
     labels = "Figure 3: Age-sex specific hazard ratio (95% CI) of heart failure and pulmonary heart disease per 4 MET-hr usual\n higher total physical acitivity")



# Heterogeneity labels 
x_coord <- list("hf"  = 41.3003646765421, 
                "phd" = 87.4423204683451)

# Get data for hetereogeneity---------------------------------------------------------------------------------
het_df    <- map(.x = df_ageS_forest, ~.x %>% 
                                           filter(!is.na(chi2), test_type == "heterogeneity") %>% 
                                           select(DF:p))

n_row_het <- map(.x = het_df, ~nrow(.x))

index = 1


for (H in seq_len(n_row_het[[index]]) ) {
  
  chi_DF   <- het_df[[index]]$DF[H]
  chi_val  <- round(het_df[[index]]$chi2[H], 2)
  p_value  <- het_df[[index]]$p[H]
  
  p_value  <- ifelse(p_value == "<0.0001", paste0("p", "<0.0001"), paste0("p=", round(p_value, 4)))
  
  text(x      = x_coord[[index]], 
       y      = locs$HetLocs[H], 
       adj    = 0, 
       cex    = 0.8,  
       labels = bquote(Het: ~ chi[.(chi_DF)]^2 ~ "=" ~ .(chi_val) ~ (.(p_value)))
                   
       )
  
}


# Labels for PHD 
# Heterogeneity labels for PHD

index = 2


for (H in seq_len(n_row_het[[index]]) ) {
  
  chi_DF   <- het_df[[index]]$DF[H]
  chi_val  <- round(het_df[[index]]$chi2[H], 2)
  p_value  <- het_df[[index]]$p[H]
  
  p_value   <- ifelse(p_value == "<0.0001", paste0("p", "<0.0001"), paste0("p=", round(p_value, 4)))
  
  text(x      = x_coord[[index]], 
       y      = locs$HetLocs[H], 
       adj    = 0, 
       cex    = 0.8,  
       labels = bquote(Het: ~ chi[.(chi_DF)]^2 ~ "=" ~ .(chi_val) ~ (.(p_value)))
                   
       )
  
}




# Get data for trend---------------------------------------------------------------------------------
trend_df    <- map(.x = df_ageS_forest, ~.x %>% 
                                           filter(!is.na(chi2), test_type == "trend") %>% 
                                           select(DF:p))

n_row_trend <- map(.x = trend_df, ~nrow(.x))

index = 1


for (HT in seq_len(n_row_trend[[index]]) ) {
  
  chi_DF   <- trend_df[[index]]$DF[HT]
  chi_val  <- round(trend_df[[index]]$chi2[HT], 2)
  p_value  <- trend_df[[index]]$p[HT]
  
  p_value  <- ifelse(p_value == "<0.0001", paste0("p", "<0.0001"), paste0("p=", round(p_value, 4)))
  
  text(x      = x_coord[[index]], 
       y      = locs$TrendLocs[HT], 
       adj    = 0, 
       cex    = 0.8,  
       labels = bquote(Trend: ~ chi[.(chi_DF)]^2 ~ "=" ~ .(chi_val) ~ (.(p_value)))
                   
       )
  
}


# Labels for PHD 
# Trend labels for PHD

index = 2


for (HT in seq_len(n_row_trend[[index]]) ) {
  
  chi_DF   <- trend_df[[index]]$DF[HT]
  chi_val  <- round(trend_df[[index]]$chi2[HT], 2)
  p_value  <- trend_df[[index]]$p[HT]
  
  p_value  <- ifelse(p_value <0.00010, 
                     paste0("p", "<0.0001"), 
                     paste0("p=", format(round(p_value, 4), 
                                         nsmall = 4, 
                                         scientific = FALSE)))
  
  text(x      = x_coord[[index]], 
       y      = locs$TrendLocs[HT], 
       adj    = 0, 
       cex    = 0.8,  
       labels = bquote(Trend: ~ chi[.(chi_DF)]^2 ~ "=" ~ .(chi_val) ~ (.(p_value)))
                   
       )
  
}

# stop writing to file
closeFile(type)


```



### MetSD


- Age-sex specific betas and se were adjusted for age-sex specific RDR

```{r}


# Wrangling  --------------------------------------------------------------------


prim_cov      <- "metsd_age_sex"
age_lexis_var <- "age_lexis3"
sex_var       <- "sex"

coviariates <- paste(c(age_lexis_var, sex_var, 
                       # Program interaction terms 
                       paste0(prim_cov, ":", 
                              paste0(c(age_lexis_var, sex_var), collapse = ":")
                              ), 
                       ses_vars, 
                       lifestyle_vars, 
                       "heart_rate_mean_Q4", 
                       med_history), collapse = " + "
                     )

form        <- as.formula(paste0(left_side, " ~ ", paste(coviariates, "strata(region)", sep = " + ")))


# Fit regression analysis
cox_strata <- 
  map(.x = data_expanded, 
       ~coxph(form, data = .x) %>% 
         broom::tidy(.) %>% 
         dplyr::filter(grepl(prim_cov, term)) %>% 
                arrange(term) %>% 
                select(-statistic) %>% 
        
        dplyr::mutate(term = str_replace_all(term, 
                                 pattern     = paste0(age_lexis_var, "|", sex_var, "|", ":", prim_cov), 
                                 replacement = ""
                                )
                      ) %>% 
        tidyr::separate(col = term, into = c("age", "sex"), sep = ":")
                  )


# Correct age-sex specific coefficients 
cox_strata <- 
  map(.x = cox_strata, 
      ~.x %>% 
        dplyr::group_by(age, sex) %>% 
        group_split() %>% 
        map2_dfr(.y = RDR_age_sex, 
                 ~.x %>% 
                   dplyr::mutate(estimate_c = estimate/.y, 
                                 se_c       = std.error/.y, 
                                 var        = se_c^2)
                 )
      )



# Perform heterogeneity tests
age_lex3_levels <- levels(data_expanded[[1]]$age_lexis3)

het_sex <- map(.x = cox_strata, 
               
               ~.x %>% 
                 dplyr::group_by(age) %>% 
                 dplyr::group_split() %>% 
                 
                 map_dfr( ~heterogeneity(.x$estimate_c, .x$se_c)) %>% 
                     dplyr::mutate(age       = age_lex3_levels, 
                                   test_type = "Heterogeneity")
               )


# Run IVWMA and get age-specific estimates
ivw_FE_age <- map(.x = cox_strata, 
                  
                  ~ .x %>% 
                     dplyr::group_by(age) %>% 
                            group_split()  %>% 
                            setNames(age_lex3_levels) %>% 
             
              map( ~metafor::rma(yi= estimate_c, vi= var, method = "FE", data = .x)) %>% 
  
              map( ~ tibble(beta    = .x$b[1,1],
                            se      = .x$se,
                            lci     = .x$ci.lb,
                            uci     = .x$ci.ub,
                            est_ci  = paste0(round(exp(beta), 2), " (",
                                        round(exp(lci), 2), " - ", round(exp(uci), 2), ")"
                                        )
                            )
                   ))
 

# Test trend across age-specific IV estimates 
df_ivw_age <- list()

for (i in seq_along(ivw_FE_age)) {
  
  df_ivw_age[[i]] <- map_dfr(.x = ivw_FE_age[[i]], ~rbind(.x))

}

trend_age <- map(.x = df_ivw_age,
                    ~trend(.x$beta, .x$se)) %>% 
                           map( ~tibble(DF         = .x$df, 
                                        test_stats = .x$`test statistic`, 
                                        p.trend    = .x$p) %>%  
                                  
                                  dplyr::mutate(test_type = "Trend")
                                )




cox_strata

```


### Wrangle data and make forest plot 
```{r}

source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/order_row.R")
source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/add_table_header.R")


# Wrangle main dataframe ----------------------------------------------------------------------------------------------

# Number of events by age and sex 
n_event_df <- map(.x = data_expanded, 
               ~.x %>% 
                dplyr::group_by(age_lexis3, sex) %>% 
                    summarise(n_events = sum(lex.Xst)) 
               )

cox_strata <- 
  map2(.x = cox_strata, 
       .y = seq_along(cox_strata), 
       ~.x %>% 
         select(-c(estimate:p.value)) %>% 
         dplyr::mutate(n_event = n_event_df[[.y]]$n_events) )  
  

# Format dataset to make forest plot -----------------------------------------------------------------------------------
# Add stats for trend and heterogeneity 

df_ageS_forest <- list()


for (j in seq_along(cox_strata)) {
  

  df_ageS_forest[[j]] <- 
    
      cox_strata[[j]] %>% 
          dplyr::group_by(age) %>% 
          dplyr::group_split() %>% 
          map2_dfr(.y = seq_along(.), 
                   ~.x  %>% 
                     
                     # Create new relevant columns 
                     dplyr::mutate(Het        = NA, 
                                   Trend      = NA,
                                   DF         = NA, 
                                   chi2       = NA, 
                                   p          = NA,
                                   test_type  = NA, 
                             
                                   IsDiamond  = 0, 
                                   FillColour = 1
                                   ) %>% 
                    
                     # Add a row for the IVW estimates
                     # At the end of each dataframe 
                     add_row(age        = unique(.$age), 
                             sex        = "Both", 
                             estimate_c = ivw_FE_age[[j]][[.y]]$beta, 
                             se_c       = ivw_FE_age[[j]][[.y]]$se,  
                             n_event    = sum(.x$n_event, na.rm = TRUE),
                             
                             DF         = het_sex[[j]]$df[.y], 
                             chi2       = het_sex[[j]]$`test statistic`[.y], 
                             p          = het_sex[[j]]$p[.y], 
                             
                             Het        = paste0(het_sex[[j]]$df[.y],  "," ,
                                                 format(
                                                    round(het_sex[[j]]$`test statistic`[.y], 2), 
                                                    nsmall = 2L),  "," ,
                                                  
                                                 format(round(het_sex[[j]]$p[.y], 4),nsmall = 4L)
                                                 ),
                             Trend      = NA,
                             test_type  = "heterogeneity",
                             
                             IsDiamond  = 1, 
                             FillColour = 0
                             ) 
                   ) 
    all_events <- sum(df_ageS_forest[[j]] %>% 
                        filter(sex == "Both") %>% 
                              pull(n_event), na.rm = TRUE)
    
    # Add table header
    df_ageS_forest[[j]] <- add_table_header(data             = df_ageS_forest[[j]], 
                                            group_var        = age, 
                                            group_level_var  = sex, 
                                            extra_space      = FALSE) %>% 
      
               dplyr::rename("Heading" = sex) %>% 


               add_row(Heading    = "All", 
                       estimate_c = model_cont[[j]][model_cont[[j]]$exposure == "metsd", ]$est_corrected, 
                       se_c       = model_cont[[j]][model_cont[[j]]$exposure == "metsd", ]$se_corrected,  
                       n_event    = all_events,
                       
                       DF         = trend_age[[j]]$DF, 
                       chi2       = trend_age[[j]]$test_stats, 
                       p          = trend_age[[j]]$p.trend, 
                       
                       Trend      = paste0(trend_age[[j]]$DF,  "," ,
                                           format(
                                              round(trend_age[[j]]$test_stats, 2), 
                                              nsmall = 2L),  "," ,
                                            
                                           format(round(trend_age[[j]]$p.trend, 4),nsmall = 4L)
                                           ),
                       Het        = NA,
                       
                       test_type  = "trend",
                       
                       IsDiamond  = 1, 
                       FillColour = 0) %>%  as.data.frame(.)

   
   # End of for loop
}
 

```


## Make forest plot for age-sex-specific associations

```{r}



# Format dataset --------------------------------------------------------------------------------------------------------------------

# set up an object that stores the forest and associated metadata
forest1 <- FormatForest(rawdata     = df_ageS_forest[[1]] %>% 
                                      rename("Het1"        = Het, 
                                             "Trend1"      = Trend, 
                                             "IsDiamond1"  = IsDiamond, 
                                             "FillColour1" = FillColour
                                             ), 
                        forest.n    = 1, 
                        EstimateCol = "estimate_c",  
                        StdErrCol   = "se_c",
                        logData     = FALSE, 
                        getBlanks   = TRUE, 
                        getHets     = TRUE, 
                        getTrends   = TRUE)

# set up an object that stores the forest and associated metadata
forest2 <- FormatForest(rawdata     = df_ageS_forest[[2]]%>% 
                                      rename("Het2"        = Het,  
                                             "Trend2"      = Trend, 
                                             "IsDiamond2"  = IsDiamond, 
                                             "FillColour2" = FillColour
                                             ),  
                        forest.n    = 2, 
                        EstimateCol = "estimate_c",  
                        StdErrCol   = "se_c",
                        logData     = FALSE,  
                        getBlanks   = TRUE, 
                        getHets     = TRUE, 
                        getTrends   = TRUE)

blank.rows  <- forest1$blank.rows 

 
# find labels to put in the left most column
left.labels <- convertUnicode(as.character(df_ageS_forest[[1]]$Heading))

# what other columns should be plotted
other.cols  <- "n_event"

# find column headings
print.headings <- parseColHeadings(df_ageS_forest[[1]]$ColHeadings, rd=df_ageS_forest[[1]])


# Make forest plot ---------------------------------------------------------------------------------------------------------------------
type <- "PNG"

SetPage(orient          = "LANDSCAPE", 
        perpage         = 1, 
        type            = type, 
        png_bg          = "white",
        filestem        = "Figure 4 Age-sex association of PA and HF (metsd)", 
        page_dpi        = 600,
        page_pointsize  = 9,
        # page_height     = 14,
        page_width      = 9,
        append_datetime = FALSE, 
        suppress.date   = TRUE, 
        titlespace      = 0.05, 
        footerspace     = 0.08, 
        footer.cex      = 1.2, 
        footer    = "All analyses were stratified by study area and adjusted for income, education, occupation, alcohol, smoking, sedentary time, heart rate, ephysema, bronchitis and COPD. 

Age-sex-specific logHRs were corrected for regression dilution using age-sex-specific regression dilution ratios and combined using inverse-variance-weighted fixed-effect meta-analysis
        
        \n \n"
        )

# Set page margins: format is c(bottom, left, top, right)
par(mar=c(4.14537797266251, 2, 8.14537797266251, 2))

mainfont <- 1
blankPlot(c(0,100),c(0,100), mainfont)
par(xpd=NA)

spacing    <- 1.2663
plot.width <- 15
x_label    <- "HR (95% CI) per SD usual higher \n total physical activity (MET-hour/day)"

# draw the Forest plot(s)
xaxmin1 <- 25.7542
xaxmax1 <- xaxmin1 + plot.width
locs    <- ForestBasic(forest1,
                    	LogScale          = TRUE,
                    	ExponentiateDataOnPlot=TRUE,
                    	xaxmin            = xaxmin1,
                    	xaxmax            = xaxmax1, 
                    	xlim              = c(0.4, 1.4),
                    	xticks            = c(0.4, 0.6, 1, 1.4),
                    	ticklabs          = c(0.4, 0.6, 1, 1.4),
                    	xlab              = x_label,
                    	NLabel            = FALSE,
                    	mainfont          = 0.95,
                    	ValueLabels       = TRUE,
                    	ValueLabelsHeader = "HR (95% CI)",
                    	ValueDigits       = NULL,
                    	lwd               = 1,
                    	CISecond          = TRUE,
                    	separator         = " - ",
                    	spacing           = spacing/2, 
                    	pointGroupsFactor = 0.9,
                    	verbose           = FALSE,
                    	boxsizeoverride   = FALSE,
                    	boxparm.stderr    = 0.03)

# add titles above forest (may be left empty, change labels="" to what you will)
text(x      = xaxmin1 + (xaxmax1 - xaxmin1 + (spacing) )/2, 
     y      = 110, 
     labels = "A. Heart Failure", 
     adj    = c(0.5,0), 
     font   = 2, 
     cex    = 1.15
     )


# draw the Forest plot(s)
xaxmin2 <- 72.0592
xaxmax2 <- xaxmin2 + plot.width
locs2 <- ForestBasic(forest2,
                    	LogScale          = TRUE,
                    	ExponentiateDataOnPlot = TRUE,
                    	xaxmin            = xaxmin2,
                    	xaxmax            = xaxmax2,
                    	xlim              = c(0.2, 1.4),
                    	xticks            = seq(0.2, 1.4, 0.4),
                    	ticklabs          = seq(0.2, 1.4, 0.4),
                    	xlab              = x_label,
                    	NLabel            = FALSE,
                    	mainfont          = 0.95,
                    	ValueLabels       = TRUE,
                    	ValueLabelsHeader = "HR (95% CI)",
                    	ValueDigits       = NULL,
                    	lwd               = 1,
                    	CISecond          = TRUE,
                    	separator         = " - ",
                    	spacing           = spacing/2,
                    	pointGroupsFactor = 0.9,
                    	verbose           = FALSE,
                    	boxsizeoverride   = FALSE,
                    	boxparm.stderr    = 0.03)

# add titles above forest (may be left empty, change labels="" to what you will)
text(x      = xaxmin2 + (xaxmax2 - xaxmin2 + (spacing) )/2, 
     y      = 110, 
     labels = "B. Pulmonary heart disease", 
     adj    = c(0.5,0), 
     font   = 2, 
     cex    = 1.15
     )



# left hand column of labels
text(x = 0, y = 100, labels = "Age at risk, years\n", adj = c(0,0), font = 2, cex = 1)

text(x      = 0, 
     y      = locs$YLocs, 
     adj    = 0, 
     cex    = 1, 
     font   = ifelse(forest1$IsDiamond, 2,1), 
     labels = left.labels[-blank.rows]
     )

text(x      = 0, 
     y      = locs$BlankLocs, 
     adj    = 0, 
     font   = 2, 
     cex    = 1, 
     labels = left.labels[blank.rows]
     )

# adding other columns ----------------------------------------------------------------------------------------------------------------

# For HF 
column1.xpos <- xaxmin1 - 2

text(x      = column1.xpos, 
     y      = 100, 
     adj    = c(1,0), 
     font   = 2, 
     cex    = 1, 
     labels = convertUnicode("Number of\nevents")
     )

text(x      = column1.xpos, 
     y      = locs$YLocs, 
     font   = ifelse(forest1$IsDiamond, 2, 1),
     adj    = 1, 
     cex    = 1, 
     labels = convertUnicode(as.character(df_ageS_forest[[1]][,other.cols[1]]))[-blank.rows]
     )

text(x      = column1.xpos, 
     y      = locs$BlankLocs, 
     adj    = 1, 
     cex    = 1, 
     labels = convertUnicode(as.character(df_ageS_forest[[1]][,other.cols[1]]))[blank.rows]
     )

# For PHD
column2.xpos <- xaxmin2 - 2

text(x      = column2.xpos, 
     y      = 100, 
     adj    = c(1,0), 
     font   = 2, 
     cex    = 1, 
     labels = convertUnicode("Number of\nevents")
     )

text(x      = column2.xpos, 
     y      = locs$YLocs, 
     font   = ifelse(forest1$IsDiamond, 2, 1),
     adj    = 1, 
     cex    = 1, 
     labels = convertUnicode(as.character(df_ageS_forest[[2]][,other.cols[1]]))[-blank.rows]
     )

text(x      = column2.xpos, 
     y      = locs$BlankLocs, 
     adj    = 1, 
     cex    = 1, 
     labels = convertUnicode(as.character(df_ageS_forest[[2]][,other.cols[1]]))[blank.rows]
     )

##Plot title 
text(x      = 50.5, 
     y      = 119, 
     font   = 2, 
     cex    = 1.2,
     adj    = c(0.5, 0),
     labels = "Figure 4: Age-sex specific hazard ratio (95% CI) of heart failure and pulmonary heart disease per SD usual\n higher total physical acitivity")



# Heterogeneity labels 
x_coord <- list("hf"  = 41.3003646765421, 
                "phd" = 87.4423204683451)

# Get data for hetereogeneity---------------------------------------------------------------------------------
het_df    <- map(.x = df_ageS_forest, ~.x %>% 
                                           filter(!is.na(chi2), test_type == "heterogeneity") %>% 
                                           select(DF:p))

n_row_het <- map(.x = het_df, ~nrow(.x))

index = 1


for (H in seq_len(n_row_het[[index]]) ) {
  
  chi_DF   <- het_df[[index]]$DF[H]
  chi_val  <- round(het_df[[index]]$chi2[H], 2)
  p_value  <- het_df[[index]]$p[H]
  
  p_value  <- ifelse(p_value <0.0001, paste0("p", "<0.0001"), paste0("p=", round(p_value, 4)))
  
  text(x      = x_coord[[index]], 
       y      = locs$HetLocs[H], 
       adj    = 0, 
       cex    = 0.8,  
       labels = bquote(Het: ~ chi[.(chi_DF)]^2 ~ "=" ~ .(chi_val) ~ (.(p_value)))
                   
       )
  
}


# Labels for PHD 
# Heterogeneity labels for PHD

index = 2


for (H in seq_len(n_row_het[[index]]) ) {
  
  chi_DF   <- het_df[[index]]$DF[H]
  chi_val  <- round(het_df[[index]]$chi2[H], 2)
  p_value  <- het_df[[index]]$p[H]
  
  p_value   <- ifelse(p_value == "<0.0001", paste0("p", "<0.0001"), paste0("p=", round(p_value, 4)))
  
  text(x      = x_coord[[index]], 
       y      = locs$HetLocs[H], 
       adj    = 0, 
       cex    = 0.8,  
       labels = bquote(Het: ~ chi[.(chi_DF)]^2 ~ "=" ~ .(chi_val) ~ (.(p_value)))
                   
       )
  
}




# Get data for hetereogeneity---------------------------------------------------------------------------------
trend_df    <- map(.x = df_ageS_forest, ~.x %>% 
                                           filter(!is.na(chi2), test_type == "trend") %>% 
                                           select(DF:p))

n_row_trend <- map(.x = trend_df, ~nrow(.x))

index = 1


for (HT in seq_len(n_row_trend[[index]]) ) {
  
  chi_DF   <- trend_df[[index]]$DF[HT]
  chi_val  <- round(trend_df[[index]]$chi2[HT], 2)
  p_value  <- trend_df[[index]]$p[HT]
  
  p_value  <- ifelse(p_value <0.0001, paste0("p", "<0.0001"), paste0("p=", round(p_value, 4)))
  
  text(x      = x_coord[[index]], 
       y      = locs$TrendLocs[HT], 
       adj    = 0, 
       cex    = 0.8,  
       labels = bquote(Trend: ~ chi[.(chi_DF)]^2 ~ "=" ~ .(chi_val) ~ (.(p_value)))
                   
       )
  
}


# Labels for PHD 
# Heterogeneity labels for PHD

index = 2


for (HT in seq_len(n_row_trend[[index]]) ) {
  
  chi_DF   <- trend_df[[index]]$DF[HT]
  chi_val  <- round(trend_df[[index]]$chi2[HT], 2)
  p_value  <- trend_df[[index]]$p[HT]
  
  p_value  <- ifelse(p_value <0.0001, paste0("p", "<0.0001"), paste0("p=", round(p_value, 4)))
  
  text(x      = x_coord[[index]], 
       y      = locs$TrendLocs[HT], 
       adj    = 0, 
       cex    = 0.8,  
       labels = bquote(Trend: ~ chi[.(chi_DF)]^2 ~ "=" ~ .(chi_val) ~ (.(p_value)))
                   
       )
  
}

# stop writing to file
closeFile(type)


```



# Subgroup analysis 

The following variables were used for subgroup analysis 
	* Age at risk
	* Area (Urban and rural)
	* Sex 
	* BMI 
	* Diabetes 
	* Resting HR 
	
```{r}

# Wrangling -----------------------------------------------------------------------------------------------------------------------
data_expanded <- map(.x = data_expanded, 
                     ~.x %>% dplyr::mutate(age_lexis4 = cut(age_lexis, 
                                                            breaks         = c(30, 50, 60, 70, 81), 
                                                            include.lowest = TRUE, 
                                                            right          = FALSE, 
                                                            labels         = c("30-49", "50-59", "60-69", "70+")), 
                                           
                                           diabetes   = factor(diabetes, 
                                                               levels = c("Yes", "No"))
                                           
                                           )
                     )
 
source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/trend_het_test.R")


# For RHR, BMI, and WC ----------------------------------------------------------------------------------------------------------

prim_cov        <- "met4"

subg_vars       <- list("ordinal"  = c("heart_rate_mean_Q4", "bmi_cat", "waist_circ_cm_Q4"), 
                        "nominal"  = c("sex", "region", "HTN", "diabetes", "copd")
                        )

subg_vars_lab   <- list("ordinal"  = c("Resting heart rate, bpm", "Body mass index", "Waist circumference, cm"),
                        "nominal"  = c("Sex", "Region", "Hypertension", "Diabetes", "COPD")
                        )

adjustment_vars <- c(ses_vars, lifestyle_vars, "copd", "emphysema_bronchitis") 

strata_vars <- paste0("strata(", 
                          paste(stratify, collapse = ", "), 
                          ")"
                      )
left_side     <- paste0("Surv(", "lex.dur", ", ", "lex.Xst", ")")  


# Perform subgroup analysis ------------------------------------------------------------------------------------------------------

cox_strata <- list() 

# Loop over datasets 
for (df in seq_along(data_expanded)) {
       
    subgroup_list <- list()
    irates_list   <- list()
    
    
    # Loop over ordinal variables and perform trend test -------------------------------------------------------------------------
    for (oo in seq_along(subg_vars$ordinal)){
    
      if(any(adjustment_vars == subg_vars$ordinal[oo])) {
        
        adjustment_vars_temp <- adjustment_vars[-which(adjustment_vars %in% subg_vars$ordinal[oo] )]
        
      } else {
        
        adjustment_vars_temp <- adjustment_vars
         
        }
    
      
      covariates <- paste(c(subg_vars$ordinal[oo], 
                            paste0(prim_cov, ":", subg_vars$ordinal[oo]), 
                            adjustment_vars_temp), collapse = " + "
                           )
    
      form       <- as.formula(paste0(left_side, " ~ ", paste(covariates, strata_vars, sep = " + ")))
    
         
           
         
      subgroup_list[[oo]]  <- coxph(form, data = data_expanded[[df]]) %>% 
        
           broom::tidy(.) %>% 
           dplyr::filter(grepl(prim_cov, term)) %>% 
                  # arrange(term) %>% 
                  select(-statistic) %>% 
           dplyr::mutate(est_corrected  = estimate/RDR, 
                         se_corrected   = std.error/RDR,
                         hr_corrected   = exp(estimate),
                         
                         term           = str_replace_all(term, 
                                                          pattern     = paste0(subg_vars$ordinal[oo], "|:", prim_cov), 
                                                          replacement = ""
                                                        ), 
                         
                         exposure       = subg_vars_lab$ordinal[oo]
                         )
      
      
      # Perform trend test and create a dataframe 
      trend_list  <- trend(subgroup_list[[oo]]$est_corrected, subgroup_list[[oo]]$se_corrected)
      nrow_temp   <- nrow(subgroup_list[[oo]])
      
      trend_df    <- data.frame(DF        = c(rep(NA, nrow_temp-1), trend_list[[1]]), 
                                Chi2      = c(rep(NA, nrow_temp-1), trend_list[[2]]), 
                                p_int     = c(rep(NA, nrow_temp-1), trend_list[[3]]), 
                                test_type = "trend"
                                )
      
      # Get number of events  
      events_temp <- data_expanded[[df]] %>% 
                         dplyr::group_by(.data[[ subg_vars$ordinal[oo] ]] ) %>% 
                                summarise(n_event = sum(lex.Xst)) %>% select(n_event)
      
      # Bind trend test DF to main Subgroup DF
      subgroup_list[[oo]] <- cbind(subgroup_list[[oo]], trend_df, events_temp)
      
      
      # END OF ORDINAL VARS LOOP
      
    }
    
    
 
    # Loop over norminal covariates and perform heterogeneity test ------------------------------------------------------------
    for (nn in seq_along(subg_vars$nominal)){
    
        
        if(any(adjustment_vars == subg_vars$nominal[nn]) ) {
        
        adjustment_vars_temp <- adjustment_vars[-which( adjustment_vars %in% subg_vars$nominal[nn] )]
        
        } else {
        
        adjustment_vars_temp <- adjustment_vars
        
        }
        
        
        
        if(any(stratify == subg_vars$nominal[nn])) {
          
        stratify_temp <- stratify[-which(stratify %in% subg_vars$nominal[nn])]
        strata_vars   <- paste0("strata(", 
                                 paste(stratify_temp, collapse = ", "), 
                                ")"
                              )     
          
        } else{
          
        strata_vars   <- paste0("strata(", 
                                 paste(stratify, collapse = ", "), 
                                ")"
                               )  
          
        }
    
      
        
      covariates <- paste(c(subg_vars$nominal[nn], 
                            paste0(prim_cov, ":", subg_vars$nominal[nn]), 
                            adjustment_vars_temp), collapse = " + "
                           )
    
      form       <- as.formula(paste0(left_side, " ~ ", paste(covariates, strata_vars, sep = " + ")))
    
         
           
         
      subgroup_list[[oo + nn]]  <- coxph(form, data = data_expanded[[df]]) %>% 
        
           broom::tidy(.) %>% 
           dplyr::filter(grepl(prim_cov, term)) %>% 
                  # arrange(term) %>% 
                  select(-statistic) %>% 
           dplyr::mutate(est_corrected  = estimate/RDR, 
                         se_corrected   = std.error/RDR,
                         hr_corrected   = exp(estimate),
                         
                         term           = str_replace_all(term, 
                                                          pattern     = paste0(subg_vars$nominal[nn], "|:", prim_cov), 
                                                          replacement = ""
                                                        ), 
                         
                         exposure       = subg_vars_lab$nominal[nn]
                         )
      
      
      # Perform trend test and create a dataframe 
      het_list    <- heterogeneity(subgroup_list[[oo + nn]]$est_corrected, subgroup_list[[oo + nn]]$se_corrected)
      nrow_temp   <- nrow(subgroup_list[[oo + nn]])
      
      het_df      <- data.frame(DF        = c(rep(NA, nrow_temp-1), het_list[[1]]), 
                                Chi2      = c(rep(NA, nrow_temp-1), het_list[[2]]), 
                                p_int     = c(rep(NA, nrow_temp-1), het_list[[3]]), 
                                test_type = "heterogeneity"
                                )
      
      
      # Get number of events  
      events_temp <- data_expanded[[df]] %>% 
                         dplyr::group_by(.data[[ subg_vars$nominal[nn] ]] ) %>% 
                                summarise(n_event = sum(lex.Xst)) %>% select(n_event)
      
      # Bind trend test DF to main Subgroup DF
      subgroup_list[[oo + nn]] <- cbind(subgroup_list[[oo + nn]], het_df,  events_temp)
      
                        
    }
  
  
    cox_strata[[df]] <- subgroup_list

} 

```


## Run subgroup analysis for age at risk, region and area (urban/rural)

```{r}

cox_strata_age_area <- list()
cox_strata2         <- list()
subg_vars2          <- c("age_lexis3", "area", "region")     
subg_vars2_labs     <- c("Age at risk, years", "Area", "Region")

# Loop over datasets
for (df in seq_along(data_expanded)) {

  
    # Perform subgroup analysis for age at risk --------------------------------------------------------------------------------
      stratify_temp <- c("sex", "region")
      
      strata_vars   <- paste0("strata(", 
                                 paste(stratify_temp, collapse = ", "), 
                                ")"
                              )    
        
      covariates <- paste(c(subg_vars2[1], 
                            paste0(prim_cov, ":", subg_vars2[1]), 
                            adjustment_vars), collapse = " + "
                           )
    
      form       <- as.formula(paste0(left_side, " ~ ", paste(covariates, strata_vars, sep = " + ")))
    
         
      cox_strata_age_area[[1]]  <- coxph(form, data = data_expanded[[df]]) %>% 
        
           broom::tidy(.) %>% 
           dplyr::filter(grepl(prim_cov, term)) %>% 
                  # arrange(term) %>% 
                  select(-statistic) %>% 
           dplyr::mutate(est_corrected  = estimate/RDR, 
                         se_corrected   = std.error/RDR,
                         hr_corrected   = exp(estimate),
                         
                         term           = str_replace_all(term, 
                                                          pattern     = paste0(subg_vars2[1], "|:", prim_cov), 
                                                          replacement = ""
                                                        ), 
                         
                         exposure       = subg_vars2_labs[1]
                         )
      
      
      # Perform trend test and create a dataframe 
      trend_list  <- trend(cox_strata_age_area[[1]]$est_corrected, cox_strata_age_area[[1]]$se_corrected)
      nrow_temp   <- nrow(cox_strata_age_area[[1]])
      
      trend_df    <- data.frame(DF        = c(rep(NA, nrow_temp-1), trend_list[[1]]), 
                                Chi2      = c(rep(NA, nrow_temp-1), trend_list[[2]]), 
                                p_int     = c(rep(NA, nrow_temp-1), trend_list[[3]]), 
                                test_type = "trend"
                                )
      
      # Get number of events  
      events_temp <- data_expanded[[df]] %>% 
                         dplyr::group_by(.data[[ subg_vars2[1] ]] ) %>% 
                                summarise(n_event = sum(lex.Xst)) %>% select(n_event)
      
      # Bind trend test DF to main Subgroup DF
      cox_strata_age_area[[1]] <- cbind(cox_strata_age_area[[1]], trend_df, events_temp)
  
      
   # Perform subgroup analysis for area and region ---------------------------------------------------------------------------------
 region_vars        <- subg_vars2[-1]
 region_vars_labs <- subg_vars2_labs[-1]
      
      
    for (r in seq_along(region_vars)) {
      
      
      stratify_temp <- c("age_lexis5", "sex")
      
      strata_vars   <- paste0("strata(", 
                                 paste(stratify_temp, collapse = ", "), 
                                ")"
                              )    
        
      covariates <- paste(c(region_vars[r], 
                            paste0(prim_cov, ":", region_vars[r]), 
                            adjustment_vars), collapse = " + "
                           )
    
      form       <- as.formula(paste0(left_side, " ~ ", paste(covariates, strata_vars, sep = " + ")))
    
      # Do not overwrite data for age   
      cox_strata_age_area[[r + 1]]  <- coxph(form, data = data_expanded[[df]]) %>% 
        
           broom::tidy(.) %>% 
           dplyr::filter(grepl(prim_cov, term)) %>% 
                  # arrange(term) %>% 
                  select(-statistic) %>% 
           dplyr::mutate(est_corrected  = estimate/RDR, 
                         se_corrected   = std.error/RDR,
                         hr_corrected   = exp(estimate),
                         
                         term           = str_replace_all(term, 
                                                          pattern     = paste0(region_vars[r], "|:", prim_cov), 
                                                          replacement = ""
                                                        ), 
                         
                         exposure       = region_vars_labs[r]
                         )
      
      
      # Perform trend test and create a dataframe 
      het_list    <- heterogeneity(cox_strata_age_area[[r+1]]$est_corrected, cox_strata_age_area[[r+1]]$se_corrected)
      nrow_temp   <- nrow(cox_strata_age_area[[r+1]])
      
      het_df      <- data.frame(DF        = c(rep(NA, nrow_temp-1), het_list[[1]]), 
                                Chi2      = c(rep(NA, nrow_temp-1), het_list[[2]]), 
                                p_int     = c(rep(NA, nrow_temp-1), het_list[[3]]), 
                                test_type = "heterogeneity"
                                )
      
      # Get number of events  
      events_temp <- data_expanded[[df]] %>% 
                         dplyr::group_by(.data[[ region_vars[r] ]] ) %>% 
                                summarise(n_event = sum(lex.Xst)) %>% select(n_event)
      
      # Bind trend test DF to main Subgroup DF
      cox_strata_age_area[[r+1]] <- cbind(cox_strata_age_area[[r+1]], het_df, events_temp)
      
     }    

      # Capture lists
      cox_strata2[[df]] <- cox_strata_age_area
    
     
}


# Bind all dataset and format the for plotting 
# Format headings to make forest plot with Jasper.

```

## Combine and reorder lists 

The function `order_row` order the values of a column based on some order indicated by the user 
`add_table_header`: Add header to rows for reporting as table or forestplot. Use data masking from dplyr 

Obtain a dataframe for DF, Chi2, and p values which will needed for forest plot 

```{r}


source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/order_row.R")
source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/add_table_header.R")


expo_name_order <- c("Age at risk, years", "Sex", "Area", 
                     "Resting heart rate, bpm", "Body mass index", "Waist circumference, cm", 
                     "Hypertension", "Diabetes", "COPD"
                     )


subgroup_df <- list()
chi_p_df    <- list()   


for (s in seq_along(cox_strata2)) {
  
  subgroup_df[[s]] <- 
    
    map_dfr(.x = c(cox_strata2[[s]], cox_strata[[s]]), 
                              
            ~rbind(.x)) %>% 
                  filter(exposure != "Region") %>% 
                  select(exposure, 
                         term, 
                         n_event, 
                         est_corrected, 
                         se_corrected, 
                         DF:test_type
                         ) %>% 
    
             dplyr::mutate(Chi2  = round(Chi2, 2), 
                           p_val = case_when(p_int <0.0001 ~ "<0.0001", 
                                             p_int >=0.0001 ~ format(round(p_int, 4)), 
                                             TRUE  ~ NA_character_
                                             ),
                           
                           n_event = prettyNum(n_event, big.mark = ",", scientific = FALSE),
                           
                           Het   = ifelse(!is.na(DF) & test_type == "heterogeneity", 
                                              paste(DF, Chi2, p_val, sep = ","), NA),
                           
                           Trend = ifelse(!is.na(DF) & test_type == "trend", 
                                              paste(DF, Chi2, p_val, sep = ","), NA), 
                           
                           IsDiamond  = 0, 
                           FillColour = 1 
                           ) %>% 
    
                   select(-p_int)
  
  # Order rows for forest plot 
  
  subgroup_df[[s]] <- order_row(data = subgroup_df[[s]], 
                                new_col_order = expo_name_order, 
                                old_col_name = "exposure")    
  
  # Extract DF, Chi2, and p-values 
  chi_p_df[[s]] <- subgroup_df[[s]] %>% 
                               filter(!is.na(DF)) %>% 
                               select(exposure, DF:test_type, p_val) %>% 
                               dplyr::mutate(test_type = str_to_title(test_type))

  # Add a column header 
  
  
  subgroup_df[[s]] <- add_table_header(data             = subgroup_df[[s]], 
                                       group_var        = exposure, 
                                       group_level_var  = term, 
                                       extra_space      = TRUE
                                      ) 
    
}
 
# Get summary results for main effect analysis ----------------------------------------------------------------------------------
main_effect <- 
  map2(.x = model_cont,
       .y = seq_along(model_cont), 
       ~.x %>% 
           filter(exposure == "met4") %>% 
           transmute(exposure      = "Overall", 
                     n_event       = prettyNum(sum(data_expanded[[.y]]$lex.Xst), 
                                               big.mark   = ",", 
                                               scientific = FALSE
                                               ), 
                     
                     est_corrected = est_corrected, 
                     se_corrected  = se_corrected, 
                     DF            = NA, 
                     Chi2          = NA, 
                     test_type     = NA, 
                     p_val         = NA, 
                     Het           = NA, 
                     Trend         = NA, 
                     IsDiamond     = 1, 
                     FillColour    = 0
                     ) %>% 
            add_row(.before = 1) %>% 
            rename("term" = exposure)
                                          
       )


# Bind overall estimate to subgroup estimates -----------------------------------------------------------------------------------

subgroup_forest <- map2(.x = subgroup_df, 
                        .y = main_effect, ~rbind(.x, .y) %>% 
                                           select(term:se_corrected, Het:FillColour) %>%
                          
                                    dplyr::mutate(lci = est_corrected - 1.96*se_corrected, 
                                                  uci = est_corrected - 1.96*se_corrected
                                                  ) %>% 
                          
                                           rename("Heading" = term) %>%
                                           as.data.frame(.)
                        ) 


```

## Make forest plot for subgroup analysis 

```{r}


# Get labels for number of cases and overall sample size 
# n_label <- map(.x = data_expanded, ~paste0(prettyNum(sum(.x$lex.Xst), 
#                                                          big.mark   = ",", 
#                                                          scientific = FALSE),  # get and format total number of events
#                                            
#                                                " cases/", 
#                                            
#                                                prettyNum(nrow(merged_data), 
#                                                          big.mark   = ",", 
#                                                          scientific = FALSE)
#                                                )
#                ) 

# get and format total number of events

n_label <- 
  
  map(
    
    .x = data_expanded, 
    ~paste0(
      
      "(n=", prettyNum(sum(.x$lex.Xst), 
                       big.mark   = ",", 
                       scientific = FALSE), 
         
          ")"
                                           
            )

    )

# Format dataset --------------------------------------------------------------------------------------------------------------------

# set up an object that stores the forest and associated metadata
forest1 <- FormatForest(rawdata     = subgroup_forest[[1]] %>% 
                                      rename("Het1"        = Het, 
                                             "Trend1"      = Trend, 
                                             "IsDiamond1"  = IsDiamond, 
                                             "FillColour1" = FillColour
                                             ), 
                        forest.n    = 1, 
                        EstimateCol = "est_corrected",  
                        StdErrCol   = "se_corrected",
                        LCICol      = "lci", 
                        UCICol      = "uci",
                        logData     = FALSE, 
                        getBlanks   = TRUE, 
                        getHets     = TRUE,  
                        getTrends   = TRUE)

# set up an object that stores the forest and associated metadata
forest2 <- FormatForest(rawdata     = subgroup_forest[[2]]%>% 
                                      rename("Het2"        = Het, 
                                             "Trend2"      = Trend, 
                                             "IsDiamond2"  = IsDiamond, 
                                             "FillColour2" = FillColour
                                             ),  
                        forest.n    = 2, 
                        EstimateCol = "est_corrected",  
                        StdErrCol   = "se_corrected",
                        LCICol      = "lci", 
                        UCICol      = "uci",
                        logData     = FALSE,  
                        getBlanks   = TRUE, 
                        getHets     = TRUE, 
                        getTrends   = TRUE)

blank.rows  <- forest1$blank.rows 

# Format headings to incorporate expressions -------------------------------------------------------------------------------------

# find labels to put in the left most column
left.labels <- convertUnicode(as.character(subgroup_forest[[1]]$Heading))


# Get position of heading for non-blank rows
# Get position of headings to manually edit (in this case BMI)
# Replace the heading with a blank

lab_no_blanks <- left.labels[which(!is.na(left.labels))]
pos_bmi_no_blank <- which(lab_no_blanks == "Body mass index")

pos_bmi <- which(left.labels == "Body mass index")
left.labels[pos_bmi] <- ""

# 
# # Replace BMI heading t
# # Notice main headings appear immediately after NAs
# ## Get NA positions to get variable heading positions
# pos_NA <- which(is.na(left.labels))
# pos_main_head <- pos_NA+1
# pos_bmi <- which(left.labels == "Body mass index") # Get position of the headings to edit. In this case, BMI
# 
# # Get and format main headings 
# main_headings <- left.labels[pos_main_head]
# 
# bold_head_expr <- expression(main_headings) #Expression of bold headings
# 
# # Replace NAs with empty quotes
# left.labels <- ifelse(is.na(left.labels), "", left.labels) 
# 
# # Replace expressions of bold main headings
# left.labels[pos_main_head] <- bold_head_expr


# left.labels[pos_bmi] <- expression(bold(paste("Body mass index (kg/", m^2,")")))


# what other columns should be plotted
other.cols  <- "n_event"

# find column headings
print.headings <- parseColHeadings(subgroup_forest[[1]]$ColHeadings, rd=subgroup_forest[[1]])


# Make forest plot ---------------------------------------------------------------------------------------------------------------------
type <- "JPG"

SetPage(orient          = "PORTRAIT", 
        perpage         = 1, 
        type            = type, 
        filestem        = "Figure 4 Subgroup_analysis PA and HF", 
        page_dpi        = 600,
        page_pointsize  = 10,
        page_height     = 14,
        page_width      = 12,
        append_datetime = FALSE, 
        suppress.date   = TRUE, 
        titlespace      = 0.05, 
        footerspace     = 0.05, 
        footer.cex      = 1.5, 
        footer    = "Analyses were stratified by study area and adjusted for income, education, occupation, alcohol, smoking, sedentary time, ephysema, bronchitis and COPD. 

Het = Heterogeneity
        
        \n \n" 
        )

# Set page margins: format is c(bottom, left, top, right)
par(mar=c(4.14537797266251, 2, 8.14537797266251, 2))

mainfont <- 1.25006
blankPlot(c(0,100),c(0,100), mainfont)
par(xpd=NA)

spacing    <- 1.2663
plot.width <- 13
x_label    <- "HR (95% CI) per 4 MET-hour/day higher\nusual total physical activity"

# draw the Forest plot(s)
xaxmin1 <- 25.2542
xaxmax1 <- xaxmin1 + plot.width
locs    <- ForestBasic(forest1,
                    	LogScale          = TRUE,
                    	ExponentiateDataOnPlot=TRUE,
                    	xaxmin            = xaxmin1,
                    	xaxmax            = xaxmax1, 
                    	xlim              = c(0.7, 1.1),
                    	xticks            = c(0.7, 0.8, 0.9, 1.0, 1.1),
                    	ticklabs          = c(0.7, 0.8, 0.9, 1.0, 1.1),
                    	xlab              = x_label,
                    	NLabel            = FALSE,
                    	mainfont          = 0.95,
                    	ValueLabels       = TRUE,
                    	ValueLabelsHeader = "HR (95% CI)",
                    	ValueDigits       = NULL,
                    	lwd               = 1,
                    	CISecond          = TRUE,
                    	separator         = " - ",
                    	spacing           = spacing/2, 
                    	pointGroupsFactor = 0.9,
                    	verbose           = FALSE,
                    	boxsizeoverride   = FALSE,
                    	boxparm.stderr    = 0.01)

# add titles above forest (may be left empty, change labels="" to what you will)
text(x      = xaxmin1 + (xaxmax1 - xaxmin1 + (spacing) )/2, 
     y      = 110, 
     labels = "A. Heart Failure", 
     adj    = c(0.5,0), 
     font   = 2, 
     cex    = 1.15
     )

text(x      = xaxmin1 + (xaxmax1 - xaxmin1 + (spacing) )/2, 
     y      = 107, 
     labels = n_label[[1]], 
     adj    = c(0.5,0), 
     font   = 1, 
     cex    = 1
     )


# draw the Forest plot(s)
xaxmin2 <- 69.0592
xaxmax2 <- xaxmin2 + plot.width
locs2 <- ForestBasic(forest2,
                    	LogScale          = TRUE,
                    	ExponentiateDataOnPlot = TRUE,
                    	xaxmin            = xaxmin2,
                    	xaxmax            = xaxmax2,
                    	xlim              = c(0.6, 1.1),
                    	xticks            = c(0.6, 0.8, 1, 1.1),
                    	ticklabs          = c(0.6, 0.8, 1, 1.1),
                    	xlab              = x_label,
                    	NLabel            = FALSE,
                    	mainfont          = 0.95,
                    	ValueLabels       = TRUE,
                    	ValueLabelsHeader = "HR (95% CI)",
                    	ValueDigits       = NULL,
                    	lwd               = 1,
                    	CISecond          = TRUE,
                    	separator         = " - ",
                    	spacing           = spacing/2,
                    	pointGroupsFactor = 0.9,
                    	verbose           = FALSE,
                    	boxsizeoverride   = FALSE,
                    	boxparm.stderr    = 0.01)

# add titles above forest (may be left empty, change labels="" to what you will)
text(x      = xaxmin2 + (xaxmax2 - xaxmin2 + (spacing) )/2, 
     y      = 110, 
     labels = "B. Pulmonary heart disease", 
     adj    = c(0.5,0), 
     font   = 2, 
     cex    = 1.15
     )

text(x      = xaxmin2 + (xaxmax2 - xaxmin2 + (spacing) )/2, 
     y      = 107, 
     labels = n_label[[2]], 
     adj    = c(0.5,0), 
     font   = 1, 
     cex    = 1
     )



# left hand column of labels
text(x = 0, y = 100, labels = "Subgroups", adj = c(0,0), font = 2, cex = 1)

text(x      = 0, 
     y      = locs$YLocs, 
     adj    = 0, 
     cex    = 1, 
     font   = ifelse(forest1$IsDiamond, 2,1), 
     labels = left.labels[-blank.rows]
     )

text(x      = 0, 
     y      = locs$BlankLocs, 
     adj    = 0, 
     font   = 2, 
     cex    = 1, 
     labels = left.labels[blank.rows]
     )

# Add BMI heading 

text(x      = 0, 
     y      = locs$YLocs[pos_bmi_no_blank-5] - 5, #y position of BMI heading
     adj    = 0, 
     font   = 2, 
     cex    = 1, 
     labels = expression(bold(paste("Body mass index, kg/", m^2)))
     )


# adding other columns ----------------------------------------------------------------------------------------------------------------

# For HF 
column1.xpos <- xaxmin1 - 2

text(x      = column1.xpos, 
     y      = 100, 
     adj    = c(1,0), 
     font   = 2, 
     cex    = 1, 
     labels = convertUnicode("Number of\nevents")
     )

text(x      = column1.xpos, 
     y      = locs$YLocs, 
     font   = ifelse(forest1$IsDiamond, 2, 1),
     adj    = 1, 
     cex    = 1, 
     labels = convertUnicode(as.character(subgroup_forest[[1]][,other.cols[1]]))[-blank.rows]
     )

text(x      = column1.xpos, 
     y      = locs$BlankLocs, 
     adj    = 1, 
     cex    = 1, 
     labels = convertUnicode(as.character(subgroup_forest[[1]][,other.cols[1]]))[blank.rows]
     )

# For PHD
column2.xpos <- xaxmin2 - 2

text(x      = column2.xpos, 
     y      = 100, 
     adj    = c(1,0), 
     font   = 2, 
     cex    = 1, 
     labels = convertUnicode("Number of\nevents")
     )

text(x      = column2.xpos, 
     y      = locs$YLocs, 
     font   = ifelse(forest1$IsDiamond, 2, 1),
     adj    = 1, 
     cex    = 1, 
     labels = convertUnicode(as.character(subgroup_forest[[2]][,other.cols[1]]))[-blank.rows]
     )

text(x      = column2.xpos, 
     y      = locs$BlankLocs, 
     adj    = 1, 
     cex    = 1, 
     labels = convertUnicode(as.character(subgroup_forest[[2]][,other.cols[1]]))[blank.rows]
     )

##Plot title 
text(x      = 50.5, 
     y      = 115, 
     font   = 2, 
     cex    = 1.25,
     adj    = c(0.5, 0),
     labels = "Figure 4: Hazard ratio (95% CI) of heart failure and pulmonary heart disease per 4 MET-hr/day\n higher usual total physical acitivity by subgroup")

# Heterogeneity labels 
x_coord <- list("hf"  = 39.1003646765421, 
                "phd" = 83.0423204683451)

# Number of trend and het tests 
n_trend_test   <- map(.x = chi_p_df, ~nrow(.x %>%filter(test_type == "Trend")))
n_het_test     <- map(.x = chi_p_df, ~nrow(.x %>%filter(test_type == "Heterogeneity")))

index = 1
# Labels for HF --------------------------------------------------------------------------------------------------------------------------------
# Heterogeneity labels for HF

for (H in seq_len(n_het_test[[index]]) ) {
  
  chi_index <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Heterogeneity", ]$DF[H]
  chi_val   <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Heterogeneity", ]$Chi2[H]
  p_value   <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Heterogeneity", ]$p_val[H]
  
  p_value   <- ifelse(p_value == "<0.0001", paste0("p", "<0.0001"), paste0("p=", p_value))
  
  text(x      = x_coord[[index]], 
       y      = locs$HetLocs[H], 
       adj    = 0, 
       cex    = 0.8,  
       labels = bquote(Het: ~ chi[.(chi_index)]^2 ~ "=" ~ .(chi_val) ~ (.(p_value)))
                   
       )
  
}

# Trend labels for HF

for (TT in seq_len(n_trend_test[[index]]) ) {
  
  chi_index <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Trend", ]$DF[TT]
  chi_val   <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Trend", ]$Chi2[TT]
  p_value   <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Trend", ]$p_val[TT]
  
  p_value   <- ifelse(p_value == "<0.0001", paste0("p", "<0.0001"), paste0("p=", p_value))
  
  text(x      = x_coord[[index]], 
       y      = locs$TrendLocs[TT], 
       adj    = 0, 
       cex    = 0.8,   
       labels = bquote(Trend: ~ chi[.(chi_index)]^2 ~ "=" ~ .(chi_val) ~ (.(p_value)))
                   
       )
  
}

# Labels for PHD --------------------------------------------------------------------------------------------------------------------------------
# Heterogeneity labels for PHD

index = 2

for (H in seq_len(n_het_test[[index]]) ) {
  
  chi_index <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Heterogeneity", ]$DF[H]
  chi_val   <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Heterogeneity", ]$Chi2[H]
  p_value   <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Heterogeneity", ]$p_val[H]
  
  p_value   <- ifelse(p_value == "<0.0001", paste0("p", "<0.0001"), paste0("p=", p_value))
  
  text(x      = x_coord[[index]], 
       y      = locs$HetLocs[H], 
       adj    = 0, 
       cex    = 0.8,  
       labels = bquote(Het: ~ chi[.(chi_index)]^2 ~ "=" ~ .(chi_val) ~ (.(p_value)))
                   
       )
  
}

# Trend labels for HF

for (TT in seq_len(n_trend_test[[index]]) ) {
  
  chi_index <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Trend", ]$DF[TT]
  chi_val   <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Trend", ]$Chi2[TT]
  p_value   <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Trend", ]$p_val[TT]
  
  p_value   <- ifelse(p_value == "<0.0001", paste0("p", "<0.0001"), paste0("p=", p_value))
  
  text(x      = x_coord[[index]], 
       y      = locs$TrendLocs[TT], 
       adj    = 0, 
       cex    = 0.8,  
       labels = bquote(Trend: ~ chi[.(chi_index)]^2 ~ "=" ~ .(chi_val) ~ (.(p_value)))
                   
       )
  
}

# stop writing to file
closeFile(type)



```


### Perform analysis by region
Combine regional HRs using fixed effect meta-analysis

1. Calculate region and area-specific HRs (Adjusting for age and sex)
2. Run analysis and correct Log HRs as appropriate


```{r}

# Three categories for age at risk 

resurv_merged_df <- 
  resurv_merged_df %>% 
  dplyr::mutate(age3 =  cut(age, 
                            breaks         = c(30, 60, 70, 81), 
                            include.lowest = TRUE, 
                            right          = FALSE, 
                            labels         = c("30-59", "60-69", "70+")))


# Region ----------------------------------------------------------------------------------------------------------------
region_names <-
      levels(resurv_merged_df$region)

urban_area    <- 
  resurv_merged_df %>% 
       filter(area == "Urban") %>% 
       pull(region) %>% 
       as.character(.) %>% 
       unique(.)


RDR_region_df <- 
  resurv_merged_df %>%
  dplyr::group_by(region) %>% 
  dplyr::group_split() %>% 
  map2(
    
    .y = region_names,
     ~lm(formula = met ~ met_resurv_ave + age3 + sex, data = .x) %>% 
      broom::tidy(.) %>% 
      filter(term == "met_resurv_ave") %>% 
      select(estimate, std.error) %>% 
      dplyr::mutate(
        
        region  = .y,
        area    = factor(case_when(region %in% urban_area ~ "Urban", 
                            TRUE ~ "Rural"), 
                         
                         levels = c("Urban", "Rural")),
        lci     = estimate - 1.96*std.error, 
        uci     = estimate + 1.96*std.error, 
        beta_ci = paste0(format(round(estimate, 2), nsmall = 2L), " (", 
                         format(round(lci, 2), nsmall = 2L), " - ", 
                         format(round(uci, 2), nsmall = 2L), ")")
                    
        )
        
      )%>% 
  
  setNames(region_names)
  
#Get RDR values
RDR_region <- map(.x = RDR_region_df, ~.x$estimate)


# Make table for reporting 
df_region_rdr <- 
  
resurv_merged_df %>% 
  
  # Calculate stratum-specific mean met
  dplyr::group_by(region) %>% 
  dplyr::summarise(mean_met_baseline = mean(met, na.rm = TRUE), 
                   mean_met_resurvey = mean(met_resurv_ave, na.rm = TRUE)
                   ) %>% 
  ungroup() %>% 
  dplyr::mutate(RDR        = map_chr(.x = RDR_region_df, ~.x$beta_ci), 
                area       = factor(case_when(region %in% urban_area ~ "Urban", 
                                          TRUE ~ "Rural"), 
                                       
                                       levels = c("Urban", "Rural"))
                )


# Area ---------------------------------------------------------------------------------------------------------------
area_names <-
      levels(resurv_merged_df$area)


RDR_area_df <- 
  resurv_merged_df %>%
  dplyr::group_by(area) %>% 
  dplyr::group_split() %>% 
  map2(
    
    .y = area_names,
     ~lm(formula = met ~ met_resurv_ave + age3 + sex, data = .x) %>% 
      broom::tidy(.) %>% 
      filter(term == "met_resurv_ave") %>% 
      select(estimate, std.error) %>% 
      dplyr::mutate(
        
        area    = .y, 
        lci     = estimate - 1.96*std.error, 
        uci     = estimate + 1.96*std.error, 
        beta_ci = paste0(format(round(estimate, 2), nsmall = 2L), " (", 
                         format(round(lci, 2), nsmall = 2L), " - ", 
                         format(round(uci, 2), nsmall = 2L), ")")
                    
        )
        
      )%>% 
  
  setNames(area_names)
  
#Get RDR values
RDR_area <- map(.x = RDR_area_df, ~.x$estimate)


# Make table for reporting 
df_area_rdr <- 
  
resurv_merged_df %>% 
  
  # Calculate stratum-specific mean met
  dplyr::group_by(area) %>% 
  dplyr::summarise(mean_met_baseline = mean(met, na.rm = TRUE), 
                   mean_met_resurvey = mean(met_resurv_ave, na.rm = TRUE)
                   ) %>% 
  ungroup() %>% 
  dplyr::mutate(RDR    = map_chr(.x = RDR_area_df, ~.x$beta_ci), 
                region = NA)


n_region <- 
    
  resurv_merged_df %>% 
    drop_na(met_resurv_ave) %>% 
    group_by(region) %>%
    summarise(n = n()) %>% 
    dplyr::mutate(region = as.character(region))


# Bind region and area datasets for reporting 

RDR_area_region <- 
  
  map2_dfr(
    
    .x = df_region_rdr %>% split(f = .$area), 
    .y = df_area_rdr %>% split(f = .$area), 
                        
    ~rbind(.y, .x)
    
) %>% 
  
    left_join(., n_region, by = "region") %>% 
    dplyr::mutate(
      
      area = as.character(area),
      area = ifelse(!is.na(region), "", area), 
      mean_met_baseline = format(round(mean_met_baseline, 2), nsmall = 2), 
      mean_met_resurvey = format(round(mean_met_resurvey, 2), nsmall = 2)
      
     )


# write.csv(RDR_area_region, file = "Region-specific RDR.csv")


```


## Perform region-specific analysis 

```{r}

    
 # Perform subgroup analysis for area and region ----------------------------------------------------------------
 region_var        <- "region"
 region_vars_lab   <- "Region"
      

  stratify_temp <- c("age_lexis5", "sex")
  
  strata_vars   <- paste0("strata(", 
                             paste(stratify_temp, collapse = ", "), 
                            ")"
                          )    
    
  covariates <- paste(c("region", 
                        paste0(prim_cov, ":", region_var), 
                        adjustment_vars), collapse = " + "
                       )

  form       <- as.formula(paste0(left_side, " ~ ", paste(covariates, strata_vars, sep = " + ")))

  
  # Fit regression across region  ------------------------------------------------------------------------------
  
  cox_region  <- 
    
    map(.x = data_expanded, 
        
        ~coxph(form, data = .x %>% select(all_of(c(prim_cov, 
                                                   region_var, 
                                                   stratify_temp, 
                                                   adjustment_vars, 
                                                   "lex.dur", 
                                                   "lex.Xst"
                                                   )
                                                 )
                                          )) %>% 
    
       broom::tidy(.) %>% 
       dplyr::filter(grepl(prim_cov, term)) %>% 
              # arrange(term) %>% 
              select(-statistic) %>% 
       dplyr::mutate(
         
         term = str_replace_all(
           
                  term, 
                  pattern     = paste0(region_var, "|:", prim_cov), 
                  replacement = ""
                                
                  ), 
         # Convert term to factor to avoid unwanted results
         term = factor(term, levels = region_names),
         
         exposure = region_vars_lab
                     
         ) %>% 
         
         dplyr::group_by(term) %>%
         dplyr::group_split() %>% 
         
         # Correct estimates for regression dilution 
         
         map2_dfr(
           
           .y = RDR_region, 
            ~.x %>% 
            dplyr::mutate(
              
              est_corrected  = estimate/.y, 
              se_corrected   = std.error/.y,
              hr_corrected   = exp(est_corrected)
                          
              )
                  
           ) %>% 
         dplyr::mutate(
           
             area       = ifelse(term %in% urban_area, "Urban", "Rural"), 
             IsDiamond  = 0, 
             FillColour = 1
             
             )
    )
   
   
  
     ## Get number of events -----------------------------------------------------------------------------------------------
     event_region <- 
       
         map(.x = data_expanded, 
                         ~.x %>% 
                           dplyr::group_by(region) %>% 
                           summarise(n_event = sum(lex.Xst))
                         )
    
     area_level <- levels(df_reduced$area)
   
     ## Get area-specific estimates with ----------------------------------------------------------------------------------- 
     
     ivw_FE_area <- 
          map(.x = cox_region, 
                  
              ~ .x %>% 
                 #Convert area to factor 
                 dplyr::mutate(area = factor(area, levels = area_level)) %>% 
                 dplyr::group_by(area) %>% 
                        group_split()  %>%  
                        setNames(area_level) %>% 
     
          map( ~metafor::rma(yi     = est_corrected, 
                             vi     = se_corrected^2, 
                             method = "FE", 
                             data   = .x
                             )
               ) %>% 
    
          map2(.y = area_level, 
               ~ tibble(
                 
                  est_corrected  = .x$b[1,1],
                  hr_corrected   = exp(est_corrected),
                  se_corrected   = .x$se,
                  lci            = .x$ci.lb,
                  uci            = .x$ci.ub,
                  est_ci         = paste0(format(round(exp(hr_corrected), 2), nsmall = 2), " (",
                                          format(round(exp(lci), 2), nsmall = 2),  " - ", 
                                          format(round(exp(uci), 2), nsmall = 2),  ")"
                                          ), 
                  area           = .y,
                  term           = paste0("All ", tolower(.y)),
                  IsDiamond      = 1, 
                  FillColour     = 0
                        
                  )
                   
               )
          )
    
               
     
      # Get area-specific events 
     
     for (df in seq_along(ivw_FE_area)) {
       
       ivw_FE_area[[df]] <- 
         
          map2(
            
            .x = ivw_FE_area[[df]], 
            .y = seq_along(ivw_FE_area[[df]]),
              
             ~ivw_FE_area[[df]][[.y]] %>%
              
                  dplyr::mutate(
                    
                    n_event = data_expanded[[df]] %>%
                                  dplyr::select(area, lex.Xst) %>% 
                                  dplyr::filter(area == area_level[[.y]]) %>% 
                                         summarise(events = sum(lex.Xst, na.rm = TRUE)) %>% 
                                         pull(events)
                    )
              ) 
        
     }
     
     
     
     ## Split region dataset and bind that for area --------------------------------------------------------------------------- 
     
  cox_region_forest <- list()
     
  for (df in seq_along(cox_region)){
       
       cox_region_forest[[df]] <- 
         
             cox_region[[df]] %>% 
         
                   dplyr::mutate(
                     
                     area    = factor(area, levels = area_level),
                     term    = as.character(term),
                     n_event = event_region[[df]]$n_event
                                 
                     ) %>% 
         
                   dplyr::select(-c(estimate:exposure)) %>% 
                   dplyr::group_by(area) %>% 
                          group_split() %>% 
                 
             map2_dfr(.y = seq_along(ivw_FE_area), 
                      
                      ~rbind(
                        
                        .x, 
                        ivw_FE_area[[df]][[.y]] %>% 
                        select(-c(lci:est_ci)) 
                             
                        ) %>% 
                               
                        add_row()
                      
                      ) %>% 
         
             rename("Heading" = term) %>% 
         
             as.data.frame(.)
            
 
       }    
    
       
   ## Get heterogeneity statistics and bind to dataset 
   area_level <- levels(data_expanded[[1]]$area)
   
   het_region_area <-
     
     map(.x = cox_region, 
                          
          ~.x %>% 
            dplyr::mutate(area = factor(area, levels = area_level)) %>% 
            dplyr::group_by(area) %>% 
                   group_split() %>% 
              
              map( ~heterogeneity(.$est_corrected, .$se_corrected)) %>% 
              map2_dfr(.y = area_level, 
                       ~tibble(DF    = c(rep(NA, 5), pluck(., 1), NA), 
                               Chi2  = c(rep(NA, 5), pluck(., 2), NA), 
                               p_int = c(rep(NA, 5), pluck(., 3), NA),
                               area  = .y)
                   )
            )   
   
   
     # Join het data to main region data --------------------------------------------------------------------
     cox_region_forest2 <- 
       
       map2(.x = cox_region_forest, 
            .y = het_region_area, 
                        
            #Bind Het data
            ~cbind(.x, 
                   .y %>% select(-area)
                   ) 
              
            # Add title for Urban and Rural
            # drop_na(Heading) %>% 
            # 
            # dplyr::group_by(area) %>% 
            #        group_split() %>% 
            # 
            # map2_dfr(.y = area_level, ~add_row(.x, 
            #                                    .before = 1, 
            #                                    Heading = .y))
            ) 
                 
 

```


### Make forest plot (REGION)

```{r}


# Format dataset ----------------------------------------------------------------------------------------------------


# set up an object that stores the forest and associated metadata
forest1 <- FormatForest(rawdata     = cox_region_forest2[[1]] %>% 
                                      rename("Het1"        = Chi2,  
                                             "IsDiamond1"  = IsDiamond, 
                                             "FillColour1" = FillColour
                                             ), 
                        forest.n    = 1, 
                        EstimateCol = "est_corrected",  
                        StdErrCol   = "se_corrected",
                        logData     = FALSE, 
                        getBlanks   = TRUE,   
                        getHets     = TRUE)

# set up an object that stores the forest and associated metadata
forest2 <- FormatForest(rawdata     = cox_region_forest2[[2]]%>% 
                                      rename("Het2"        = Chi2, 
                                             "IsDiamond2"  = IsDiamond, 
                                             "FillColour2" = FillColour
                                             ),  
                        forest.n    = 2, 
                        EstimateCol = "est_corrected",  
                        StdErrCol   = "se_corrected",
                        logData     = FALSE,  
                        getBlanks   = TRUE, 
                        getHets     = TRUE)

blank.rows  <- forest1$blank.rows 

 
# find labels to put in the left most column
left.labels <- convertUnicode(as.character(cox_region_forest2[[1]]$Heading))

# what other columns should be plotted
other.cols  <- "n_event"

# find column headings
print.headings <- parseColHeadings(cox_region_forest2[[1]]$ColHeadings, rd=cox_region_forest2[[1]])


# Make forest plot ---------------------------------------------------------------------------------------------------------------------
type <- "JPG"

SetPage(orient          = "LANDSCAPE", 
        perpage         = 1, 
        type            = type, 
        filestem        = "eFigure 2 Subgroup analysis by region (met4)", 
        page_dpi        = 600,
        page_pointsize  = 9,
        # page_height     = 14,
        # page_width      = 12,
        append_datetime = FALSE, 
        suppress.date   = TRUE, 
        titlespace      = 0.05, 
        footerspace     = 0.08, 
        footer.cex      = 1.3, 
        footer = "All analyses were stratified by age-at-risk and sex and adjusted for income, education, occupation, alcohol, smoking, sedentary time, ephysema, bronchitis and COPD. 
        
Region-specific hazard ratios (HRs) were corrected for regression dilution using region-specific regression dilution ratios and combined using inverse-variance-weighted fixed-effect meta-analysis
\n \n
        "
        )

# Set page margins: format is c(bottom, left, top, right)
par(mar=c(4.14537797266251, 2, 8.14537797266251, 2))

mainfont <- 1
blankPlot(c(0,100),c(0,100), mainfont)
par(xpd=NA) 

spacing    <- 0.8
plot.width <- 13
x_label    <- "HR (95% CI) per 4 MET-hr/day higher\nusual total physical activity"

# draw the Forest plot(s)
xaxmin1 <- 23.2542
xaxmax1 <- xaxmin1 + plot.width 
locs    <- ForestBasic(forest1,
                    	LogScale          = TRUE, 
                    	ExponentiateDataOnPlot=TRUE,
                    	xaxmin            = xaxmin1,
                    	xaxmax            = xaxmax1, 
                    	xlim              = c(0.2, 1.4),
                    	xticks            = c(0.2, 0.6, 1, 1.4),
                    	ticklabs          = c(0.2, 0.6, 1, 1.4),
                    	xlab              = x_label,
                    	NLabel            = FALSE,
                    	mainfont          = 0.95,
                    	ValueLabels       = TRUE,
                    	ValueLabelsHeader = "HR (95% CI)",
                    	ValueDigits       = NULL,
                    	lwd               = 1,
                    	CISecond          = TRUE,
                    	separator         = " - ",
                    	spacing           = spacing/2, 
                    	pointGroupsFactor = 0.9,
                    	verbose           = FALSE,
                    	boxsizeoverride   = FALSE,
                    	boxparm.stderr    = 0.03)

# add titles above forest (may be left empty, change labels="" to what you will)
text(x      = xaxmin1 + (xaxmax1 - xaxmin1 + (spacing) )/2, 
     y      = 110, 
     labels = "A. Heart Failure", 
     adj    = c(0.5,0), 
     font   = 2, 
     cex    = 1.15
     )


# draw the Forest plot(s)
xaxmin2 <- 62.0592
xaxmax2 <- xaxmin2 + plot.width
locs2 <- ForestBasic(forest2,
                    	LogScale          = TRUE,
                    	ExponentiateDataOnPlot = TRUE,
                    	xaxmin            = xaxmin2,
                    	xaxmax            = xaxmax2,
                    	xlim              = c(0.2, 1.4),
                    	xticks            = seq(0.2, 1.4, 0.4),
                    	ticklabs          = seq(0.2, 1.4, 0.4),
                    	xlab              = x_label,
                    	NLabel            = FALSE,
                    	mainfont          = 0.95,
                    	ValueLabels       = TRUE,
                    	ValueLabelsHeader = "HR (95% CI)",
                    	ValueDigits       = NULL,
                    	lwd               = 1,
                    	CISecond          = TRUE,
                    	separator         = " - ",
                    	spacing           = spacing/2,
                    	pointGroupsFactor = 0.9,
                    	verbose           = FALSE,
                    	boxsizeoverride   = FALSE,
                    	boxparm.stderr    = 0.03)

# add titles above forest (may be left empty, change labels="" to what you will)
text(x      = xaxmin2 + (xaxmax2 - xaxmin2 + (spacing) )/2, 
     y      = 110, 
     labels = "B. Pulmonary heart disease", 
     adj    = c(0.5,0), 
     font   = 2, 
     cex    = 1.15
     )



# left hand column of labels
area_level
y_pos   <- c(100, 50)

for (yi in seq_along(area_level)) {
      
    text(x = 4, 
         y = y_pos[[yi]], 
         labels = paste0(area_level[[yi]], "\n"), 
         adj = c(0,0), 
         font = 2, 
         cex = 1)
}    

    text(x      = 4, 
         y      = locs$YLocs, 
         adj    = 0, 
         cex    = 1, 
         font   = ifelse(forest1$IsDiamond, 2,1), 
         labels = left.labels[-blank.rows]
         )
    
    text(x      = 4, 
         y      = locs$BlankLocs, 
         adj    = 0, 
         font   = 2, 
         cex    = 1, 
         labels = left.labels[blank.rows]
         )




# adding other columns ----------------------------------------------------------------------------------------------------------------

# For HF 
column1.xpos <- xaxmin1 - 2

text(x      = column1.xpos, 
     y      = 100, 
     adj    = c(1,0), 
     font   = 2, 
     cex    = 1, 
     labels = convertUnicode("Number of\nevents")
     )

text(x      = column1.xpos, 
     y      = locs$YLocs, 
     font   = ifelse(forest1$IsDiamond, 2, 1),
     adj    = 1, 
     cex    = 1, 
     labels = convertUnicode(as.character(cox_region_forest2[[1]][,other.cols[1]]))[-blank.rows]
     )

text(x      = column1.xpos, 
     y      = locs$BlankLocs, 
     adj    = 1, 
     cex    = 1, 
     labels = convertUnicode(as.character(cox_region_forest2[[1]][,other.cols[1]]))[blank.rows]
     )

# For PHD
column2.xpos <- xaxmin2 - 2

text(x      = column2.xpos, 
     y      = 100, 
     adj    = c(1,0), 
     font   = 2, 
     cex    = 1, 
     labels = convertUnicode("Number of\nevents")
     )

text(x      = column2.xpos, 
     y      = locs$YLocs, 
     font   = ifelse(forest1$IsDiamond, 2, 1),
     adj    = 1, 
     cex    = 1, 
     labels = convertUnicode(as.character(cox_region_forest2[[2]][,other.cols[1]]))[-blank.rows]
     )

text(x      = column2.xpos, 
     y      = locs$BlankLocs, 
     adj    = 1, 
     cex    = 1, 
     labels = convertUnicode(as.character(cox_region_forest2[[2]][,other.cols[1]]))[blank.rows]
     )

##Plot title 
text(x      = 47.5, 
     y      = 119, 
     font   = 2, 
     cex    = 1.2,
     adj    = c(0.5, 0),
     labels = "eFigure 2: Region-specific hazard ratio (95% CI) of heart failure and pulmonary heart disease per 4 MET-hr/day\n higher usual total physical acitivity")



# Heterogeneity labels
x_coord <- list("hf"  = 37.1003646765421,
                "phd" = 76.0423204683451)

# Get data for hetereogeneity---------------------------------------------------------------------------------
het_df    <- map(.x = cox_region_forest2, ~.x %>%
                                           filter(!is.na(Chi2)) %>%
                                           select(DF:p_int))
 
n_row_het <- map(.x = het_df, ~nrow(.x))

index = 1


for (H in seq_len(n_row_het[[index]]) ) {

  chi_DF   <- het_df[[index]]$DF[H]
  chi_val  <- round(het_df[[index]]$Chi2[H], 2)
  p_value  <- het_df[[index]]$p_int[H]

  p_value  <- ifelse(p_value <0.0001, paste0("p", "<0.0001"), paste0("p=", round(p_value, 4)))

  text(x      = x_coord[[index]],
       y      = locs$HetLocs[H],
       adj    = 0,
       cex    = 0.8,
       labels = bquote(Het: ~ chi[.(chi_DF)]^2 ~ "=" ~ .(chi_val) ~ (.(p_value)))

       )

}


# Labels for PHD
# Heterogeneity labels for PHD

index = 2


for (H in seq_len(n_row_het[[index]]) ) {

  chi_DF   <- het_df[[index]]$DF[H]
  chi_val  <- round(het_df[[index]]$Chi2[H], 2)
  p_value  <- het_df[[index]]$p_int[H]

  p_value   <- ifelse(p_value <0.0001, paste0("p", "<0.0001"), paste0("p=", round(p_value, 4)))

  text(x      = x_coord[[index]],
       y      = locs$HetLocs[H],
       adj    = 0,
       cex    = 0.8,
       labels = bquote(Het: ~ chi[.(chi_DF)]^2 ~ "=" ~ .(chi_val) ~ (.(p_value)))

       )

}




# stop writing to file
closeFile(type)


```



# Effect of confounding (sequential and adjustment) --

## Proportion of Chi2 explained by predictors

Compute percentage of Chi2 explained by each predictor 

- Basic adjustment will include: stratification by age,sex, and area, and adjustment for education


```{r}

adjustment_vars
# Create a nested list to hold variable names and labels 
# Labels will be needed for the forest plot 

sequential_adjust_list <- 
  
          list(
            "minimal adjustment" = c("h_income"), 
            
            "ses" = list(
              "var_names" = c("edu", "agric_factory"), 
              "var_labels" = c(
                    "     + Education", 
                    "     + Occupation")
            ),
            
            "lifestyle" = list( # Lifestyle --
              
              "var_names" = c("smoking_status", "alcohol_recode","sed_time_hr_Q4"), 
              "var_labels" = c(
                    "    + Smoking",
                    "    + Alcohol consumption",
                    "    + Sedentary time")
            ), 
            
            "cld" = list( #Chronic lung disease --
              
              "var_names" = c("copd", "emphysema_bronchitis"), 
              "var_labels" = c(
                    "    + COPD",
                    "    + Emphysema or bronchitis")
            )
          
        
        )


adjustment_vars <- NULL
do_print <- FALSE
 
# 1. Minimal adjustments --

df_minimal <- 
  
      map(
        .x = data_expanded, 
        ~ lrtest_change_chi2(
  
            dataset = .x, 
            main_expo_var  = "met4", 
            minimal_adjustment = TRUE,
            stratify_vars  = c("age_lexis5", "sex", "region"), 
            confounder_adjustment_label = "Minimal adjustment", 
            adjustment_vars  = sequential_adjust_list$`minimal adjustment`, 
            print_model_info = do_print) 
      
        )
  
# 2. Socioeconomic status --

  # Simplify variable name and label 

  factors_ses <- sequential_adjust_list$ses$var_names  
  factors_lab_ses <- sequential_adjust_list$ses$var_labels
    
  df_ses <-  list()
  
  
  for (df in seq_along(data_expanded)) {
    
    
    list_ses <- list() 
        
        for (S in seq_along(factors_ses)){
          
          
          if(S > 1){
            
            adjust_ses <- c(
              
                sequential_adjust_list$`minimal adjustment`, # Covariates used for minimal adjustment 
                factors_ses[ seq_len(S-1) ] # Perform sequential adjustment for previous covariates
             
                )
          
          } else {adjust_ses <- c(sequential_adjust_list$`minimal adjustment`)}
          
          
          list_ses[[S]] <- 
            
            lrtest_change_chi2(
      
                dataset = data_expanded[[df]], 
                main_expo_var  = "met4", 
                confounder_vars = factors_ses[S],
                stratify_vars  = c("age_lexis5", "sex", "region"), 
                confounder_adjustment_label = factors_lab_ses[S], 
                adjustment_vars  = adjust_ses, 
                minimal_adjustment = FALSE,
                print_model_info = do_print) 
          
          
          }

    # Combine datasets --
    df_ses[[df]] <- bind_rows(list_ses)%>% 
                         dplyr::mutate(name_group = "Demographic and SES factors") # Create group name
  
  
  }
  
  
# 3. Lifestyle factors --

  # Simplify variable name and label 

  factors_ls <- sequential_adjust_list$lifestyle$var_names  
  factors_lab_ls <- sequential_adjust_list$lifestyle$var_labels
    
  df_lifestyle <-  list()
  
  
  for (df in seq_along(data_expanded)) {
    
    
    list_lifestyle <- list() 
        
        for (l in seq_along(factors_ls)){
          
          
          if(l > 1){
            
            adjust_ls <- c(
                
                sequential_adjust_list$`minimal adjustment`, # Covariates used for minimal adjustment
                sequential_adjust_list$ses$var_names,        # Covariates used for ses
                factors_ls[ seq_len(l-1) ] # In addition, adjust for previous lifestyle factors
             
                )
            
          
          } else {adjust_ls <- c(sequential_adjust_list$`minimal adjustment`, 
                                 sequential_adjust_list$ses$var_names)}
          
          
          
          list_lifestyle[[l]] <- 
            
            lrtest_change_chi2(
      
                dataset = data_expanded[[df]], 
                main_expo_var  = "met4", 
                confounder_vars = factors_ls[l],
                stratify_vars  = c("age_lexis5", "sex", "region"), 
                confounder_adjustment_label = factors_lab_ls[l], 
                adjustment_vars  = adjust_ls, 
                minimal_adjustment = FALSE,
                print_model_info = do_print) 
          
          }

    # Combine datasets --
    df_lifestyle[[df]] <- bind_rows(list_lifestyle)%>% 
                               dplyr::mutate(name_group = "Lifestyle factors")
  
  }


# 3. CLD --
  
  
  factors_pm <- sequential_adjust_list$cld$var_names  
  factors_lab_pm <- sequential_adjust_list$cld$var_labels
    
  df_pm <-  list()
  
  
  for (df in seq_along(data_expanded)) {
    
    
    list_pm <- list() 
        
        for (p in seq_along(factors_pm)){
           
          
          if(p > 1){
            
            adjust_pm <- c(
                sequential_adjust_list$`minimal adjustment`,
                sequential_adjust_list$ses$var_names,
                sequential_adjust_list$lifestyle$var_names,
                factors_pm[ seq_len(p-1) ] 
             )
            
          
            } else{
            
            adjust_pm <- c(
                sequential_adjust_list$`minimal adjustment`,
                sequential_adjust_list$ses$var_names,
                sequential_adjust_list$lifestyle$var_names
          
                )
            
          }
          
          
          
          list_pm[[p]] <- 
            
            lrtest_change_chi2(
      
                dataset = data_expanded[[df]], 
                main_expo_var  = "met4", 
                confounder_vars = factors_pm[p],
                stratify_vars  = c("age_lexis5", "sex", "region"), 
                confounder_adjustment_label = factors_lab_pm[p], 
                adjustment_vars  = adjust_pm, 
                minimal_adjustment = FALSE,
                print_model_info = do_print
                
              )   
          
          }

    # Combine datasets --
    df_pm[[df]] <- bind_rows(list_pm) %>% 
                       dplyr::mutate(name_group = "Chronic lung disease")
  
  }


  # Prepare to bind rest of dataset from the minimally adjusted results ---
  # Harmonise column names before binding 
  # Bind datasets 
  
   df_minimal_temp <- 
    
     map(.x = df_minimal, 
         ~.x %>% 
           select(-c(p_value_before, confounder_adjust_before, adjustment)) %>% 
           mutate(chi2_after = chi2_before) %>%  # For minimally adjusted models, use Chi2 before 
           rename("df" = df_before)
         )
  
   
   
  df_bind_temp <- 
    
    map2(
      .x = df_ses, 
      .y = df_lifestyle, 
      ~bind_rows(.x, .y)) %>% 
    
   map2(.y = df_pm, 
        ~bind_rows(.x, .y) %>% 
          select(-c(p_value_before, 
                    confounder_adjust_before, 
                    df_after, 
                    p_value_after, 
                    confounder_adjust, 
                    chi_change)
                 ) %>% 
          rename("df" = df_before)
        
        )
  
  

  # Bind all datasets --
  
  df_mediation <-  map2(
    
        .x = df_minimal_temp, 
        .y = df_bind_temp, 
        ~bind_rows(.x, .y) %>% 
          
          mutate(
            est_corrected = estimate/RDR,   # Correct estimates and SE for regression dilution
            se_corrected = std.error/RDR,
            chi2_after = format(round(chi2_after, 1), nsmall = 1, scientific = FALSE),
            IsDiamond = 0, 
            FillColour = 1
            ) %>%  
          rename("Heading" = adjust_label) %>% 
         as.data.frame(.)                   # Force into a dataframe for plotting with Jasper
        
        )  
  

source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/add_table_header.R")

df_mediation <- 
    map(.x = df_mediation,
        ~dplyr::mutate(.x, name_group = ifelse(is.na(name_group), Heading, name_group)) %>% 
          add_table_header(data = .,
                          group_var       = name_group, 
                          group_level_var = Heading, 
                          extra_space     = FALSE) %>% 
          slice(-1) %>%
          dplyr::mutate(Show = ifelse(is.na(FillColour), NA, 1)) %>%
          as.data.frame(.)
        )



```

## Mediation plotting 

```{r}

n_label <- 
  
  map(.x = data_expanded, 
      ~paste0( "(n=", prettyNum(sum(.x$lex.Xst, na.rm = TRUE), big.mark = ",",  scientific = FALSE),  ")"  ) )

# Format dataset ----

# set up an object that stores the forest and associated metadata
forest1 <- FormatForest(
              rawdata     = df_mediation[[1]] %>% 
                                 rename("IsDiamond1" = IsDiamond, 
                                        "FillColour1" = FillColour,
                                        "Show1" = Show), 
              forest.n    = 1, 
              EstimateCol = "est_corrected",  
              StdErrCol   = "se_corrected",
              logData     = FALSE, 
              getBlanks   = TRUE)

# set up an object that stores the forest and associated metadata
forest2 <- FormatForest(
             rawdata     = df_mediation[[2]] %>% 
                                 rename(
                                   "IsDiamond2" = IsDiamond,
                                   "FillColour2" = FillColour, 
                                   "Show2" = Show) ,  
             forest.n    = 2, 
             EstimateCol = "est_corrected",  
             StdErrCol   = "se_corrected",
             logData     = FALSE,  
             getBlanks   = TRUE)

blank.rows  <- forest1$blank.rows 

# Format headings to incorporate expressions -----

# find labels to put in the left most column
left.labels <- convertUnicode(as.character(df_mediation[[1]]$Heading))


# what other columns should be plotted
other.cols  <- "chi2_after"

# find column headings
print.headings <- parseColHeadings(df_mediation[[1]]$ColHeadings, rd=df_mediation[[1]])


# Make forest plot -----

type <- "PNG"

SetPage(orient          = "LANDSCAPE",
        png_bg          = "white",
        perpage         = 1, 
        type            = type, 
        filestem        = "eFigure 1 serial adjustment for confounding", 
        page_dpi        = 300,
        page_pointsize  = 10,
        # page_height     = 14,
        page_width      = 10,
        append_datetime = FALSE, 
        suppress.date   = TRUE, 
        titlespace      = 0.05, 
        footerspace     = 0.06, 
        footer.cex      = 1.5, 
        footer    = "The minimally adjusted model was stratified by age-at-risk, sex, and all 10 study areas and adjusted for income. 
COPD = Chronic obstructive pulmonary disease; SES = Socioeconomic status\n\n" 
        )

# Set page margins: format is c(bottom, left, top, right)
par(mar=c(5.14537797266251, 0.5, 9.14537797266251, 0.5))

mainfont <- 1.0
blankPlot(c(0,100),c(0,100), mainfont)
par(xpd=NA)

spacing <- 1
plot.width <- 10

# draw the Forest plot(s)
xaxmin1 <- 24.2542
xaxmax1 <- xaxmin1 + plot.width

xaxmin2 <- 63.5592
xaxmax2 <- xaxmin2 + plot.width

x_label <- "HR (95% CI) per 4 MET-hr/day\n higher usual total physical acitivity"

locs <- list()

for (df in seq_along(df_mediation)) {
  
  
  locs[[df]] <- ForestBasic( 
                list(forest1, forest2)[[df]],
              	LogScale=TRUE,
              	ExponentiateDataOnPlot=TRUE,
              	xaxmin= c(xaxmin1, xaxmin2)[df],
              	xaxmax= c(xaxmax1, xaxmax2)[df],
              	xlim=c(0.7, 1.1),
              	xticks=c(0.7, 1.0, 1.1),
              	ticklabs=c("0.7", "1.0", ""),
              	xlab= x_label,
              	NLabel=FALSE,
              	mainfont=1,
              	ValueLabels=TRUE,
              	ValueLabelsHeader="HR (95% CI)",
              	ValueDigits=NULL,
              	lwd=0.8,
              	CISecond=TRUE,
              	spacing=spacing,
              	pointGroupsFactor=0.9,
              	verbose=FALSE,
              	boxsizeoverride=FALSE,
              	boxparm.stderr = 0.005)


# Adding headings and other columns ----

## Panel titles --
  
    # Main title --
    x_main_pos <- c(xaxmin1 + (xaxmax1 - xaxmin1 + (spacing) )/2, 
                    xaxmin2 + (xaxmax2 - xaxmin2 + (spacing) )/2)
    text(
      x= x_main_pos[df] , 
      y=115, 
      labels= c("A. Heart failure", "B. Pulmonary heart disease")[df], 
      adj=c(0.5,0), 
      font=2, 
      cex = 1.1, 
      col="black")
    
    # Event title --
    text(x=x_main_pos[df], y=110, labels= n_label[df], adj=c(0.5,0), font=1, cex = 1)

    ## Add other columns for both outcomes --
    x.positions <- c(xaxmax1 + 18, xaxmax2 + 18)
    
    # Header --
    text(x= x.positions[df], y=100, labels=expression(chi[1]^2), adj=c(1,0), font=2, cex=1)
    
    # Contents --
    if(is.null(blank.rows)){
      
      text(
       x=x.positions[df], 
       y= locs[[df]]$YLocs, 
       labels=convertUnicode(as.character(df_mediation[[df]] [,other.cols[1]])), 
       font=ifelse(forest1$IsDiamond, 2, 1),, 
       adj=1, 
       cex=1)
      
    } else {
      
      text(
       x=x.positions[df], 
       y= locs[[df]]$YLocs, 
       labels=convertUnicode(as.character(df_mediation[[df]] [,other.cols[1]]))[-blank.rows], 
       font=ifelse(forest1$IsDiamond, 2, 1),, 
       adj=1, 
       cex=1)
      
    }
    
    
    # Labels for blank rows -- 
    if(is.null(blank.rows)){
      
      text(
       x=x.positions[df],
       y= locs[[df]]$BlankLocs,
       labels=convertUnicode(as.character(df_mediation[[df]] [,other.cols[1]])), ,
       adj=1,
       cex=1)
      
    } else {
      
      text(
       x=x.positions[df],
       y= locs[[df]]$BlankLocs,
       labels=convertUnicode(as.character(df_mediation[[df]] [,other.cols[1]]))[blank.rows], ,
       adj=1,
       cex=1)
    }
    
  
}


# left hand column of labels for HF forest --

text(x=4, y=100, labels="Adjustments", adj=c(0,0), font=2, cex=1.1)

  if(is.null(blank.rows)){
    
    text(x=4, y=locs[[1]]$YLocs, labels=left.labels, adj=0, cex=1, font=ifelse(forest1$IsDiamond, 2,1))
    text(x=4, y=locs[[1]]$BlankLocs, labels=left.labels, adj=0, font=2, cex=1)
  
    } else {
      
    text(x=4, y=locs[[1]]$YLocs, labels=left.labels[-blank.rows], adj=0, cex=1, font=ifelse(forest1$IsDiamond, 2,1))
    text(x=4, y=locs[[1]]$BlankLocs, labels=left.labels[blank.rows], adj=0, font=2, cex=1)
  
  }



##Plot title 
text(x=50.5, 
     y= 125, 
     font=2, 
     cex = 1.1,
     adj=c(0.5, 0),
     col="black",
     labels="eFigure 1: Hazard ratio (95% CI) of heart failure and pulmonary heart disease per 4 MET-hr/day higher usual total physical acitivity\nwith sequential adjustment for confounding")

# stop writing to file
closeFile(type)

```



# Sensitivity analysis

Sensitivity analysis will include the following 

1. Further adjustments for waist circumference and BMI 

2. Sequential exclusion based on the following criteria 
  a. Excluding the first two years of follow-up
  b. Excluding participants with poor self-rated heath at baseline
  c. Excluding participants with chronic lung disease 
  d. Excluding participants with SOB on walking at baseline 
  f. Excluding participants with co-occurring PHD or HF 

**Sex-specific quintiles were recalculated after each exclusion**

Show the association between studied over time? (shape and strength?)


## select relevant variables
To save memory

```{r}

adjust <- c(ses_vars, 
            lifestyle_vars, 
            "heart_rate_mean_Q4", 
            "waist_circ_cm_Q4", 
            "diabetes",  
            "emphysema_bronchitis", 
            "HTN",
            "copd", 
            "waist_circ_cm_Q4", 
            "bmi_calc_Q4") 

strata_vars <- c("age_lexis5", "sex","region")

expos       <- c("met_q5_sex", "met4", "metsd", "met")

outcome     <- c("lex.dur", "lex.Xst")

exclusion   <- c("poor_health", "SOB_walking", "CLD")

exit_status <- c("HF_combined_ep", "PHD_combined_ep")


sensitivity_vars <- c(adjust, strata_vars, expos, outcome, exclusion, exit_status)

# Select variables --------------------------------------------------------------------------------------------------------------------

data_expanded <- map(.x = data_expanded, ~select(.x, all_of(sensitivity_vars)))

```


## 1. Further adjustments

Do further adjustments for BMI, WC, hypertension, and diabetes

```{r}

# source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/Cox_shape_strength_data.R")

main_adjust <- c(
  
  ses_vars, 
  lifestyle_vars,   
  "emphysema_bronchitis", 
  "copd"
  
           ) 


sens_adjust_vars <- c(
  
  "bmi_calc_Q4", 
  "waist_circ_cm_Q4", 
  "diabetes",
  "HTN"
  )

# Create lists to hold data 
shape_sens1    <- list()
met_cont_sens1 <- list()
metsd_sens1    <- list()


for (m in seq_along(sens_adjust_vars)) { 
  
  sens_adjust_vars_temp <- NULL
  sens_adjust_vars_temp <- sens_adjust_vars[seq_len(m)]

  adjust <- NULL  
  adjust <- c(main_adjust, sens_adjust_vars_temp)


# SHape ------------------------------------------------------------------------------------------------------------------

shape_sens1[[m]] <- 
  
  map(.x = data_expanded, 
                   
       ~Cox_shape_strength_data(
         
             dataset                     = .x, 
             exposure_var_cat            = "met_q5_sex", 
             expo_type_shape             = TRUE,
             correct_regression_dilution = FALSE,
             adjustment_vars             = adjust, 
             print_model_info = FALSE
                                      
      ) %>% 
         
       pluck(., 2) %>%
       dplyr::mutate(PA_resurv_mean = resurv_met_df$mean_met_resurvey,
                     analysis = paste0("Further adjustment for ",
                                            paste0(sens_adjust_vars_temp, collapse = ", "))
                     )
                     
 )



# Met4 --------------------------------------------------------------------------------------------------------------------
  
met_cont_sens1[[m]] <- 
    
    map(
      
      .x = data_expanded,
                   
         ~Cox_shape_strength_data(
           
           dataset                      = .x, 
           exposure_var_cont           = "met4", 
           expo_type_continuous        = TRUE,
           correct_regression_dilution = TRUE, 
           regression_dilution_ratio   = RDR,
           adjustment_vars             = adjust, 
           print_model_info = FALSE
                                    
                                    
           ) %>% 
           
           pluck(., 2) %>%
           dplyr::mutate(analysis = paste0("Further adjustment for ",
                                            paste0(sens_adjust_vars_temp, collapse = ", ")))
         
      )


# METSD -------------------------------------------------------------------------------------------------------------------

metsd_sens1[[m]] <- 
    
    map(
      
      .x = data_expanded,
                   
         ~Cox_shape_strength_data(
           
           dataset           = .x, 
           exposure_var_sd   = "metsd",
           expo_type_sd      = TRUE,
           correct_regression_dilution = TRUE,
           adjustment_vars   = adjust, 
           print_model_info = FALSE
                                    
           ) %>% 
            
           pluck(., 2) %>%
           dplyr::mutate(analysis = paste0("Further adjustment for ",
                                           paste0(sens_adjust_vars_temp, collapse = ", ")))
         
      )

}


```


### Re-arrange lists

The exposures should be nested within the datasets. Not the other way around 

That is 

list 1 - Heart failure 
    Sublists
       - Exposure 1
       - Exposure 2
       - Exposure 3
       - Exposure 4

list 2 - PHD
    Sublists
       - Exposure 1
       - Exposure 2
       - Exposure 3
       - Exposure 4
       
Then flatten the list


```{r}

shape_sens_df    <- list()
met_cont_sens_df <- list()
metsd_sens_df    <- list()


for (df in seq_along(data_expanded)) {
  
  shape_sens_df[[df]]    <- map(.x = shape_sens1, ~pluck(.x, df) %>% 
                                  dplyr::mutate(outcome = c("hf", "phd")[df])) 
  
  met_cont_sens_df[[df]] <- map(.x = met_cont_sens1, ~pluck(.x, df)%>% 
                                  dplyr::mutate(outcome = c("hf", "phd")[df])) 
  
  metsd_sens_df[[df]] <- map(.x = metsd_sens1, ~pluck(.x, df)%>% 
                                  dplyr::mutate(outcome = c("hf", "phd")[df])) 

}


# Bind data for main model (for plotting)
#========================================

shape_sens_df <- 
  
  map2(
    
    .x = FAR,
    .y = seq_along(FAR),
    
    ~c(
      list(.x %>% 
             # Manipulate column headings 
             
             rename("PA_resurv_mean" = mean_met) %>% 
             dplyr::mutate(
               
               analysis = "main", 
               outcome  = c("hf", "phd")[.y])
           
           ), 
      
      shape_sens_df[[.y]]
      
      )
    
)

# Bind MET4 data from main analysis
#==================================

met_cont_sens_df <- 
  
  map2(
    
      .x = model_cont,
      .y = seq_along(model_cont),
      
      ~c(
        list(.x %>% 
               # Manipulate column headings 
               filter(exposure == "met4") %>% 
               rename("term" = exposure) %>% 
               
               dplyr::mutate(
                 
                 analysis = "main", 
                 outcome  = c("hf", "phd")[.y])
             
             ), 
        
        met_cont_sens_df[[.y]]
        
        )
      
)


# Bind METSD data from main analysis
#====================================

metsd_sens_df <- 
  
  map2(
    
      .x = model_cont,
      .y = seq_along(model_cont),
      
      ~c(
        list(.x %>% 
               # Manipulate column headings 
               filter(exposure == "metsd") %>% 
               rename("term" = exposure) %>% 
               
               dplyr::mutate(
                 
                 analysis = "main", 
                 outcome  = c("hf", "phd")[.y])
             
             ), 
        
        metsd_sens_df[[.y]]
        
        )
      
)



# Flatten the datasets

shape_sens_df    <- flatten(shape_sens_df)
met_cont_sens_df <- flatten(met_cont_sens_df)
metsd_sens_df    <- flatten(metsd_sens_df)


```


### Plot shape data 

```{r}

# Get plot data 
#==============

plotdata <- 
  
  map (
    
    .x = shape_sens_df, 
    
    ~data.frame(
      
      RF_Level = .x$PA_resurv_mean, 
      Estimate = .x$estimate, 
      StdErr   = .x$quasiSE, 
      Events   = .x$n, 
      exp_est  =  exp(.x$estimate), 
      outcome  = .x$outcome
      
      ) %>% 
      
  `row.names<-`(NULL)
) 

    
# Get labels for number of events 
#================================
    
events_sum <- map(
  
  .x =shape_sens_df, 
  
  ~paste0(
    
    "(n=", 
    prettyNum(sum(.x$n), big.mark   = ",", scientific = FALSE), 
    ")"
    
    )
                        
)

# Get labels for continuous 
#==========================

met4_labels <- 
     map(
       
       .x = met_cont_sens_df, 
         
         ~.x %>% 
           dplyr::mutate(
             
             term_level  = "4 MET-hour/day", 
             hr_ci = paste0(
               
               format(round(hr_corrected,  2), nsmall = 2L), " (",
               format(round(lci_corrected, 2), nsmall = 2L), " - ", 
               format(round(uci_corrected, 2), nsmall = 2L), ")"
                
               )
             
             ) %>%
         
           select(term, term_level, hr_ci, analysis, outcome)
         )
    
# Get labels for metsd
#=====================

metsd_labels <- 
     map(
       
       .x = metsd_sens_df,  
         
         ~.x %>%    
           dplyr::mutate(
             
             term_level = "1 SD MET-hour/day", 
             hr_ci = paste0(
               
               format(round(hr_corrected,  2), nsmall = 2L), " (",
               format(round(lci_corrected, 2), nsmall = 2L), " - ", 
               format(round(uci_corrected, 2), nsmall = 2L), ")"
               
               )
             
             ) %>% 
         
           select(term, term_level, hr_ci, analysis, outcome)
         )

# Bind met4 and metsd 
#====================

hr_cont_labels <- 
         
  map2(
           
     .x = met4_labels, 
     .y = metsd_labels, 
        
     ~rbind(.x, .y)
     
  )
    

 
headers <- c(
  
  "A: Main model",
  "B: (A) + BMI",
  "C: (B) + WC",
  "D: (C) + diabetes",
  "E: (D) + hypertension")


## Subheadings for panels: A. Heart failure and B. Pulmonary heart disease 
n_expo <- length(sens_adjust_vars)

outcome <- c(
  
  "Heart failure", 
  rep(NA, n_expo),
  
  "Pulmonary heart disease", 
  rep(NA, n_expo)
  
  )


yaxisL  <- c(
  
  "Hazard ratio (95% CI)", 
  rep(NA, n_expo),
  
  "Hazard ratio (95% CI)", 
  rep(NA, n_expo)
  
  )

xaxisL  <- c(rep(NA, n_expo+1), 
             rep("Usual total physical activity, MET-hour/day", n_expo+1))



# set up the Jasper page
type <- "PNG"
SetPage(
  
  orient         = "LANDSCAPE",
  perpage        = 10,
  type           = type, 
  png_bg         = "white",
  page_width     = 18,
  page_height    = 12,
  page_dpi       = 600,
  page_pointsize = 11,
  suppress.date  = TRUE,
  titlespace     = 0.12, 
  footerspace    = 0.06,
  footer.cex = 1.5,
  footer  ="The main model was stratified by age-at-risk, sex, and study area and adjusted for income, education, occupation, alcohol, smoking, sedentary time, ephysema, bronchitis and COPD
  \n
        ",
  filestem       = "eFigure 3 - Sensitivity analysis PA (further adjustments)"
  
  )

par(mar=c(1,1,1,1))


# loop over the panels in a slightly strange order, to match data
for (j in seq_along(plotdata)) {

	LinearPlot( 
	  
	   plotdata[[j]], 
     new.plot          = TRUE, 
     mainfont          = 1,   
     YLogScale         = TRUE, 
     ExponentiateDataOnPlot = TRUE,
     boxparm.stderr    = 0.025, 
     xlim              = c(10,30),  
     xticks            = seq(10,30, 5), 
     ylim              = c(0.25, 2), 
     yticks            = c(0.25, 0.5, 1, 2), 
     margins           = c(5,5,3,2),  
     xticklabs.cex     = 0.9, 
     yticklabs.cex     = 0.9,
     PointLabelsTop    = "exp_est",
     PointLabelsBottom = "Events",
     PointLabelsCEX    = 0.8, 
     TruncateAtPlotLims = FALSE,
     CIsOnTop           = TRUE
	   
	   )
	
	# add axis labels
	AxisLabels(ylab=yaxisL[[j]],  
	           xlab=xaxisL[[j]], 
	           mainfont=0.9)
	
	par(xpd=NA)
	
	
	# add the column heading
	
	if(j <= n_expo+1) {
	 text(x=20, y=log(3.2), labels=headers[j], font=2, cex = 1)
	}
	
	 text(x=20,  y=log(1.9), labels = events_sum[[j]], font=1, cex = 1)
	 text(x=10,  y=log(2.2), labels = outcome[[j]], font=2, adj=c(0,0), cex = 1.2)
	
	
	# Add labels for HR 
	text(x      = 10, 
	     y      = log(0.26), 
	     labels = paste0("Per usual level\n", paste0(hr_cont_labels[[j]]$term_level, ":", collapse = "\n")), 
	     font   = 1, 
	     cex    = 0.8, 
	     adj    = c(0, 0)
	     )
	
	text(x      = 20.5, 
	     y      = log(0.26), 
	     labels = paste0("HR (95% CI)\n", paste0(hr_cont_labels[[j]]$hr_ci, collapse = "\n")), 
	     font   = 1, 
	     cex    = 0.8, 
	     adj    = c(0, 0)
	     )

 
  
}

## Plot title 
##Plot title

new.plot=TRUE

text(x      = -45, 
     y      = log(82), 
     font   = 2, 
     cex    = 1.3,
     adj    = c(0.5, 0),
     labels = "eFigure 3: Associations of total physical activity with heart failure and pulmonary heart disease after further sequential adjustment for body mass index (BMI), \nwaist circumference (WC), diabetes and hypertension")


closeFile(type)






```


## Further exclusion

## 2. Exclude 2 years follow up

```{r}

# Drop merged data to free memory
rm(merged_data)

adjust <- c(ses_vars, 
            lifestyle_vars,  
            "emphysema_bronchitis", 
            "copd") 

# Drop follow up time 
data_expanded_fu2 <- map(.x = data_expanded, ~.x[.x$lex.dur > 2, ])

# Recalculate met4, metsd, sex-specific Q5 ---------------------------------------------------------------------------------------------
data_expanded_fu2 <- 
  
  map(.x = data_expanded_fu2, 
    
    ~.x %>% dplyr::group_by(sex) %>% 
                   dplyr::group_split() %>% 
                   map( ~ .x %>% 
                           dplyr::mutate(met_q5_sex = factor(quantcut(met, 5), 
                                                             labels = c("Q1", "Q2", "Q3", "Q4", "Q5")), 
                                         
                                         met4       = met/4, 
                                         metsd      = scale(met)
                                         )
                        ) %>%
            map_dfr( ~rbind(.x))
      )

# Shape ------------------------------------------------------------------------------------------------------------------

shape_fu2 <- map(.x = data_expanded_fu2, 
                   
                   ~Cox_shape_strength_data(dataset                      = .x, 
                                             exposure_var_cat            = "met_q5_sex", 
                                             expo_type_shape             = TRUE,
                                             correct_regression_dilution = FALSE,
                                             adjustment_vars             = adjust, 
                                             print_model_info = FALSE ) %>% 
                     
                     pluck(., 2) %>% 
                     dplyr::mutate(PA_resurv_mean = resurv_met_df$mean_met_resurvey, 
                                   analysis       = "Exclude 2 years follow up")
                   )




# Met4 --------------------------------------------------------------------------------------------------------------------
  
met_cont_fu2 <- map(.x = data_expanded_fu2,
                   
         ~Cox_shape_strength_data(dataset                      = .x, 
                                   exposure_var_cont           = "met4", 
                                   expo_type_continuous        = TRUE,
                                   correct_regression_dilution = TRUE, 
                                   regression_dilution_ratio   = RDR,
                                   adjustment_vars             = adjust, 
                                   print_model_info = FALSE) %>% 
           
           pluck(., 2) %>% 
           dplyr::mutate(analysis = "Exclude 2 years follow up")
         )


# METSD -------------------------------------------------------------------------------------------------------------------

metsd_fu2 <- map(.x = data_expanded_fu2,
                   
         ~Cox_shape_strength_data(dataset           = .x, 
                                  exposure_var_sd   = "metsd",
                                  expo_type_sd      = TRUE,
                                  correct_regression_dilution = TRUE,
                                  adjustment_vars   = adjust,
                                  print_model_info = FALSE) %>% 
            
           pluck(., 2) %>% 
           dplyr::mutate(analysis = "Exclude 2 years follow up")
         )

rm(data_expanded_fu2)

```


## 3. Exclude poor self-rated health 

```{r}

adjust <- c(ses_vars, 
            lifestyle_vars, 
            "emphysema_bronchitis", 
            "copd"
           ) 

# Drop 
## 1. follow up time +
## 2. Poor health + 

data_expanded_poorh <- map(.x = data_expanded, 
                           ~.x[.x$lex.dur > 2, ] %>% 
                             filter (poor_health == "No")
                           )


# Calculate sex-specific Q5 ---------------------------------------------------------------------------------------------
data_expanded_poorh <- 
  
  map(.x = data_expanded_poorh, 
    
    ~.x %>% dplyr::group_by(sex) %>% 
                   dplyr::group_split() %>% 
                   map( ~ .x %>% 
                           dplyr::mutate(met_q5_sex = factor(quantcut(met, 5), 
                                                             labels = c("Q1", "Q2", "Q3", "Q4", "Q5")), 
                                         
                                         met4       = met/4, 
                                         metsd      = scale(met)
                                         )
                        ) %>%
            map_dfr( ~rbind(.x))
      )


# Shape -----------------------------------------------------------------------------------------------------------------

shape_poorh <- map(.x = data_expanded_poorh, 
                   
                   ~Cox_shape_strength_data(dataset                      = .x, 
                                             exposure_var_cat            = "met_q5_sex", 
                                             expo_type_shape             = TRUE,
                                             correct_regression_dilution = FALSE,
                                             adjustment_vars             = adjust, 
                                             print_model_info = FALSE) %>% 
                     
                     pluck(., 2) %>% 
                     dplyr::mutate(PA_resurv_mean = resurv_met_df$mean_met_resurvey, 
                                   analysis       = "2 years fu + poor health")
                   )




# Met4 --------------------------------------------------------------------------------------------------------------------
  
met_cont_poorh <- map(.x = data_expanded_poorh,
                   
         ~Cox_shape_strength_data(dataset                      = .x, 
                                   exposure_var_cont           = "met4", 
                                   expo_type_continuous        = TRUE,
                                   correct_regression_dilution = TRUE, 
                                   regression_dilution_ratio   = RDR,
                                   adjustment_vars             = adjust, 
                                   print_model_info = FALSE
                                    
                                    ) %>% 
           
           pluck(., 2) %>% 
           dplyr::mutate(analysis = "2 years fu + poor health")
         )


# METSD -------------------------------------------------------------------------------------------------------------------

metsd_poorh <- map(.x = data_expanded_poorh,
                   
         ~Cox_shape_strength_data(dataset           = .x, 
                                  exposure_var_sd   = "metsd",
                                  expo_type_sd      = TRUE,
                                  correct_regression_dilution = TRUE,
                                  adjustment_vars   = adjust, 
                                  print_model_info = FALSE) %>% 
            
           pluck(., 2) %>% 
           dplyr::mutate(analysis = "2 years fu + poor health")
         )

rm(data_expanded_poorh)

```


## 4. Exclude participants with SOB at baseline 

```{r}


adjust <- c(ses_vars, 
            lifestyle_vars,  
            "emphysema_bronchitis", 
            "copd") 

# Drop 
## 1. follow up time +
## 2. Poor health + 

data_expanded_sob <- map(.x = data_expanded, 
                           ~.x[.x$lex.dur > 2, ] %>% 
                             filter (poor_health == "No", 
                                     SOB_walking == "No")
                           )


# Calculate sex-specific Q5 ---------------------------------------------------------------------------------------------
data_expanded_sob <- 
  
  map(.x = data_expanded_sob, 
    
    ~.x %>% dplyr::group_by(sex) %>% 
                   dplyr::group_split() %>% 
                   map( ~ .x %>% 
                           dplyr::mutate(met_q5_sex = factor(quantcut(met, 5), 
                                                             labels = c("Q1", "Q2", "Q3", "Q4", "Q5")), 
                                         
                                         met4       = met/4, 
                                         metsd      = scale(met)
                                         )
                        ) %>%
            map_dfr( ~rbind(.x))
      )

# Shape -----------------------------------------------------------------------------------------------------------------
shape_sob <- map(.x = data_expanded_sob, 
                   
                   ~Cox_shape_strength_data(dataset                      = .x, 
                                             exposure_var_cat            = "met_q5_sex", 
                                             expo_type_shape             = TRUE,
                                             correct_regression_dilution = FALSE,
                                             adjustment_vars             = adjust, 
                                             print_model_info = FALSE
                                              
                                              ) %>% 
                     
                     pluck(., 2) %>% 
                     dplyr::mutate(PA_resurv_mean = resurv_met_df$mean_met_resurvey, 
                                   analysis       = "2 years fu + poor health + SOB")
                   )




# Met4 --------------------------------------------------------------------------------------------------------------------
  
met_cont_sob <- map(.x = data_expanded_sob,
                   
         ~Cox_shape_strength_data(dataset                      = .x, 
                                   exposure_var_cont           = "met4", 
                                   expo_type_continuous        = TRUE,
                                   correct_regression_dilution = TRUE, 
                                   regression_dilution_ratio   = RDR,
                                   adjustment_vars             = adjust, 
                                  print_model_info = FALSE
                                    
                                    ) %>% 
           
           pluck(., 2) %>% 
           dplyr::mutate(analysis = "2 years fu + poor health + SOB")
         )


# METSD -------------------------------------------------------------------------------------------------------------------

metsd_sob <- map(.x = data_expanded_sob,
                   
         ~Cox_shape_strength_data(dataset           = .x, 
                                  exposure_var_sd   = "metsd",
                                  expo_type_sd      = TRUE,
                                  correct_regression_dilution = TRUE,
                                  adjustment_vars   = adjust,
                                  print_model_info = FALSE
                                    
                                    ) %>% 
            
           pluck(., 2) %>% 
           dplyr::mutate(analysis = "2 years fu + poor health + SOB")
         )

rm(data_expanded_sob)


```


## 5. Exclude chronic lung disease 

Chronic lung disease in this analysis includes 
- COPD
- TB
- Emphysema or bronchitis
- Asthma


```{r}


adjust <- c(ses_vars, lifestyle_vars) 

# Drop 
## 1. follow up time +
## 2. Poor health + 

data_expanded_cld <- map(.x = data_expanded, 
                           ~.x[.x$lex.dur > 2, ] %>% 
                             filter (poor_health == "No", 
                                     SOB_walking == "No", 
                                     CLD         == "No")
                           )


# Calculate sex-specific Q5 ---------------------------------------------------------------------------------------------
data_expanded_cld <- 
  
  map(.x = data_expanded_cld, 
    
    ~.x %>% dplyr::group_by(sex) %>% 
                   dplyr::group_split() %>% 
                   map( ~ .x %>% 
                           dplyr::mutate(met_q5_sex = factor(quantcut(met, 5), 
                                                             labels = c("Q1", "Q2", "Q3", "Q4", "Q5")), 
                                         
                                         met4       = met/4, 
                                         metsd      = scale(met)
                                         )
                        ) %>%
            map_dfr( ~rbind(.x))
      )

# Shape -----------------------------------------------------------------------------------------------------------------
shape_cld <- map(.x = data_expanded_cld, 
                   
                   ~Cox_shape_strength_data(dataset                      = .x, 
                                             exposure_var_cat            = "met_q5_sex", 
                                             expo_type_shape             = TRUE,
                                             correct_regression_dilution = FALSE,
                                             adjustment_vars             = adjust, 
                                             print_model_info = FALSE) %>% 
                     
                     pluck(., 2) %>% 
                     dplyr::mutate(PA_resurv_mean = resurv_met_df$mean_met_resurvey, 
                                   analysis       = "2 years fu + poor health + SOB + CLD")
                   )




# Met4 --------------------------------------------------------------------------------------------------------------------
  
met_cont_cld <- map(.x = data_expanded_cld,
                   
         ~Cox_shape_strength_data(dataset                      = .x, 
                                   exposure_var_cont           = "met4", 
                                   expo_type_continuous        = TRUE,
                                   correct_regression_dilution = TRUE, 
                                   regression_dilution_ratio   = RDR,
                                   adjustment_vars             = adjust, 
                                   print_model_info = FALSE) %>% 
           
           pluck(., 2) %>% 
           dplyr::mutate(analysis = "2 years fu + poor health + SOB + CLD")
         )


# METSD -------------------------------------------------------------------------------------------------------------------

metsd_cld <- map(.x = data_expanded_cld,
                   
         ~Cox_shape_strength_data(dataset           = .x, 
                                  exposure_var_sd   = "metsd",
                                  expo_type_sd      = TRUE,
                                  correct_regression_dilution = TRUE,
                                  adjustment_vars   = adjust,
                                  print_model_info = FALSE) %>% 
            
           pluck(., 2) %>% 
           dplyr::mutate(analysis = "2 years fu + poor health + SOB + CLD")
         )
    
rm(data_expanded_cld)



```


# 6. HF and PHD co-occurrence 
```{r}


# Continue here ---------------------------------------------------------------------------------------------------------------

adjust <- c(ses_vars, lifestyle_vars) 

# Drop 
## 1. follow up time +
## 2. Poor health + 

data_expanded_co_hf_phd <- map(.x = data_expanded, 
                               ~.x[.x$lex.dur > 2, ] %>% 
                                 filter (poor_health == "No", 
                                         SOB_walking == "No", 
                                         CLD         == "No") %>% 
                                 #Define co-morbid HF and PHD 
                                 dplyr::mutate(co_hf_phd = ifelse(HF_combined_ep == 1 & PHD_combined_ep == 1, "Yes", "No")) %>% 
                                 filter(co_hf_phd == "No")
                              )


# Calculate sex-specific Q5 ---------------------------------------------------------------------------------------------
data_expanded_co_hf_phd <- 
  
  map(.x = data_expanded_co_hf_phd, 
    
    ~.x %>% dplyr::group_by(sex) %>% 
                   dplyr::group_split() %>% 
                   map( ~ .x %>% 
                           dplyr::mutate(met_q5_sex = factor(quantcut(met, 5), 
                                                             labels = c("Q1", "Q2", "Q3", "Q4", "Q5")), 
                                         
                                         met4       = met/4, 
                                         metsd      = scale(met)
                                         )
                        ) %>%
            map_dfr( ~rbind(.x))
      )

# Shape -----------------------------------------------------------------------------------------------------------------
shape_hf_phd <- map(.x = data_expanded_co_hf_phd, 
                   
                   ~Cox_shape_strength_data(dataset                      = .x, 
                                             exposure_var_cat            = "met_q5_sex", 
                                             expo_type_shape             = TRUE,
                                             correct_regression_dilution = FALSE,
                                             adjustment_vars             = adjust, 
                                             print_model_info = FALSE) %>% 
                     
                     pluck(., 2) %>% 
                     dplyr::mutate(PA_resurv_mean = resurv_met_df$mean_met_resurvey, 
                                   analysis       = "2 years fu + poor health + SOB + CLD + co-HF and PHD")
                   )




# Met4 --------------------------------------------------------------------------------------------------------------------
  
met_cont_hf_phd <- map(.x = data_expanded_co_hf_phd,
                   
         ~Cox_shape_strength_data(dataset                      = .x, 
                                   exposure_var_cont           = "met4", 
                                   expo_type_continuous        = TRUE,
                                   correct_regression_dilution = TRUE, 
                                   regression_dilution_ratio   = RDR,
                                   adjustment_vars             = adjust, 
                                   print_model_info = FALSE) %>% 
           
           pluck(., 2) %>% 
           dplyr::mutate(analysis = "2 years fu + poor health + SOB + CLD + co-HF and PHD")
         )


# METSD -------------------------------------------------------------------------------------------------------------------

metsd_hf_phd <- map(.x = data_expanded_co_hf_phd,
                   
         ~Cox_shape_strength_data(dataset           = .x, 
                                  exposure_var_sd   = "metsd",
                                  expo_type_sd      = TRUE,
                                  correct_regression_dilution = TRUE,
                                  adjustment_vars   = adjust, 
                                  print_model_info = FALSE) %>% 
            
           pluck(., 2) %>% 
           dplyr::mutate(analysis = "2 years fu + poor health + SOB + CLD + co-HF and PHD")
         )

rm(data_expanded_co_hf_phd)



```


## Bind all data for sensitivity analysis 

```{r}

shape      <- map(.x = seq_along(shape_fu2), 
                  ~c(shape_fu2[.x], 
                     shape_poorh[.x], 
                     shape_sob[.x], 
                     shape_cld[.x], 
                     shape_hf_phd[.x]
                     )
                  )

strng_cont <- map(.x = seq_along(met_cont_fu2), 
                  ~c(met_cont_fu2[.x], 
                     met_cont_poorh[.x], 
                     met_cont_sob[.x], 
                     met_cont_cld[.x], 
                     met_cont_hf_phd[.x]
                     )
                  )

metsd      <- map(.x = seq_along(metsd_fu2),
                  ~c(metsd_fu2[.x], 
                     metsd_poorh[.x], 
                     metsd_sob[.x], 
                     metsd_cld[.x], 
                     metsd_hf_phd[.x]
                     )
                  )
```


## Plot data for sensitivity analysis 

```{r}


# select which columns we want, and give them appropriate names
plotdata   <- list()
events_sum <- list()

hr_cont_labels <- list()
met4_labels    <- list()
metsd_labels   <- list()

for (sh in seq_along(shape)) {
  
    plotdata[[sh]] <- map(.x = shape[[sh]], ~data.frame(RF_Level = resurv_met_df$mean_met_resurvey, 
                                                        Estimate = .x$estimate, 
                                                        StdErr   = .x$quasiSE, 
                                                        Events   = .x$n, 
                                                        exp_est  = exp(.x$estimate)
                                                        ) %>% 
                                             `row.names<-`(NULL)
                          )
    
    # Get labels for number of events 
    events_sum[[sh]] <- map(.x = shape[[sh]], ~paste0("(n=", 
                                                      prettyNum(sum(.x$n), 
                                                                big.mark   = ",", 
                                                                scientific = FALSE), 
                                                      ")")
                            )
    
    # Get labels for continuous 
    met4_labels[[sh]] <- 
             map(.x = strng_cont[[sh]], 
                 
                 ~.x %>% 
                   dplyr::mutate(term_level  = "4 MET-hour/day", 
                                 hr_ci = paste0(format(round(hr_corrected,  2), nsmall = 2L), " (",
                                                format(round(lci_corrected, 2), nsmall = 2L), " - ", 
                                                format(round(uci_corrected, 2), nsmall = 2L), ")")) %>% 
                   select(term, term_level, hr_ci, analysis)
                 )
    
    # Get labels for metsd
    metsd_labels[[sh]] <- 
             map(.x = metsd[[sh]], 
                 
                 ~.x %>%  
                   dplyr::mutate(term_level  = "1 SD MET-hour/day", 
                                 hr_ci = paste0(format(round(hr_corrected,  2), nsmall = 2L), " (",
                                                format(round(lci_corrected, 2), nsmall = 2L), " - ", 
                                                format(round(uci_corrected, 2), nsmall = 2L), ")")) %>% 
                   select(term, term_level, hr_ci, analysis)
                 )
    
    # Bind met4 and metsd 
    hr_cont_labels[[sh]] <- 
             map2(.x = met4_labels[[sh]], 
                  .y = metsd_labels[[sh]], 
                  
                  ~rbind(.x, .y))
    
} 
 

headers <- c("A: Excluding the first two years\nof follow-up",
             "B: (A) + excluding poor self-rated health",
             "C: (B) + excluding shortness of breath\n on walking",
             "D: (C) + excluding chronic \nrespiratory disease",
             "E: (D) + excluding co-occurring HF\nand PHD")


## Subheadings for panels: A. Heart failure and B. Pulmonary heart disease 
outcome <- list(c("Heart failure", rep(NA, 4)),
                c("Pulmonary heart disease", rep(NA, 4)))

yaxisL  <- list(c("Hazard ratio (95% CI)", rep(NA, 4)),
                c("Hazard ratio (95% CI)", rep(NA, 4)))

xaxisL  <- list(rep(NA, 5), 
                rep("Usual total physical activity, MET-hour/day", 5))



# set up the Jasper page
type <- "PNG"
SetPage(orient         = "LANDSCAPE",
        perpage        = 10,
        type           = type, 
        png_bg = "white",
        page_width     = 18,
        page_height    = 12,
        page_dpi       = 600,
        page_pointsize = 11.5,
        suppress.date  = TRUE,
        titlespace     = 0.13, 
        footerspace    = 0.06,
        filestem       = "eFigure 4 - Sensitivity analysis PA (exclusion)", 
        footer.cex      = 1.5, 
        footer    = "Analyses were stratified by age-at-risk, sex, and study area and adjusted for income, education, occupation, alcohol, smoking, sedentary time, ephysema, bronchitis and COPD (where applicable)
        
        \n \n")


# loop over the panels in a slightly strange order, to match data
for (j in seq_along(plotdata)) {
  
  for (k in seq_along(plotdata[[1]])) {
    
 
	# do the linear plot for this set of data
	LinearPlot(plotdata[[j]][[k]], 
	           new.plot          = TRUE, 
	           mainfont          = 1,   
	           YLogScale         = TRUE, 
	           ExponentiateDataOnPlot = TRUE,
	           boxparm.stderr    = 0.025, 
	           xlim              = c(10,30),  
	           xticks            = seq(10,30, 5), 
	           ylim              = c(0.25, 2), 
	           yticks            = c(0.25, 0.5, 1, 2), 
	           margins           = c(5,5,3,2),  
	           xticklabs.cex     = 0.9, 
	           yticklabs.cex     = 0.9,
	           PointLabelsTop    = "exp_est",
	           PointLabelsBottom = "Events",
	           PointLabelsCEX    = 0.8, 
	           TruncateAtPlotLims = FALSE,
	           CIsOnTop           = TRUE)
	
	# add axis labels
	AxisLabels(ylab=yaxisL[[j]][k], 
	           xlab=xaxisL[[j]][k], 
	           mainfont=0.9)
	
	par(xpd=NA)
	
	
	# add the column heading
	
	if(j == 1) {
	 text(x=20, y=log(3.2), labels=headers[k], font=2, cex = 1)
	}
	
	 text(x=20, y=log(1.9), labels=events_sum[[j]][[k]], font=1, cex = 1)
	 text(x=10,  y=log(2.2), labels= outcome[[j]][[k]], font=2, adj=c(0,0), cex = 1.2)
	
	
	# Add labels for HR 
	text(x      = 10, 
	     y      = log(0.26), 
	     labels = paste0("Per usual level\n", paste0(hr_cont_labels[[j]][[k]]$term_level, ":", collapse = "\n")), 
	     font   = 1, 
	     cex    = 0.8, 
	     adj    = c(0, 0)
	     )
	
	text(x      = 20.5, 
	     y      = log(0.26), 
	     labels = paste0("HR (95% CI)\n", paste0(hr_cont_labels[[j]][[k]]$hr_ci, collapse = "\n")), 
	     font   = 1, 
	     cex    = 0.8, 
	     adj    = c(0, 0)
	     )

  }
  
}

## Plot title 
##Plot title

new.plot=TRUE

text(x      = -45, 
     y      = log(90), 
     font   = 2, 
     cex    = 1.2,
     adj    = c(0.5, 0),
     labels = "eFigure 4: Associations of total physical activity with heart failure and pulmonary heart disease after sequential exclusion of participants with prior diseases")


closeFile(type)




```


