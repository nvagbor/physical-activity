---
title: "Total physical activity with HF and PHD"
author: "Valirie N. Agbor"
date: "`r Sys.Date()`"
output: html_document
---


# Workflow --
1. Import packages and data 
2. Data wrangling
3. Determine the number of participants included at baseline and perform exclusions 
4. Explore variations in levels of physical activity by sex and area 
5. Create Table 1 (Adjust means and proportions using direct standardisation) 
6. Perform univariate analyses 
7. Perform multivariable cox regression analysis 
   - Modelling and variable selection
   - Age-sex-specific analysis 
   - Assessing model assumption 
8. Perform subgroup analyses 
9. Mediation analyses
10. Perform sensitivity analyses 


# Load packages, data and custom functions --

```{r Import packages and data}

rm (list = ls())

pacman::p_load(
  DirectStandardisation, compareGroups, Epi, lubridate, qvcalc, broom,
  tidyverse, purrr, stringr,forcats, skimr, gtools, lmtest,
  Jasper, ggplot2, gridExtra, survival,survminer)

#loading baseline data
file.dir <- "K:/kadoorie/Staff_Folders/Valirien/DAR-2022-00245-V1 - Copy/"
baseline <- read_csv(paste0(file.dir, "data_baseline_questionnaires.csv"), col_types = cols())
endpoint <- read_csv(paste0(file.dir, "endpoints.csv"), col_types = cols())

knitr::opts_chunk$set(echo = FALSE, root.dir = "J:/Physical activity and HF/R codes")
```

The `make_standardised_ckb_data` function is a wrapper for the DirectStandardisation package 

```{r Load custom functions}

fun.dir <- "J:/DPhil/First year/HF prognosis/Data analysis/My functions/"
fun.name <- c(
  "recode01_fn.R", 
  "make_standardised_baseline_ckb_data.R", 
  "df_transpose.R", 
  "make_quartile_var_labels.R",
  "string_add_and.R",
  #Line plots 
  "ggLinePlot.R", "Make_LineData_Mean.R", "Make_LineData_Prop.R",
  # Cox regression 
  "standardised incidence.R", "non_linearity_test.R",
  # Assess variables that improve model fit
  "lrtest_model_fit.R",
  "Cox_shape_strength_data_fn.R",
  "regresssion_dilution_ratio_peto.R", 
  "regresssion_dilution_ratio_rosner.R",
  "trend_het_test.R",
  "Cox_interaction.R",
  "lrtest_change_chi2.R",
  "order_row.R",
  "add_table_header.R"
)

# Load functions 
for(k in fun.name){source(paste0(fun.dir, k))}

```


```{r}

# Number of participants at baseline 
format(nrow(baseline), big.mark=",", scientific=FALSE)

```

# Data wrangling --

```{r Endpoint data}

# Endpoint headers
end_new_names <- c("PHD", "HF","RD", "COPD", "Acute_MI", "IHD")
end_pattern   <- c("ep_CKB0012", "ep_CKB0080", "ep_CKB0032", "ep_CKB0033", "ep_CKB0004", "ep_CKB0003")

# select and rename relevant endpoints
endpoint <- select(endpoint, csid, contains(end_pattern))

for (i in 1:length(end_new_names)){
  colnames(endpoint) <- str_replace_all (names(endpoint), end_pattern[i], end_new_names[i])
}

# Merged outcome to baseline data 
merged_data <- merge(baseline, endpoint, by = "csid", all=TRUE)
 
```

Variables with missing data

```{r Explore dataset for missing data}

# skim(merged_data)
detach("package:skimr", unload = TRUE)

```


## Perform exclusion 

```{r Exclusion}

# Variables for exclusion 
merged_data <- 
  merged_data %>% 
  dplyr::mutate(
    missing_bmi = ifelse(is.na(bmi_calc), 1, 0),
    rhd_present = case_when(rheum_heart_dis_diag == 1 | rheum_heart_dis_now == 1 ~ 1, TRUE ~ 0), 
    chd_present = case_when(chd_diag == 1 | chd_now == 1 ~ 1, TRUE ~ 0),
    stroke_present = case_when(stroke_or_tia_diag == 1 | stroke_or_tia_now == 1 ~ 1, TRUE ~ 0),
    cancer_present = case_when(cancer_diag == 1 | cancer_now == 1 ~ 1,TRUE ~ 0)
    )

# Numbers excluded 
n_excluded <- map(
  .x=c("missing_bmi", "rhd_present", "chd_present", "stroke_present", "cancer_present"), 
  ~reframe(merged_data, n=n(), .by=all_of(.x)) %>% slice(-1) %>% pull(n)
  )

merged_data <- 
  filter(
    merged_data, 
    missing_bmi!=1, rhd_present!=1, chd_present!=1, stroke_present!=1, cancer_present!=1    
  )

# New number of participants 
format(nrow(merged_data), big.mark=",", scientific=FALSE)

512724 - 486374
```


## Recode variables                                       
**Quintiles of physical activity:** c("[0,8.72]", "(8.72,14.2]", "(14.2,21.8]", "(21.8,33.2]", "(33.2,133]")

```{r Data wrangling - Baseline characteristics}

# Main exposure 
# Calculate quantile of physical activity by sex 
# Derive occupational and non-occupational MET and create Q5
merged_data <- mutate(
    merged_data,
    met_q5=factor(quantcut(met, 5), labels=paste0("Q", 1:5)), 
    met_work_q5=factor(quantcut(met_work, 5), labels=paste0("Q", 1:5)), 
    met_nonwork=met - met_work, 
    met_nonwork_q5=factor(quantcut(met_nonwork, 5), labels=paste0("Q", 1:5))
    )

#1. Demographic characteristics: ------
# Age, sex, area, region, marital status, education, household income, occupation

# Load custom function to recode binary variables labelled 0 and 1
source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/recode01_fn.R")

 merged_data <- 
   merged_data %>%
   mutate(
     age = age_at_study_date_x100/100, # Age in years 
     #5-year age groups
     age5=cut(age, 
              breaks=seq(30, 80, 5), 
              include.lowest=TRUE, 
              right=FALSE, 
              labels=c("30-34", "35-39", "40-44", "45-49", "50-54",
                       "55-59", "60-64", "65-69", "70-74", "75-79")),
     #10 years age groups 
     age10=cut(age, 
               breaks= seq(30, 80, 10), 
               include.lowest=TRUE,
               right=FALSE, 
               labels=c("30-39", "40-49", "50-59", "60-69", "70-79")), 
      
      age_group3=factor(
        case_when(age<50~"Below 50", 
                  age>=50 & age<70~"50-69", 
                  age>=70~"70+")),
      
      age65=factor(ifelse(age>=65, "65 and over", "Below 65")),
      sex=factor(ifelse(is_female==1, "Women", "Men")), 
      area=factor(region_is_urban, levels=c(1, 0), labels=c("Urban", "Rural")), 
      region=factor(
        region_code,
        levels=c(12, 16, 26, 36, 46, 52, 58, 68, 78, 88),
        labels = c("Qingdao", "Harbin", "Haikou", "Suzhou", "Liuzhou",
                   "Sichuan", "Gansu", "Henan", "Zhejiang", "Hunan")), 
      
      #Marital status 
      marital_status_married=as.factor(ifelse(marital_status==0, "Married", "Other")),
  
      #Level of education
      edu = factor(case_when(highest_education == 0 ~ "No formal", 
                             highest_education == 1 ~ "Primary", 
                             highest_education == 2 ~ "Middle", 
                             highest_education >= 3 ~ "High school or higher"), 
                   
                   levels = c("No formal", "Primary", "Middle", "High school or higher")),
      
      edu_bin = factor(case_when(edu == "No formal" ~ "No formal", 
                                 edu == "Primary"   ~ "Primary", 
                                 TRUE ~ "Middle school or higher")),
      
      #Household income 
      h_income = factor(case_when(household_income <= 2 ~ "<10k", 
                                  household_income == 3 ~ "10k-29.9k", 
                                  household_income == 4 ~ "30k-34.9k", 
                                  TRUE ~ ">=35k"), 
                        
                        levels = c("<10k", "10k-29.9k", "30k-34.9k", ">=35k")),
      
      h_income_bin = factor(ifelse(household_income <= 2 & !is.na(household_income), "<10k", "10k and over")),
      
      #Occupation 
      occupation_fct = as.factor(occupation), 
      occupation = fct_recode(occupation_fct, agriculture_and_related   = "0",  
                                              factory_worker            = "1", 
                                              administrator_or_manager  = "2", 
                                              professional_or_technical = "3", 
                                              sales_and_service_workers = "4", 
                                              retired                   = "5", 
                                              housewife_or_husband      = "6", 
                                              self_employed             = "7", 
                                              unemployed                = "8", 
                                              other_or_not_stated       = "9"),
      
      agric_factory = factor(case_when(occupation == "agriculture_and_related" | 
                                       occupation == "factory_worker" ~ "Agriculture or factor worker", 
                                       TRUE ~ "Others"), 
                             
                             levels = c("Agriculture or factor worker", "Others")), 
      
      occu_farmer = factor(ifelse(occupation == "agriculture_and_related", "agriculture_and_related", "Others")))

 

#2. Lifestyle factors: ---
 
#Ever-regular smokers, weekly drinkers, total physical activity 

merged_data %>% 
      mutate(
        smoking_status = factor(
          case_when(smoking_category == 1 ~ "Never smoker", 
                    smoking_category == 2 | smoking_category == 3 ~ "Ever-smoker", 
                    TRUE ~ "Current")), 
        
        ever_reg_smoker = factor(ifelse(smoking_status != "Never smoker", "Ever regular", "Never")),
        
       alcohol_category = as.factor(alcohol_category),
       alcohol_category = fct_recode(alcohol_category, "Never regular drinkers" = "1", 
                                                       "Ex-regular drinkers"    = "2", 
                                                       "Reduced intake"         = "3", 
                                                       "Occasional drinkers"    = "4", 
                                                       "Occasional drinkers"    = "5", 
                                                       "Regular drinker"        = "6"), 
       
       alcohol_recode  = factor(case_when (alcohol_category == "Regular drinker"        ~ "Current",
                                           alcohol_category == "Ex-regular drinkers"    ~ "Ex-drinkers",
                                           alcohol_category == "Never regular drinkers" ~ "Never", 
                                           TRUE ~ "Others"
                                           ),
                                
                                levels = c("Current", "Ex-drinkers", "Never", "Others")), 
       
       current_drinkers = factor(ifelse(alcohol_category == "Regular drinker", "Yes", "No"), 
                                 levels = c("Yes", "No")),
       
       alcohol_subgroup = 
         factor(
           case_when(
              alcohol_category == "Never regular drinkers" ~ "Never drinkers", 
              alcohol_category == "Ex-regular drinkers" | alcohol_category == "Reduced intake" ~ "Ex-drinkers", 
              alcohol_category == "Occasional drinkers" ~ "Occasional drinkers", 
              alcohol_category == "Regular drinker" ~ "Current drinkers", 
              TRUE ~ NA_character_),
           levels = c("Never drinkers", "Ex-drinkers", "Occasional drinkers", "Current drinkers")),
       
       sed_time_hr = tv_reading_hours/7,
       waist_circ_cm = waist_mm/10, 
       fat_percent = fat_percent_x10/10,
       bmi_cat = factor(
         case_when(
           bmi_calc  < 18.5 ~ "Underweight (< 18.5)", 
           bmi_calc >= 18.5 & bmi_calc < 23 ~ "Normal (18.5 to <23)", 
           bmi_calc >= 23 & bmi_calc < 25 ~ "Overweight (23 to <25)", 
           bmi_calc >= 25 ~ "Obesity (25+)", 
           TRUE ~ as.character(NA)), 
         
         levels = c(
           "Underweight (< 18.5)", 
           "Normal (18.5 to <23)", 
           "Overweight (23 to <25)", 
           "Obesity (25+)"
           )
         ), 
       
       obese = factor(
         case_when(bmi_cat == "Obesity" ~ "Yes", 
                   bmi_cat != "Obesity" ~ "No",
                   TRUE ~ as.character(NA)), levels = c("Yes", "No"))) ->  merged_data 

 
   #4. Self reported health and prevalent disease

lab_yesno <- c("Yes", "No")

# Recode 0 and 1 variables 
var_names_old <- list("has_diabetes", "has_copd", "tb_diag", "emph_bronc_diag", "asthma_diag", 
                       "cirrhosis_hep_diag", "rheum_arthritis_diag", "kidney_dis_diag")

var_names_new <- list("diabetes","copd", "tuberculosis", "emphysema_bronchitis", 
                      "asthma", "cirr_hepb", "rheum_art", "kidney_dis")

 
if (length(var_names_old) != length(var_names_new) ) {
  
  warning("Length of vectors do not match.\nCheck that the old and new names match")
  
}

for (i in seq_along(var_names_old)) {
  
  merged_data <- my_recode01_fn(data       = merged_data, 
                              col_name_old = var_names_old[[i]], 
                              col_name_new = var_names_new[[i]], 
                              to_factor    = TRUE)
  
}


merged_data <- 
  merged_data %>%  
  mutate(                 
     HTN = factor(ifelse(hypertension_diag == 1          |
                         used_blood_pressure_drugs == 1 |
                         sbp_mean >= 140               |
                         dbp_mean >= 90, "Yes", "No"),
                  levels = lab_yesno),

     emphy_bronc_asthma = factor(ifelse(emphysema_bronchitis == "Yes" |
                                        asthma == "Yes", "Yes", "No"), levels = lab_yesno),

     CLD = factor(
       case_when(emphy_bronc_asthma == "Yes" |
                                  tuberculosis == "Yes" | copd == "Yes" ~ "Yes",

                            TRUE ~ "No"), levels = lab_yesno),

     SOB_walking = factor(ifelse(walking_short_of_breath == 0, "Yes", "No"), levels = lab_yesno),                         
     
     # Others
     
     self_rated_health = factor(case_when(self_rated_health <= 1 ~ "Excellent or good", 
                                          self_rated_health == 2 ~ "Fair", 
                                          self_rated_health == 3 ~ "Poor")),
     
     poor_health = factor(ifelse(self_rated_health == "Poor", "Yes", "No"))) #For summary table 



rm("baseline", "endpoint")



```


# Descriptive statistics

Baseline characteristics by levels of TPA

```{r}

# Numeric variables ------
numeric_vars <- c( 
  "met", 
  "sbp_mean", 
  "dbp_mean", 
  "heart_rate_mean", 
  "bmi_calc", 
  "waist_circ_cm", 
  "fat_percent"
  )

numeric_vars_labels <- c(
  "Total physical activity, 
  MET-hour/day", 
  "SBP, mmHg", 
  "DBP, mmHg",  
  "Resting heart rate, bpm", 
  "BMI, kg/m2", 
  "Waist circumference, cm", "Body fat percentage, %"
)

# Categorical variables ---
cat_vars <- c( 
   "marital_status_married", "edu_bin", "h_income_bin", "agric_factory",
   "HTN", "diabetes", "copd", "emphysema_bronchitis", 
   "asthma", "SOB_walking", "poor_health"
  )

cat_var_labels <- c(
  "Married", "Level of education", "Annual household income", "Farming",
  "Hypertension", "Diabetes", "COPD", "Emphysema or bronchitis", "Asthma",
  "Shortness of breath on walking", "Poor self-rated health"
  )


# Adjustment 
adjust_vars  <- c("age5", "sex", "region")
main_expo <- "met_q5"


# Checkpoint
stopifnot(length(numeric_vars) == length(numeric_vars_labels)) 
stopifnot(length(cat_vars) == length(cat_var_labels)) 


# Standardise numeric and categorical variables ---
df_table1 <- make_standardised_ckb_data(
   dataset=merged_data, 
   numeric_vars=numeric_vars,
   numeric_vars_labels=numeric_vars_labels,
   categorical_vars=cat_vars, 
   main_exposure=main_expo, 
   adjustment_variables=adjust_vars)  
  
#Filter unwanted categories 
df_table1 <- filter(df_table1, !grepl("_Other|_Middle.school.or.higher|_Primary|_10k.and.over|_No", exposure))

# Standardise age ---
df_table1_age <- make_standardised_ckb_data(dataset = merged_data, 
                           numeric_vars = "age",
                           numeric_vars_labels = "Age, mean (SD), years",
                           main_exposure = main_expo, 
                           adjustment_variables = c("sex", "region"))

df_table1 <- rbind(df_table1, df_table1_age)


# Alcohol and smoker by sex ---
sex_groups <- levels(merged_data$sex)
sex_specific_vars <- c("ever_reg_smoker", "current_drinkers")
  
sex_cig_alc <- map_dfr(
  .x = sex_groups, 
  ~make_standardised_ckb_data(
            dataset = merged_data %>% filter(sex == .x),
            categorical_vars = sex_specific_vars,
            adjustment_variables = c("age5", "region"), 
            main_exposure = main_expo, 
            sex_specific_analysis = TRUE, 
            sex_var = "sex")) %>% 
  filter(!grepl("_No|_Never", exposure))

df_table1 <- rbind(df_table1, sex_cig_alc)

# Standardise sex and area (urban and rural) ----
adjust_vars2 <- list(sex=c("age5", "region"), area=c("age5", "sex"))
cat_vars2 <- c("sex", "area")

df_table1_sex_area <- 
    map2_dfr(
      .x = cat_vars2,
      .y = adjust_vars2,
      ~make_standardised_ckb_data(
        dataset = merged_data, 
        categorical_vars = .x,
        main_exposure = main_expo, 
        adjustment_variables = .y)
    ) %>% 
  filter(grepl("_Women|_Rural", exposure))

df_table1 <- rbind(df_table1, df_table1_sex_area)

## Add number of participants 
N_cats <- reframe(
    merged_data, 
    N=format(n(), big.mark=",", scientific=FALSE), 
    .by=all_of(main_expo)) %>% 
  rename("exposure" = all_of(main_expo)) %>% 
  df_transpose(.) %>% #custom function 
  dplyr::mutate(all=format(nrow(merged_data), big.mark=",", scientific=FALSE))

(df_table <- rbind(N_cats, df_table1))
```

# Cox regression --
Time-scale = Time in study, 
Analysis stratified by age-at-risk

## Select variable for Cox regression 

```{r}

numeric_covs <- c("age", 
                  "heart_rate_mean", 
                  "waist_circ_cm", 
                  "bmi_calc", 
                  "sed_time_hr"
                  )

ordinal_covs <- c("age10", "h_income", "edu")

nominal_covs <- c("area", 
                  "agric_factory", 
                  "smoking_status", 
                  "alcohol_recode", 
                  "copd", 
                  "emphysema_bronchitis", 
                  "diabetes", 
                  "HTN",
                  "bmi_cat")

strata_vars <- c("sex","region")
expos       <- c("met_q5", "met")
expos2      <- c("met_nonwork", "met_nonwork_q5", "met_work", "met_work_q5")
exclusion   <- c("poor_health", "SOB_walking", "CLD")
exit_status <- c("HF_combined_ep", "PHD_combined_ep")

date_vars   <- c("HF_combined_datedeveloped", 
                 "PHD_combined_datedeveloped", 
                 "study_date", 
                 "censoring_date", 
                 "dob_anon") 

regress_vars <- c(
      "csid", 
      numeric_covs, 
      ordinal_covs, 
      nominal_covs, 
      strata_vars, 
      expos,  
      expos2,
      exclusion, 
      exit_status,
      date_vars)

df_reduced <- merged_data %>% select(all_of(regress_vars))

```


## Create sex-specific MET quintiles 

```{r}

df_reduced <- 
  df_reduced %>% 
     dplyr::group_by(sex) %>% 
     dplyr::group_split() %>% 
     map_dfr( 
       ~dplyr::mutate(
         .x, 
         met_q5_sex = factor(quantcut(met, 5), labels = paste0("Q", 1:5)), 
         met_work_q5_sex = factor(quantcut(met_work, 5), labels = paste0("Q", 1:5)), 
         met_nonwork_q5_sex = factor(quantcut(met_nonwork, 5), labels = paste0("Q", 1:5)))
       ) 
     
```

## Lexis Expansion
To split the data by age-at-risk bands 
-

```{r Expand data}

source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/standardised incidence.R")

# Vectors of necessary labels 
exit_date_lab   <- c("HF_combined_datedeveloped", "PHD_combined_datedeveloped")
exit_status_lab <- c("HF_combined_ep", "PHD_combined_ep")

data_expanded <- map2(
    .x = exit_status_lab, 
    .y = seq_along(exit_status_lab),
     ~lexis_expansion(
       data          = df_reduced, 
       birth_date    = "dob_anon", 
       entry_date    = "study_date", 
       exit_date     = exit_date_lab[.y],
       agegrp_breaks = c(30, 50, 60, 70, 80, 100),
       status        = exit_status_lab[.y]
       ) 
    ) 

# Five-year age at risk groups
data_expanded <- map(
  .x = data_expanded,
  ~dplyr::mutate(
    .x,
    age_lexis5 = cut(age_lexis, breaks=seq(30, 80, 5), include.lowest=TRUE, right=FALSE))
  )

# Descriptives: Number of events and length of follow-up 
map(.x = data_expanded, ~ summary.Lexis(.x, timeScales = TRUE))

```

## Run cox regression with sequential adjustments

- Numeric variables (with missing data):  fat_percent, mean_temp

## Assess departure from linearity

```{r}

source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/non_linearity_test.R")

numeric_covs <- c("age", "heart_rate_mean", "waist_circ_cm", "bmi_calc", "sed_time_hr")
ordinal_covs <- c("age10", "h_income", "edu")
nominal_covs <- c("agric_factory", "smoking_status", "alcohol_recode", 
                  "copd", "emphysema_bronchitis", "diabetes", "HTN")
main_cov     <- "met_q5_sex"

# Create new variables -----------
data_expanded <- map(
  .x = data_expanded,
  ~mutate(
    .x, 
    across(.cols=numeric_covs[-1], 
           ~factor(quantcut(.x, 4), labels = paste0("Q", 1:4)),
           .names="{.col}_Q4"),
    age_sq = age^2
    ))

# Relabel quintiles to be more informative for forest plots 

# Generate labels 
# Only use labels for HF

num_var_q     <- paste0(numeric_covs[-1], "_Q4")
num_var_new   <- numeric_covs[-1]

q_numeric_cov <- map2(
  .x=num_var_q,
  .y=num_var_new,
  ~data_expanded[[1]] %>% 
    dplyr::group_by(.data[[.x]]) %>% 
    summarise(
      var_min=min(.data[[.y ]]), 
      var_max=max(.data[[.y ]])) %>% 
    dplyr::mutate(
      q_level=.data[[.x ]],
      q_labels=case_when(
        q_level=="Q1"~paste0(q_level, " (<", round(var_max), ")"),
        q_level=="Q4"~paste0(q_level, " (", round(var_min), "+)"),
        TRUE~paste0(q_level, " (",round(var_min), " to <", round(var_max), ")")
        )
      ) %>%
    pull(q_labels)
  )

# Relabel variables 
for (df in seq_along(data_expanded)){
  for (vi in seq_along(num_var_q)) {
  
  data_expanded[[df]][ , num_var_q[[vi]] ] <- 
    factor(data_expanded[[df]][[num_var_q[[vi]]]], labels = q_numeric_cov[[vi]])
  
  }
}

```


## Modelling 

Do not adjust for marital status as most participants in the CKB are married. 

```{r}

# Variable grouping 
fu_time        <- "lex.dur"
events_i       <- "lex.Xst"
main_cov       <- "met_q5_sex" 
stratify       <- c("age_lexis5", "sex", "region")
ses_vars       <- c("h_income", "edu", "agric_factory")
lifestyle_vars <- c("smoking_status", "alcohol_recode", "sed_time_hr", "I(sed_time_hr^2)")
phys_measure   <- c("heart_rate_mean", "I(heart_rate_mean^2)", 
                    "waist_circ_cm", "I(waist_circ_cm^2)",
                    "bmi_calc", "I(bmi_calc^2)")
med_history    <- c("copd", "emphysema_bronchitis", "diabetes", "HTN")

```

## Main effect model and model assumptions
Model adjusted for 

**Minimal adjustment**
1. stratified by age at risk (5-year bands), sex, and region

**Further adjustment**
3. SES (income, education and manual work)
4. Lifestyle (smoking, alcohol, and sedentary time)
5. Physical measurement (resting heart rate)

> Note: 
No adjustment was done for diabetes, adiposity, and HTN as these were
considered to be intermediate factors. 


> Custom function for stratified Cox regression 

The function runs
1. Regression by categorical exposure and obtains FAR. 
2. Regression by continuous exposure and corrects for regression dilution if specified

Returns a named list of
1. Model object that can be used for further analysis
2. Model summary
2. Dataframe of relevant model statistics
  **For categorical exposure**
    - Original parameters
    - FAR variance and se (if specified)
    - number of events per exposure category
  **For continuous exposure (including standard deviation)**
    - Original regression paraters
    - beta and se corrected for regression dilution (if specified) 


## Import resurvey data and calculate RDR 

### RDR by type of physical activity analysis 
Use MacMahon Peto's estimate rather than Rosner methods since physical activity is right skewed. 

```{r}

resurvey1 <- read_csv(paste0(file.dir, "data_resurvey1_questionnaires.csv"), col_types = cols())
resurvey2 <- read_csv(paste0(file.dir, "data_resurvey2_questionnaires.csv"), col_types = cols())

n_resurvey_sample  <- map(list(resurvey1, resurvey2), ~nrow(.x)) # Original resurvey sample sizes --
csid_baseline_data <- merged_data$csid # Get id for those included in baseline survey --

# Define non-work  
resurvey1$met_nonwork <- resurvey1$met - resurvey1$met_work
resurvey2$met_nonwork <- resurvey2$met - resurvey2$met_work

# Variable to calculate RDR --
exposures <- c("met", "met_work", "met_nonwork")
main_covs <- c("met_q5", "met_work_q5", "met_nonwork_q5")    

RDR_peto <- list()
RDR_Rosner_ci <- list()
RDR_Rosner_est <- list()
resurv_merged_df <- list()
resurvey_var_data <- list()  # Get dataframe for resurvey variable

for (j in seq_along(exposures)){
   
    var_cont   <- exposures[j]
    var_cat    <- main_covs[j]
    
    # Merge baseline and resurvey datasets--
    resurv_merged_df[[j]] <- select(
      df_reduced, 
      csid, study_date, age, sex, area, region, 
      met, # Will be used for downstream analyses
      all_of(c(var_cont, var_cat))) %>% 
      left_join(.,  
        resurvey1 %>% 
           dplyr::transmute(
             csid     = csid, 
             age_rs1  = age_at_study_date_x100/100,
             var_rs1  = .data[[var_cont]],             # Rename exposure
             date_rs1 = study_date),
        by ="csid") %>% 
      left_join(., 
        resurvey2 %>% 
           dplyr::transmute(
             csid     = csid, 
             age_rs2  = age_at_study_date_x100/100,
             var_rs2  = .data[[var_cont]], 
             date_rs2 = study_date), 
        by ="csid") %>% 
      dplyr::mutate(
        resurv_ave = case_when(
          !is.na(var_rs1) & !is.na(var_rs2) ~ (var_rs1 + var_rs2)/2,
          is.na(var_rs1) & !is.na(var_rs2) ~ var_rs2, 
          !is.na(var_rs1) & is.na(var_rs2) ~ var_rs1), 
        time_to_rs1 = interval(study_date, date_rs1)/dyears(1), 
        time_to_rs2 = interval(study_date, date_rs2)/dyears(1))  
    
    # Calculate RDR (Peto's method) --
    resurv_var_df <- reframe(
      resurv_merged_df[[j]], 
      mean_var_baseline=mean(.data[[var_cont]], na.rm=TRUE),
        mean_resurvey1=mean(var_rs1, na.rm=TRUE),
        mean_resurvey2=mean(var_rs2, na.rm=TRUE), 
        mean_var_resurvey=mean(resurv_ave, na.rm=TRUE),
        min_var_baseline= min(.data[[var_cont]], na.rm=TRUE),
        max_var_baseline=max(.data[[var_cont]], na.rm=TRUE), 
      .by=all_of(var_cat)
      ) %>%
      dplyr::mutate(
        baseline_group=case_when(
          .data[[var_cat]]=="Q1"~paste0(.data[[var_cat]], " (<", 
                                        format(round(max_var_baseline, j), nsmall=j), ")"),
          .data[[var_cat]]=="Q5"~paste0(.data[[var_cat]], " (",  
                                        format(round(min_var_baseline, j), nsmall=j), "+)"),
          TRUE~paste0(
            .data[[var_cat]], " (",  
            format(round(min_var_baseline, j), nsmall=j), " to <",
            format(round(max_var_baseline, j), nsmall=j), ")"))
        )
    
    RDR_peto[[j]] <- rdr_peto(
      dataset=resurv_var_df, 
      baseline_var="mean_var_baseline", 
      resurvey_var="mean_var_resurvey")
    
    # Rosner RDR --
    RDR_Rosner_list <- rdr_rosner(
       dataset=resurv_merged_df[[j]], 
       baseline_var=var_cont, 
       resurvey_var="resurv_ave", 
       adjustment_variables=c("age", "sex", "region"))
    
    RDR_Rosner_ci[[j]] <- RDR_Rosner_list$df_model$est_ci
    RDR_Rosner_est[[j]] <- RDR_Rosner_list$rdr
    
    # Summary data for subsequent analyses --
    summ_resurv_temp <- reframe(
      resurv_merged_df[[j]], 
      resurvey_Qmean=mean(resurv_ave, na.rm=TRUE), 
      .by=all_of(var_cat)) %>% 
      mutate(
        exposure=as.character(.data[[var_cat]]), 
        expo_name=var_cont) %>% 
      select(!all_of(var_cat))
    
    resurvey_var_data[[j]] <- summ_resurv_temp

   } 

# Get Met resurvey data for further analysis -- 
resurv_merged_met <- resurv_merged_df[[1]]

rm(resurvey1, resurvey2, resurv_merged_df) 


```


## Fit Cox models 
Using custom function
Run models for all types of physical activities. 
**Work and non-work PA were mutually adjusted for each other. 
```{r}

main_covs <- c("met_q5_sex", "met_work_q5_sex", "met_nonwork_q5_sex")
adjustment_variables <- list(
  met=c(ses_vars, lifestyle_vars), 
  met_work=c(ses_vars, lifestyle_vars, "met_nonwork"), 
  met_nonwork=c(ses_vars, lifestyle_vars, "met_work")
)

#--
m_final <- list()
FAR <- list()

for(aa in seq_along(data_expanded)){
  for (ee in seq_along(main_covs)){
  
  EName <- names(adjustment_variables)[ee]
  OName <- c("hf", "phd")[aa]
  
  # Fit regression--
  m_final[[OName]][[EName]] <- Cox_shape_strength_data(
      dataset=data_expanded[[aa]], 
      exposure_var_cat=main_covs[ee],
      expo_type_shape=TRUE,
      adjustment_vars=adjustment_variables[[ee]], 
      print_model_info=FALSE,
      stratify_vars=c(stratify))
  
  # # Add quantile-specific resurvey means to data for plotting--
  FAR[[OName]][[EName]] <- inner_join(
    m_final[[OName]][[EName]]$dataframe, 
    resurvey_var_data[[ee]], by="exposure")
  }
}


## Assess Cox PH assumption --
# schoen_resid_hf  <- cox.zph(m_final[[1]]$model_object)
# schoen_resid_phd <- cox.zph(m_final[[2]]$model_object)

# ## Visual assessment
 # map(.x = list(schoen_resid_hf, schoen_resid_phd), ~plot(.x, var=c(1:12)))

```


## HR per change in continuous form of exposure 
Organise list of models as such: Outcome x type of PA x exposure

```{r}

# Calculate sex-specific met4 and metsd ---
data_expanded <- map(
  .x=data_expanded, 
  ~group_by(.x, sex) %>% 
     mutate(
       met4=met/4, 
       metsd=scale(met),
       met_work4=met_work/4, 
       met_worksd=scale(met_work),
       met_nonwork4=met_nonwork/4, 
       met_nonworksd=scale(met_nonwork)) %>% 
    ungroup()
  )

# Run regression
# Corrected for regression dilution 
expos <- list(
  met=c("met4", "metsd"), 
  met_work=c("met_work4", "met_worksd"), 
  met_nonwork=c("met_nonwork4", "met_nonworksd")
)
  
model_cont <- list()

for(df in seq_along(data_expanded)){
  for(nn in seq_along(names(expos))){
    
    EName <- names(expos)[nn]
    OName <- c("hf", "phd")[df]
    
    model_cont[[OName]][[EName]] <- map_dfr(
      .x=expos[[EName]],
      ~Cox_shape_strength_data(
          dataset=data_expanded[[df]], 
          exposure_var_cont=.x,
          expo_type_continuous=TRUE,
          correct_regression_dilution=TRUE,       
          regression_dilution_ratio=RDR_peto[[nn]],
          adjustment_vars=adjustment_variables[[EName]], 
          stratify_vars=c(stratify),
          print_model_info = FALSE) %>%
        pluck(., 2), 
      .progress=TRUE
      ) %>% 
      rename("exposure"=term)
  }
  
}

```


### Make shape plots for met

```{r}
# Simplify list for shape plot 
FAR_met <- map(.x=FAR, ~pluck(.x, "met"))

# Per 4 MET
HRLabel <- map2_chr(
  .x=model_cont, 
  .y=c("HR per 4 MET-hour/day usual levels", ""),
  ~pluck(.x, "met") %>% 
    filter(grepl("4", exposure)) %>% 
    mutate(
      exposure=.y, # For labelling
      hr_ci=paste0(format(round(hr_corrected, 2)),  " (",
                   format(round(lci_corrected, 2)), " - ", 
                   format(round(uci_corrected, 2)), ")"), 
      label=paste0(exposure, "\n", hr_ci)) %>% 
    pull(label)
  )

# select which columns we want, and give them appropriate names
plotdata <- map(
  .x=FAR_met, 
  ~data.frame(
    RF_Level=.x$resurvey_Qmean, 
    Estimate=.x$estimate, 
    StdErr=.x$quasiSE, 
    Events=.x$n, 
    exp_est=exp(.x$estimate)
    ) %>% 
    `row.names<-`(NULL)
  )

# headers to put above each column of panels
headers  <- c("A. Heart failure", "B. Pulmonary heart disease")
  
# Set page margins: format is c(bottom, left, top, right)

# set up the Jasper page
type <- "JPG"
SetPage(orient="LANDSCAPE", 
        nlong=2, 
        nshort=1, 
        page_height=7,
        page_width=8,
        type=type, 
        page_dpi=600,
        page_pointsize=8,
        suppress.date=TRUE,
        titlespace=0.03,
        footer="",
        footer.cex=1.2,
        footerspace=0.03,
        filestem="Figure 1 Shape Plot PA and heart failure")

# loop over the panels in a slightly strange order, to match data
for (j in seq_along(plotdata)){
 
	# do the linear plot for this set of data
	LinearPlot(plotdata[[j]], 
	           new.plot          = TRUE, 
	           mainfont          = 1,   
	           YLogScale         = TRUE, 
	           ExponentiateDataOnPlot = TRUE,
	           boxparm.stderr    = 0.025, 
	           xlim              = c(10,30),  
	           xticks            = seq(10,30, 5), 
	           ylim              = c(0.25, 2), 
	           yticks            = c(0.25, 0.5, 1, 2), 
	           margins           = c(5,5,3,2),  
	           xticklabs.cex     = 0.9, 
	           yticklabs.cex     = 0.9,
	           PointLabelsTop    = "exp_est",
	           PointLabelsBottom = "Events",
	           PointLabelsCEX    = 0.9, 
	           TruncateAtPlotLims = FALSE,
	           CIsOnTop           = TRUE)
	
	# add axis labels
	AxisLabels(
	  ylab=c("Hazard ratio (95% CI)", "")[j], 
	  xlab="Usual total physical activity, MET-hour/day", 
	  mainfont=1.1)
	
	par(xpd=NA)
	
	# add the column heading
	text(x=c(11.5, 15)[j], y=log(2.2), labels=headers[j], font=2, cex = 1.2)
	
	# Add labels for HR 
	text(x=10, y=log(1.7), font=1, cex=0.9, adj=c(0, 0), labels=HRLabel[j])

}

closeFile(type)

```


### Make shape plot for PA types 

```{r}

# For shape plot 
FAR_type_flat <- map(
  .x=FAR, 
  ~.x[c("met_work", "met_nonwork")]) %>% flatten()

FAR_type_flat <- c(FAR_type_flat[c(1,3,2,4)]) # Rearrange data for plotting 

# Continuous 
HRLabTypes <- map(
  .x=model_cont, 
  ~.x[c("met_work", "met_nonwork")]) %>% 
  flatten() %>% 
  map2_chr(
    .y=rep(c("HR per 4 MET-hour/day usual levels", ""), 2), 
    ~filter(.x, grepl("4", exposure)) %>% 
      mutate(
      exposure=.y, # For labelling
      hr_ci=paste0(format(round(hr_corrected, 2), nsmall=2),  " (",
                   format(round(lci_corrected, 2), nsmall=2), " - ", 
                   format(round(uci_corrected, 2), nsmall=2), ")"), 
      label=paste0(exposure, "\n", hr_ci)) %>% 
    pull(label)
  )

HRLabTypes <- HRLabTypes[c(1,3,2,4)]

# select which columns we want, and give them appropriate names
plotdata <- map(
  .x = FAR_type_flat, 
  ~data.frame(
    RF_Level = .x$resurvey_Qmean, 
    Estimate = .x$estimate, 
    StdErr   = .x$quasiSE, 
    Events   = .x$n, 
    exp_est  = exp(.x$estimate)
    ) %>% 
   `row.names<-`(NULL)
  )

n_events <- map_chr(.x = plotdata, ~paste0("(n=", sum(.x$Events), ")"))

# headers to put above each column of panels
headers <- c("HF", "PHD", "HF", "PHD")
headers <- map2_chr(
  .x = headers, 
  .y = n_events, 
  ~paste0(.x, "\n", .y)
)

subheaders <- c("A. Occupational PA", "", "B. Non-occupational PA", "")

# set up the Jasper page
type <- "JPG"
SetPage(orient="LANDSCAPE", 
        nlong=2, 
        nshort=2, 
        page_height=9.5,
        page_width=7.5,
        type=type, 
        page_dpi=300,
        page_pointsize=12,
        suppress.date=TRUE,
        titlespace=0.07,
        footer="All analyses were stratified by age-at-risk, sex, and study area and adjusted for income, education, occupation, alcohol, smoking and sedentary time.\n. Additiionally, occupational and non-occupational PA were mututally adjusted for each other\nHF = Heart failure; PHD = Pulmonary heart disease; PA = Physical activity\n
        ",
        footer.cex = 1.2,
        footerspace=0.09,
        filestem="Figure PA type Shape Plot PA and heart failure")


# loop over the panels in a slightly strange order, to match data
for (j in seq_along(plotdata)) {
 
	# do the linear plot for this set of data
	LinearPlot(plotdata[[j]], 
	           new.plot          = TRUE, 
	           mainfont          = 1,   
	           YLogScale         = TRUE, 
	           ExponentiateDataOnPlot = TRUE,
	           boxparm.stderr    = 0.025, 
	           xlim              = c(0,30),  
	           xticks            = seq(0,30, 5), 
	           xticklabs         = c("0", "", "10", "", "20", "", "30"),
	           ylim              = c(0.25, 2), 
	           yticks            = c(0.25, 0.5, 1, 2), 
	           margins           = c(3,6,5,5),  
	           xticklabs.cex     = 0.9, 
	           yticklabs.cex     = 0.9,
	           PointLabelsTop    = NULL,
	           PointLabelsBottom = NULL,
	           PointLabelsCEX    = 0.8, 
	           TruncateAtPlotLims = FALSE,
	           CIsOnTop           = TRUE)
	
	# add axis labels
	AxisLabels(
	  ylab=rep(c("Hazard ratio (95% CI)", ""), 2)[j], 
	  xlab=c("Usual occupational PA, MET-hr/day",
	         "Usual occupational PA, MET-hr/day", 
	         "Usual non-occupational PA, MET-hr/d", 
	         "Usual non-occupational PA, MET-hr/d")[j],
	  mainfont = 1
	  )
	
	par(xpd=NA)
	
	# add the column heading
	text(x=15, y=log(1.8), labels=headers[j], font=2, cex = 1)
	text(x=-8, y=log(2.4), labels=subheaders[j], adj = c(0,0), font=2, cex = 1.05)
	
	# Add labels for HR 
	text(x=0, y=log(0.27), font=1, cex=0.8, adj=c(0, 0), labels=HRLabTypes[j])
 }

## Plot title 
text(x      =-14, 
     y      = log(90), 
     font   =2, 
     cex    = 1.1,
     adj    =c(0.5, 0),
     labels ="eFigure 5: Associations of fifths of usual occupational and non-occupational physical activity\nwith heart failure and pulmonary heart disease"
     )


closeFile(type)


```



## Compute age-sex specific HR 

### Age-sex-specific RDR 

```{r}

var_cont <- "met"
var_cat  <- "met_q5"

# Three categories for age at risk 
resurv_merged_met <- 
  mutate(
    resurv_merged_met, 
    age3=cut(
      age, 
      breaks=c(30, 60, 70, 81), 
      include.lowest=TRUE, 
      right=FALSE, 
      labels=c("30-59", "60-69", "70+")))

age_sex_names <- sort(
  c(paste0(unique(resurv_merged_met$age3), "_", levels(resurv_merged_met$sex)[[1]]),
    paste0(unique(resurv_merged_met$age3), "_", levels(resurv_merged_met$sex)[[2]])))

RDR_age_sex <- 
  resurv_merged_met %>%
  dplyr::group_by(age3, sex) %>% 
  dplyr::group_split() %>% 
  map(
    ~reframe(
      .x, 
      mean_var_baseline=mean(.data[[var_cont]], na.rm=TRUE),
      mean_resurvey1=mean(var_rs1, na.rm=TRUE),
      mean_resurvey2=mean(var_rs2, na.rm=TRUE), 
      mean_var_resurvey=mean(resurv_ave, na.rm=TRUE),
      min_var_baseline= min(.data[[var_cont]], na.rm=TRUE),
      max_var_baseline=max(.data[[var_cont]], na.rm=TRUE), 
    .by=all_of(var_cat)
      ) %>%
      dplyr::mutate(
        baseline_group=case_when(
          .data[[var_cat]]=="Q1"~paste0(.data[[var_cat]], " (<", format(round(max_var_baseline, j), nsmall=j), ")"),
          .data[[var_cat]]=="Q5"~paste0(.data[[var_cat]], " (",  format(round(min_var_baseline, j), nsmall=j), "+)"),
          TRUE~paste0(.data[[var_cat]], " (",  
                      format(round(min_var_baseline, j), nsmall=j), " to <",
                      format(round(max_var_baseline, j), nsmall=j), ")"))
        ) %>% 
      # Calculate RDR --
      rdr_peto(
        dataset=., 
        baseline_var="mean_var_baseline", 
        resurvey_var="mean_var_resurvey")) %>% 
  setNames(age_sex_names)

```


### met4

- Age-sex specific betas and se were adjusted for age-sex specific RDR

```{r}

source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/trend_het_test.R")

# Wrangling---
data_expanded <- map(
  .x=data_expanded, 
  ~dplyr::mutate(
    .x,
    age_lexis3=cut(
      age_lexis, 
      breaks=c(30, 60, 70, 81), 
      include.lowest=TRUE, 
      right=FALSE, 
      labels=c("30-59", "60-69", "70+"))
    )
  ) 

# Redefine age, sex met4 and metSD
# Redefining Met4 and MetSD makes no difference to the results*********
data_expanded <- map(
  .x=data_expanded, 
  ~group_by(.x, age_lexis3, sex) %>% 
    mutate(met4_age_sex=met/4, metsd_age_sex=scale(met)) %>% dplyr::ungroup()
)

cox_strata <- map(
    .x = data_expanded,
    ~Cox_interaction_data(
      dataset = .x,
      main_exposure_var           = "met4_age_sex",
      multiple_interaction_vars = c("age_lexis3", "sex"),
      test_interaction            = FALSE,
      correct_regression_dilution = FALSE,
      regression_dilution_ratio   = NULL,
      print_model_info            = FALSE,
      event_var                   = "lex.Xst",
      fu.time                     = "lex.dur",
      cox_method                  = "breslow",
      stratify_vars               = c("region"),
      adjustment_vars             = c(ses_vars, lifestyle_vars))
    )

# Correct age-sex specific coefficients for RDB --

## Convert RDR to tibble 
RDR_age_sex_df <- data.frame(
  age_sex=names(RDR_age_sex), 
  rdr=as.numeric(unlist(RDR_age_sex))) %>% 
  separate(
    col=age_sex, 
    into=c("age", "sex"), 
    sep="_"
  )

cox_strata <- map(
    .x=cox_strata,
    ~inner_join(
      rename(.x, "age"=age_lexis3), 
      RDR_age_sex_df, 
      by=c("age", "sex")) %>% 
      mutate(
        est_corrected=estimate/rdr,
        se_corrected=std.error/rdr,
        var_corrected=se_corrected^2) 
    )

# Perform heterogeneity tests --
age_lex3_levels <- levels(data_expanded[[1]]$age_lexis3)

het_sex <- map(
  .x = cox_strata,
  ~group_by(.x, age) %>%
    group_split() %>%
    map_dfr(~heterogeneity(.x$est_corrected, .x$se_corrected)) %>%
    mutate(age=age_lex3_levels, test_type="Heterogeneity")
)

# Run IVWMA and get age-specific estimates
ivw_FE_age <- map(
  .x=cox_strata,
  ~group_by(.x, age) %>%
    group_split() %>%
    setNames(age_lex3_levels) %>%
    map(
      ~metafor::rma( # Meta-analyse sex-specific estimates across age groups
        yi=est_corrected,
        vi=var_corrected,
        method="FE",
        data=.x)) %>% 
    map_dfr( 
      ~tibble(
        beta=.x$b[1, 1],
        se=.x$se,
        lci=.x$ci.lb,
        uci=.x$ci.ub,
        est_ci=paste0(
          format(round(exp(beta), 2), 2), " (",
          format(round(exp(lci), 2), 2), " - ", 
          format(round(exp(uci), 2), 2), ")"))
      )
  )

# Test trend across age-specific IV estimates--
trend_age <- map(
  .x=ivw_FE_age, 
  ~with(.x, trend(beta, se))%>% 
    as_tibble() %>% 
    rename(DF=df, test_stats=`test statistic`, p.trend=p) %>% 
    mutate(test_type="Trend")) 

# Get the overall estimate from the main model
# Do not meta-analyse to ensure the estimates are consistent with the main model
model_cont_met4 <- map(
  .x=model_cont, 
  ~pluck(.x, "met") %>% filter(exposure=="met4"))

ivw_FE_all <- map(
  .x=model_cont_met4, 
  ~transmute(
    .x, 
    beta=est_corrected, 
    se=se_corrected, 
    lci=beta-1.96*se, 
    uci=beta+1.96*se, 
    est_ci=paste0(
        format(round(exp(beta), 2), 2), " (",
        format(round(exp(lci), 2), 2), " - ", 
        format(round(exp(uci), 2), 2), ")")
    )
  )

cox_strata

```


### Wrangle data and make forest plot 

```{r}

source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/order_row.R")
source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/add_table_header.R")

# Wrangle main dataframe --
# Number of events by age and sex 
n_event_df <- map(
  .x = data_expanded,
  ~group_by(.x, age_lexis3, sex) %>% 
  reframe(n_events=sum(lex.Xst)
  ))

cox_strata <- map2(
  .x=cox_strata, 
  .y=seq_along(cox_strata), 
  ~select(.x, -c(estimate:p.value)) %>% 
    mutate(n_event=n_event_df[[.y]]$n_events))  

# Format dataset to make forest plot ---
# Add stats for trend and heterogeneity 
df_ageS_forest <- list()

for (j in seq_along(cox_strata)) {

  df_ageS_forest[[j]] <- 
    cox_strata[[j]] %>% 
    group_by(age) %>%
    group_split() %>% 
    map2_dfr(
      .y = seq_along(.), 
      ~mutate(# Create new relevant columns 
        .x, 
        Het=NA, 
        Trend=NA,
        DF=NA, 
        chi2=NA, 
        p=NA,
        test_type=NA, 
        IsDiamond=0, 
        FillColour=1) %>% 
  
  # Add a row for the IVW estimates
  # At the end of each dataframe 
    add_row(
       age=unique(.$age), 
       sex="Both", 
       est_corrected=ivw_FE_age[[j]][.y, ]$beta, 
       se_corrected=ivw_FE_age[[j]][.y, ]$se,  
       n_event=sum(.x$n_event, na.rm=TRUE),
       DF=het_sex[[j]]$df[.y], 
       chi2=het_sex[[j]]$`test statistic`[.y], 
       p=het_sex[[j]]$p[.y], 
       Het=paste0(
         het_sex[[j]]$df[.y],  "," ,
         format(round(het_sex[[j]]$`test statistic`[.y], 2), nsmall=2L),  "," ,
         format(round(het_sex[[j]]$p[.y], 4),nsmall=4L)),
       Trend=NA,
       test_type="heterogeneity",
       IsDiamond=1, 
       FillColour=0) 
      ) 
  
    all_events <- sum(filter(df_ageS_forest[[j]], sex=="Both") %>% pull(n_event), na.rm=TRUE)

    # Add table header
    df_ageS_forest[[j]] <- add_table_header(
      data=df_ageS_forest[[j]], 
      group_var=age, 
      group_level_var=sex, 
      extra_space=FALSE) %>% 
      rename("Heading"=sex) %>% 
      add_row(
         Heading="All", 
         est_corrected=model_cont_met4[[j]]$est_corrected, 
         se_corrected=model_cont_met4[[j]]$se_corrected,  
         n_event=all_events,
         DF=trend_age[[j]]$DF, 
         chi2=trend_age[[j]]$test_stats, 
         p=trend_age[[j]]$p.trend, 
         Trend=paste0(
           trend_age[[j]]$DF,  "," ,
           format(round(trend_age[[j]]$test_stats, 2),  nsmall=2L),  "," ,
           format(round(trend_age[[j]]$p.trend, 4),nsmall=4L)),
         Het=NA,
         test_type="trend",
         IsDiamond=1, 
         FillColour=0) %>%  as.data.frame(.)
   # End of for loop
}
 

```


## Make forest plot for age-sex-specific associations

```{r}

# Format dataset ---

# set up an object that stores the forest and associated metadata
forest1 <- FormatForest(
  rawdata=df_ageS_forest[[1]] %>% 
    rename("Het1"        = Het, 
           "Trend1"      = Trend, 
           "IsDiamond1"  = IsDiamond, 
           "FillColour1" = FillColour
           ), 
  forest.n    = 1, 
  EstimateCol = "est_corrected",  
  StdErrCol   = "se_corrected",
  logData     = FALSE, 
  getBlanks   = TRUE, 
  getHets     = TRUE, 
  getTrends   = TRUE)

# set up an object that stores the forest and associated metadata
forest2 <- FormatForest(
  rawdata=df_ageS_forest[[2]]%>% 
    rename("Het2"        = Het,  
           "Trend2"      = Trend, 
           "IsDiamond2"  = IsDiamond, 
           "FillColour2" = FillColour
           ),  
    forest.n    = 2, 
    EstimateCol = "est_corrected",  
    StdErrCol   = "se_corrected",
    logData     = FALSE,  
    getBlanks   = TRUE, 
    getHets     = TRUE, 
    getTrends   = TRUE)

blank.rows  <- forest1$blank.rows 
 
# find labels to put in the left most column
left.labels <- convertUnicode(as.character(df_ageS_forest[[1]]$Heading))

# what other columns should be plotted
other.cols  <- "n_event"

# find column headings
print.headings <- parseColHeadings(df_ageS_forest[[1]]$ColHeadings, rd=df_ageS_forest[[1]])

# Make forest plot -----
type <- "PNG"

SetPage(orient          = "LANDSCAPE", 
        perpage         = 1, 
        type            = type, 
        png_bg          = "white",
        filestem        = "Figure 3 Age-sex association of PA and HF (met4)", 
        page_dpi        = 600,
        page_pointsize  = 9,
        page_height     = 6,
        page_width      = 7,
        append_datetime = FALSE, 
        suppress.date   = TRUE, 
        titlespace      = 0.0005, 
        footerspace     = 0.08, 
        footer.title.allbold = FALSE,
        footer.cex      = 1, 
        footer    = "\nAll analyses were stratified by study area and adjusted for income, education, occupation, smoking status, alcohol and sedentary time. 
The black squares and horizontal lines are the hazard ratios (HRs), 95% confidence intervals (CI), weighted average of group-specific HRs. 
Standard deviations (SDs) for each trait was recalculated for each age-sex strata. Het = Heterogeneity for sex differences, TPA = Total physical activity
        
\n")

# Set page margins: format is c(bottom, left, top, right)
par(mar=c(4.14537797266251, 2, 8.14537797266251, 2))

mainfont <- 1
blankPlot(c(0,100),c(0,100), mainfont)
par(xpd=NA)

spacing    <- 1.2
plot.width <- 12
x_label    <- "HR (95% CI) per 4 MET-hour/day\nusual higher TPA"

# draw the Forest plot(s)
xaxmin1 <- 23.7542
xaxmax1 <- xaxmin1 + plot.width
locs    <- ForestBasic(forest1,
                    	LogScale          = TRUE,
                    	ExponentiateDataOnPlot=TRUE,
                    	xaxmin            = xaxmin1,
                    	xaxmax            = xaxmax1, 
                    	xlim              = c(0.5, 1.1),
                    	xticks            = c(0.5, 1.0),
                    	ticklabs          = c("0.5", "1.0"),
                    	xlab              = x_label,
                    	NLabel            = FALSE,
                    	mainfont          = 0.95,
                    	ValueLabels       = TRUE,
                    	ValueLabelsHeader = "HR (95% CI)",
                    	ValueDigits       = NULL,
                    	lwd               = 1,
                    	CISecond          = TRUE,
                    	separator         = " - ",
                    	spacing           = spacing/2, 
                    	pointGroupsFactor = 0.9,
                    	verbose           = FALSE,
                    	boxsizeoverride   = FALSE,
                    	boxparm.stderr    = 0.01)

# add titles above forest (may be left empty, change labels="" to what you will)
text(x      = xaxmin1 + (xaxmax1 - xaxmin1 + (spacing) )/2, 
     y      = 115, 
     labels = "A. Heart Failure", 
     adj    = c(0.5,0), 
     font   = 2, 
     cex    = 1.15
     )


# draw the Forest plot(s)
xaxmin2 <- 70.0592
xaxmax2 <- xaxmin2 + plot.width
locs2 <- ForestBasic(forest2,
                    	LogScale          = TRUE,
                    	ExponentiateDataOnPlot = TRUE,
                    	xaxmin            = xaxmin2,
                    	xaxmax            = xaxmax2,
                    	xlim              = c(0.5, 1.1),
                    	xticks            = c(0.5, 1.0),
                    	ticklabs          = c("0.5", "1.0"),
                    	xlab              = x_label,
                    	NLabel            = FALSE,
                    	mainfont          = 0.95,
                    	ValueLabels       = TRUE,
                    	ValueLabelsHeader = "HR (95% CI)",
                    	ValueDigits       = NULL,
                    	lwd               = 1,
                    	CISecond          = TRUE,
                    	separator         = " - ",
                    	spacing           = spacing/2,
                    	pointGroupsFactor = 0.9,
                    	verbose           = FALSE,
                    	boxsizeoverride   = FALSE,
                    	boxparm.stderr    = 0.01)

# add titles above forest (may be left empty, change labels="" to what you will)
text(x      = xaxmin2 + (xaxmax2 - xaxmin2 + (spacing) )/2, 
     y      = 115, 
     labels = "B. Pulmonary heart disease", 
     adj    = c(0.5,0), 
     font   = 2, 
     cex    = 1.15
     )

# left hand column of labels
text(x = 1, y = 100, labels = "Age at risk,\nyears", adj = c(0,0), font = 2, cex = 1)

text(x      = 1, 
     y      = locs$YLocs, 
     adj    = 0, 
     cex    = 1, 
     font   = ifelse(forest1$IsDiamond, 2,1), 
     labels = left.labels[-blank.rows])

text(x      = 1, 
     y      = locs$BlankLocs, 
     adj    = 0, 
     font   = 2, 
     cex    = 1, 
     labels = left.labels[blank.rows])

# adding other columns ---

# For HF 
column1.xpos <- xaxmin1 - 2

text(x      = column1.xpos, 
     y      = 100, 
     adj    = c(1,0), 
     font   = 2, 
     cex    = 1, 
     labels = convertUnicode("No. of\nevents"))

text(x      = column1.xpos, 
     y      = locs$YLocs, 
     font   = ifelse(forest1$IsDiamond, 2, 1),
     adj    = 1, 
     cex    = 1, 
     labels = convertUnicode(as.character(df_ageS_forest[[1]][,other.cols[1]]))[-blank.rows])

text(x      = column1.xpos, 
     y      = locs$BlankLocs, 
     adj    = 1, 
     cex    = 1, 
     labels = convertUnicode(as.character(df_ageS_forest[[1]][,other.cols[1]]))[blank.rows])

# For PHD
column2.xpos <- xaxmin2 - 2

text(x      = column2.xpos, 
     y      = 100, 
     adj    = c(1,0), 
     font   = 2, 
     cex    = 1, 
     labels = convertUnicode("No. of\nevents"))

text(x      = column2.xpos, 
     y      = locs$YLocs, 
     font   = ifelse(forest1$IsDiamond, 2, 1),
     adj    = 1, 
     cex    = 1, 
     labels = convertUnicode(as.character(df_ageS_forest[[2]][,other.cols[1]]))[-blank.rows])

text(x      = column2.xpos, 
     y      = locs$BlankLocs, 
     adj    = 1, 
     cex    = 1, 
     labels = convertUnicode(as.character(df_ageS_forest[[2]][,other.cols[1]]))[blank.rows])

##Plot title 
# text(x      = 50.5, 
#      y      = 119, 
#      font   = 2, 
#      cex    = 1.2,
#      adj    = c(0.5, 0),
#      labels = "Figure 3: Age-sex specific hazard ratio (95% CI) of heart failure and pulmonary heart disease per 4 MET-hr usual\n higher total physical acitivity")

# Heterogeneity labels 
x_coord <- list("hf"=36.3003646765421, "phd"=82.4423204683451)

# Get data for hetereogeneity---
het_df <- map(
  .x = df_ageS_forest, 
  ~filter(.x, !is.na(chi2), test_type=="heterogeneity") %>% select(DF:p))

n_row_het <- map(.x=het_df, ~nrow(.x))

index = 1

for (H in seq_len(n_row_het[[index]]) ) {
  
  chi_DF   <- het_df[[index]]$DF[H]
  chi_val  <- round(het_df[[index]]$chi2[H], 2)
  p_value  <- het_df[[index]]$p[H]
  
  p_value  <- ifelse(p_value <0.0001, "p<0.0001", paste0("p=", format(round(p_value, 4), nsmall=4, scientific=FALSE)))
  
  text(x      = x_coord[[index]], 
       y      = locs$HetLocs[H], 
       adj    = 0, 
       cex    = 0.8,  
       labels = bquote(Het: ~ chi[.(chi_DF)]^2 ~ "=" ~ .(chi_val) ~ (.(p_value)))
       )
  }

# Labels for PHD 
# Heterogeneity labels for PHD

index = 2

for (H in seq_len(n_row_het[[index]]) ) {
  
  chi_DF   <- het_df[[index]]$DF[H]
  chi_val  <- round(het_df[[index]]$chi2[H], 2)
  p_value  <- het_df[[index]]$p[H]
  p_value <- ifelse(p_value<0.0001, "p<0.0001", paste0("p=", format(round(p_value, 4), nsmall=4, scientific=FALSE)))
  
  text(x      = x_coord[[index]], 
       y      = locs$HetLocs[H], 
       adj    = 0, 
       cex    = 0.8,  
       labels = bquote(Het: ~ chi[.(chi_DF)]^2 ~ "=" ~ .(chi_val) ~ (.(p_value)))
       )
  
}

# Get data for trend----
trend_df <- map(
  .x = df_ageS_forest, 
  ~filter(.x, !is.na(chi2), test_type=="trend") %>% select(DF:p))

n_row_trend <- map(.x=trend_df, ~nrow(.x))

index = 1

for (HT in seq_len(n_row_trend[[index]])){
  
  chi_DF   <- trend_df[[index]]$DF[HT]
  chi_val  <- round(trend_df[[index]]$chi2[HT], 2)
  p_value  <- trend_df[[index]]$p[HT]
  p_value  <- ifelse(p_value<0.0001, "p<0.0001", paste0("p=", format(round(p_value, 4), nsmall=4, scientific=FALSE)))
  
  text(x      = x_coord[[index]], 
       y      = locs$TrendLocs[HT], 
       adj    = 0, 
       cex    = 0.8,  
       labels = bquote(Trend: ~ chi[.(chi_DF)]^2 ~ "=" ~ .(chi_val) ~ (.(p_value)))
       )
  
}

# Labels for PHD 
# Trend labels for PHD

index = 2

for (HT in seq_len(n_row_trend[[index]]) ) {
  
  chi_DF   <- trend_df[[index]]$DF[HT]
  chi_val  <- round(trend_df[[index]]$chi2[HT], 2)
  p_value  <- trend_df[[index]]$p[HT]
  p_value  <- ifelse(p_value <0.00010, "p<0.0001", paste0("p=", format(round(p_value, 4), nsmall=4, scientific=FALSE)))
  
  text(x      = x_coord[[index]], 
       y      = locs$TrendLocs[HT], 
       adj    = 0, 
       cex    = 0.8,  
       labels = bquote(Trend: ~ chi[.(chi_DF)]^2 ~ "=" ~ .(chi_val) ~ (.(p_value)))
       )
  
}

# stop writing to file
closeFile(type)


```


# Subgroup analyses --

The following variables were used for subgroup analysis 
	* Age at risk
	* Area (Urban and rural)
	* Sex 
	* Alcohol
	* Smoking 
	* BMI 
	* Waist circumference
	* Resting HR 
	* Diabetes 

```{r}

# Wrangling -----
data_expanded <- map(
    .x=data_expanded,
    ~dplyr::mutate(
      .x,
      age_lexis4=cut(
        age_lexis,
        breaks=c(30, 50, 60, 70, 81),
        include.lowest=TRUE,
        right=FALSE,
        labels=c("30-49", "50-59", "60-69", "70+"))
      )
    )

# Define non-fatal incident MI 
# date_diag <- c("HF_combined_datedeveloped", "PHD_combined_datedeveloped")

# Create list for subgroup analysis -----
prim_cov  <- "met4"
adjustment_vars <- c(ses_vars, lifestyle_vars)

subg_vars <- list(
  age_lexis4=list("adjust"=adjustment_vars, "stratify"=c("sex", "region"), "label"="Age at risk, years"),
  sex=list("adjust"=adjustment_vars, "stratify"=c("age_lexis5", "region"), "label"="Sex"), 
  area=list("adjust"=adjustment_vars, "stratify"=c("sex", "age_lexis5"), "label"="Area of residence"),
  region=list("adjust"=adjustment_vars, "stratify"=c("sex", "age_lexis5"), "label"="Region"), 
  diabetes=list("adjust"=adjustment_vars, "stratify"=stratify, "label"="Prevalent diabetes"), 
  heart_rate_mean_Q4=list("adjust"=adjustment_vars, "stratify"=stratify, "label"="Resting heart rate, bpm"),
  alcohol_recode=list("adjust"=adjustment_vars[-which(adjustment_vars%in%"alcohol_recode")], "stratify"=stratify, "label"="Alcohol consumption"), 
  smoking_status=list("adjust"=adjustment_vars[-which(adjustment_vars%in%"smoking_status")], "stratify"=stratify, "label"="Smoking"), 
  bmi_cat=list("adjust"=adjustment_vars, "stratify"=stratify, "label"="Body mass index, kg/m\U00B2"), 
  waist_circ_cm_Q4=list("adjust"=adjustment_vars, "stratify"=stratify, "label"="Waist circumference, cm"),
  HTN=list("adjust"=adjustment_vars, "stratify"=stratify, "label"="Prevalent hypertension")
  )

source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/Cox_interaction.R")

# Get ordinal and nominal subgroup variables --
ordinal_vars <- c("age_lexis4", "bmi_cat", "heart_rate_mean_Q4", "waist_circ_cm_Q4")
nominal_vars <- names(subg_vars)[-which(names(subg_vars)%in%ordinal_vars)]

cox_strata <- list()

for (jj in seq_along(data_expanded)){

   # Ordinal variables ---
    cox_strata_ordinal <- map_dfr(
      .x=ordinal_vars,
      ~Cox_interaction_data(
        dataset=data_expanded[[jj]],
        main_exposure_var           = prim_cov,
        ordinal_interaction_vars    = .x,
        ordinal_labels              = subg_vars[[.x]]$label,
        test_interaction            = TRUE,
        correct_regression_dilution = TRUE,
        regression_dilution_ratio   = RDR_peto[[1]],
        print_model_info            = FALSE,
        event_var                   = "lex.Xst",
        fu.time                     = "lex.dur",
        cox_method                  = "breslow",
        stratify_vars               = subg_vars[[.x]]$stratify,
        adjustment_vars             = subg_vars[[.x]]$adjust),
      .progress = TRUE
    )
      
    # Nominal variables ---
    cox_strata_nominal <- map_dfr(
      .x=nominal_vars,
      ~Cox_interaction_data(
          dataset=data_expanded[[jj]],
          main_exposure_var           = prim_cov,
          nominal_interaction_vars    = .x,
          nominal_labels              = subg_vars[[.x]]$label,
          test_interaction            = TRUE,
          correct_regression_dilution = TRUE,
          regression_dilution_ratio   = RDR_peto[[1]],
          print_model_info            = FALSE,
          event_var                   = "lex.Xst",
          fu.time                     = "lex.dur",
          cox_method                  = "breslow",
          stratify_vars               = subg_vars[[.x]]$stratify,
          adjustment_vars             = subg_vars[[.x]]$adjust),
        .progress = TRUE
    )
  
    # Bind datasets --
    cox_strata[[jj]] <- bind_rows(cox_strata_ordinal, cox_strata_nominal)
  }


adjustment_vars_labs <- c(
  "income", 
  "education", 
  "occupation", 
  "smoking status",
  "alcohol", 
  "sedentary time", 
  "heart rate")

```


## Combine and reorder lists 

The function `order_row` order the values of a column based on some order indicated by the user 
`add_table_header`: Add header to rows for reporting as table or forestplot. Use data masking from dplyr 

Obtain a dataframe for DF, Chi2, and p values which will needed for forest plot 

```{r}

source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/order_row.R")
source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/add_table_header.R")

expo_name_order <- c(
  "Age at risk, years", 
  "Sex", 
  "Area of residence",
  "Alcohol consumption",
  "Smoking",
  "Resting heart rate, bpm", 
  "Body mass index, kg/m\U00B2", 
  "Waist circumference, cm",
  "Prevalent diabetes", 
  "Prevalent hypertension")

subgroup_df <- list()
chi_p_df    <- list()   

for (s in seq_along(cox_strata)){
  
  subgroup_df[[s]] <- 
    filter(cox_strata[[s]], subgroup!="Region") %>% 
    select(
       subgroup, 
       term, 
       n_event, 
       est_corrected, 
       se_corrected,  
       DF:n_event
       ) %>% 
    mutate(
       Chi2=round(Chi2, 2), 
       p_val=case_when(
         p_int<0.0001~"0.0001", 
         p_int>=0.0001~format(round(p_int, 4), nsmall=4), 
         TRUE~NA_character_),
       n_event=prettyNum(n_event, big.mark=",", scientific=FALSE),
       Het=ifelse(!is.na(DF) & test_type=="heterogeneity", paste(DF, Chi2, p_val, sep=","), NA),
       Trend=ifelse(!is.na(DF) & test_type=="trend", paste(DF, Chi2, p_val, sep=","), NA), 
       IsDiamond=0, 
       FillColour=1 
       ) %>% 
    select(-p_int)
  
  # Order rows for forest plot 
  subgroup_df[[s]] <- order_row(
    data=subgroup_df[[s]], 
    new_col_order=expo_name_order,
    old_col_name="subgroup")    
  
  # Extract DF, Chi2, and p-values 
  chi_p_df[[s]] <- 
     subgroup_df[[s]] %>% 
     filter(!is.na(DF)) %>% 
     select(subgroup, DF:test_type, p_val) %>% 
     dplyr::mutate(test_type=str_to_title(test_type))

  # Add a column header 
  subgroup_df[[s]] <- add_table_header(
     data=subgroup_df[[s]], 
     group_var=subgroup, 
     group_level_var=term, 
     extra_space=TRUE) 
    
}
 
# Get summary results for main effect analysis ---
main_effect <- map2(
  .x=model_cont_met4,
  .y=seq_along(model_cont_met4), 
  ~filter(.x, exposure=="met4") %>% 
    transmute(
       exposure="Overall", 
       n_event=prettyNum(sum(data_expanded[[.y]]$lex.Xst), big.mark=",", scientific=FALSE), 
       est_corrected = est_corrected, 
       se_corrected  = se_corrected, 
       DF            = NA, 
       Chi2          = NA, 
       test_type     = NA, 
       p_val         = NA, 
       Het           = NA, 
       Trend         = NA, 
       IsDiamond     = 1, 
       FillColour    = 0
       ) %>% 
  add_row(.before=1) %>% 
  rename("term"=exposure)
  )

# Bind overall estimate to subgroup estimates ---
subgroup_forest <- map2(
  .x=subgroup_df, 
  .y=main_effect, 
  ~rbind(.x, .y) %>% 
    select(term:se_corrected, Het:FillColour) %>%
    mutate(
      lci=est_corrected-1.96*se_corrected,
      uci=est_corrected+1.96*se_corrected) %>%
    rename("Heading"=term) %>%
    as.data.frame(.)
  ) 

```

## Make forest plot for subgroup analysis 

```{r}

n_label <- map(
  .x=data_expanded, 
  ~paste0("(n=", prettyNum(sum(.x$lex.Xst), big.mark=",", scientific=FALSE), ")"))

# Format dataset ---

# set up an object that stores the forest and associated metadata
forest1 <- FormatForest(
  rawdata=subgroup_forest[[1]] %>% 
    rename("Het1"= Het, 
           "Trend1"=Trend, 
           "IsDiamond1"=IsDiamond, 
           "FillColour1"=FillColour
           ), 
    forest.n    = 1, 
    EstimateCol = "est_corrected",  
    StdErrCol   = "se_corrected",
    LCICol      = "lci", 
    UCICol      = "uci",
    logData     = FALSE, 
    getBlanks   = TRUE, 
    getHets     = TRUE,  
    getTrends   = TRUE)

# set up an object that stores the forest and associated metadata
forest2 <- FormatForest(
  rawdata=subgroup_forest[[2]]%>% 
    rename("Het2"        = Het, 
           "Trend2"      = Trend, 
           "IsDiamond2"  = IsDiamond, 
           "FillColour2" = FillColour
           ),  
    forest.n    = 2, 
    EstimateCol = "est_corrected",  
    StdErrCol   = "se_corrected",
    LCICol      = "lci", 
    UCICol      = "uci",
    logData     = FALSE,  
    getBlanks   = TRUE, 
    getHets     = TRUE, 
    getTrends   = TRUE)

blank.rows  <- forest1$blank.rows 

# Format headings to incorporate expressions ------

# find labels to put in the left most column
left.labels <- convertUnicode(as.character(subgroup_forest[[1]]$Heading))
paste0(adjustment_vars_labs, collapse = ", ")

# what other columns should be plotted
other.cols  <- "n_event"

# find column headings
print.headings <- parseColHeadings(subgroup_forest[[1]]$ColHeadings, rd=subgroup_forest[[1]])

# Make forest plot -------
type <- "JPG"

SetPage(orient          = "PORTRAIT", 
        perpage         = 1, 
        type            = type, 
        filestem        = "Figure Subgroup_analysis TPA and HF", 
        page_dpi        = 600,
        page_pointsize  = 8,
        page_height     = 9,
        page_width      = 7.5,
        append_datetime = FALSE, 
        suppress.date   = TRUE, 
        titlespace      = 0.045,
        footerspace     = 0.03
#         footer.cex      = 1.7, 
#         footer    = "Analyses were stratified by age-at-risk, sex, and study area and adjusted for income, education, occupation, temperature, temperature\U00B2,\nsmoking status, alcohol, sedentary time, (sedentary time)\U00B2, total physical activity (TPA), TPA\U00B2, heart rate, heart rate\U00B2, body mass index (BMI) and BMI\U00B2
# 
# Het = Heterogeneity, MET = Metabolic equivalent of task
#         \n \n
# 
# " 
        )

# Set page margins: format is c(bottom, left, top, right)
par(mar=c(2.14537797266251, 2, 2.14537797266251, 2))

mainfont <- 0.9
blankPlot(c(0,100),c(0,100), mainfont)
par(xpd=NA)

spacing    <- 1.3
plot.width <- 11
x_label    <- "HR (95% CI) per 4 MET-hr/day\nhigher usual TPA"

# draw the Forest plot(s)
xaxmin1 <- 29.2542
xaxmax1 <- xaxmin1 + plot.width
locs    <- ForestBasic(forest1,
                    	LogScale          = TRUE,
                    	ExponentiateDataOnPlot=TRUE,
                    	xaxmin            = xaxmin1,
                    	xaxmax            = xaxmax1, 
                    	xlim              = c(0.5, 1.1),
                    	xticks            = c(0.5, 1),
                    	ticklabs          = c("0.5", "1.0"),
                    	xlab              = x_label,
                    	NLabel            = FALSE,
                    	mainfont          = 1,
                    	ValueLabels       = TRUE,
                    	ValueLabelsHeader = "HR (95% CI)",
                    	ValueDigits       = NULL,
                    	lwd               = 1,
                    	CISecond          = TRUE,
                    	separator         = " - ",
                    	spacing           = spacing, 
                    	pointGroupsFactor = 0.9,
                    	verbose           = FALSE,
                    	boxsizeoverride   = FALSE,
                    	boxparm.stderr    = 0.01)

# add titles above forest (may be left empty, change labels="" to what you will)
text(x      = xaxmin1 + (xaxmax1 - xaxmin1 + (spacing) )/2, 
     y      = 107, 
     labels = "A. Heart Failure", 
     adj    = c(0.5,0), 
     font   = 2, 
     cex    = 1
     )

text(x      = xaxmin1 + (xaxmax1 - xaxmin1 + (spacing) )/2, 
     y      = 105, 
     labels = n_label[[1]], 
     adj    = c(0.5,0), 
     font   = 1, 
     cex    = 1
     )

# draw the Forest plot(s)
xaxmin2 <- 71.0592
xaxmax2 <- xaxmin2 + plot.width
locs2 <- ForestBasic(forest2,
                    	LogScale          = TRUE,
                    	ExponentiateDataOnPlot = TRUE,
                    	xaxmin            = xaxmin2,
                    	xaxmax            = xaxmax2,
                    	xlim              = c(0.5, 1.1),
                    	xticks            = c(0.5, 1),
                    	ticklabs          = c("0.5", "1.0"),
                    	xlab              = x_label,
                    	NLabel            = FALSE,
                    	mainfont          = 1,
                    	ValueLabels       = TRUE,
                    	ValueLabelsHeader = "HR (95% CI)",
                    	ValueDigits       = NULL,
                    	lwd               = 1,
                    	CISecond          = TRUE,
                    	separator         = " - ",
                    	spacing           = spacing,
                    	pointGroupsFactor = 0.9,
                    	verbose           = FALSE,
                    	boxsizeoverride   = FALSE,
                    	boxparm.stderr    = 0.01)

# add titles above forest (may be left empty, change labels="" to what you will)
text(x      = xaxmin2 + (xaxmax2 - xaxmin2 + (spacing))/2, 
     y      = 107, 
     labels = "B. Pulmonary heart disease", 
     adj    = c(0.5,0), 
     font   = 2, 
     cex    = 1
     )

text(x      = xaxmin2 + (xaxmax2 - xaxmin2 + (spacing) )/2, 
     y      = 105, 
     labels = n_label[[2]], 
     adj    = c(0.5,0), 
     font   = 1, 
     cex    = 1
     )

# left hand column of labels
text(x = 0, y = 100, labels="Subgroups", adj=c(0,0), font=2, cex=1)

text(x      = 0, 
     y      = locs$YLocs, 
     adj    = 0, 
     cex    = 1, 
     font   = ifelse(forest1$IsDiamond, 2,1), 
     labels = left.labels[-blank.rows]
     )

text(x      = 0, 
     y      = locs$BlankLocs, 
     adj    = 0, 
     font   = 2, 
     cex    = 1, 
     labels = left.labels[blank.rows]
     )

# adding other columns ------

# For HF 
column1.xpos <- xaxmin1 - 2

text(x      = column1.xpos, 
     y      = 100, 
     adj    = c(1,0), 
     font   = 2, 
     cex    = 1, 
     labels = convertUnicode("Events (n)")
     )

text(x      = column1.xpos, 
     y      = locs$YLocs, 
     font   = ifelse(forest1$IsDiamond, 2, 1),
     adj    = 1, 
     cex    = 1, 
     labels = convertUnicode(as.character(subgroup_forest[[1]][,other.cols[1]]))[-blank.rows]
     )

text(x      = column1.xpos, 
     y      = locs$BlankLocs, 
     adj    = 1, 
     cex    = 1, 
     labels = convertUnicode(as.character(subgroup_forest[[1]][,other.cols[1]]))[blank.rows]
     )

# For PHD
column2.xpos <- xaxmin2 - 2

text(x      = column2.xpos, 
     y      = 100, 
     adj    = c(1,0), 
     font   = 2, 
     cex    = 1, 
     labels = convertUnicode("Events (n)")
     )

text(x      = column2.xpos, 
     y      = locs$YLocs, 
     font   = ifelse(forest1$IsDiamond, 2, 1),
     adj    = 1, 
     cex    = 1, 
     labels = convertUnicode(as.character(subgroup_forest[[2]][,other.cols[1]]))[-blank.rows]
     )

text(x      = column2.xpos, 
     y      = locs$BlankLocs, 
     adj    = 1, 
     cex    = 1, 
     labels = convertUnicode(as.character(subgroup_forest[[2]][,other.cols[1]]))[blank.rows]
     )


# Add segments -- 
segments(x0=0, y0=98, x1=100, y1=98)

# Heterogeneity labels 
x_coord <- list("hf"=41.8003646765421, "phd"=83.5023204683451)

# Number of trend and het tests 
n_trend_test <- map(.x=chi_p_df, ~nrow(.x %>%filter(test_type=="Trend")))
n_het_test   <- map(.x=chi_p_df, ~nrow(.x %>%filter(test_type=="Heterogeneity")))

index = 1
# Labels for HF ---
# Heterogeneity labels for HF

for (H in seq_len(n_het_test[[index]]) ) {
  
  chi_index <- chi_p_df[[index]][chi_p_df[[index]]$test_type=="Heterogeneity", ]$DF[H]
  chi_val   <- chi_p_df[[index]][chi_p_df[[index]]$test_type=="Heterogeneity", ]$Chi2[H]
  p_value   <- chi_p_df[[index]][chi_p_df[[index]]$test_type=="Heterogeneity", ]$p_val[H]
  p_value   <- ifelse(p_value == "<0.0001", paste0("p", "<0.0001"), paste0("p=", p_value))
  
  text(x      = x_coord[[index]], 
       y      = locs$HetLocs[H], 
       adj    = 0, 
       cex    = 0.8,  
       labels = bquote(Het: ~ chi[.(chi_index)]^2 ~ "=" ~ .(chi_val) ~ (.(p_value))) )
  
}

# Trend labels for HF

for (TT in seq_len(n_trend_test[[index]]) ) {
  
  chi_index <- chi_p_df[[index]][chi_p_df[[index]]$test_type=="Trend", ]$DF[TT]
  chi_val   <- chi_p_df[[index]][chi_p_df[[index]]$test_type=="Trend", ]$Chi2[TT]
  p_value   <- chi_p_df[[index]][chi_p_df[[index]]$test_type=="Trend", ]$p_val[TT]
  p_value   <- ifelse(p_value == "<0.0001", paste0("p", "<0.0001"), paste0("p=", p_value))
  
  text(x      = x_coord[[index]], 
       y      = locs$TrendLocs[TT], 
       adj    = 0, 
       cex    = 0.8,   
       labels = bquote(Trend: ~ chi[.(chi_index)]^2 ~ "=" ~ .(chi_val) ~ (.(p_value))) )
  
}

# Labels for PHD ---

# Heterogeneity labels for PHD

index = 2

for (H in seq_len(n_het_test[[index]]) ) {
  
  chi_index <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Heterogeneity", ]$DF[H]
  chi_val   <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Heterogeneity", ]$Chi2[H]
  p_value   <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Heterogeneity", ]$p_val[H]
  p_value   <- ifelse(p_value == "<0.0001", paste0("p", "<0.0001"), paste0("p=", p_value))
  
  text(x      = x_coord[[index]], 
       y      = locs$HetLocs[H], 
       adj    = 0, 
       cex    = 0.8,  
       labels = bquote(Het: ~ chi[.(chi_index)]^2 ~ "=" ~ .(chi_val) ~ (.(p_value))) )
  
}

# Trend labels for HF

for (TT in seq_len(n_trend_test[[index]])){
  
  chi_index <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Trend", ]$DF[TT]
  chi_val   <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Trend", ]$Chi2[TT]
  p_value   <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Trend", ]$p_val[TT]
  p_value   <- ifelse(p_value == "<0.0001", paste0("p", "<0.0001"), paste0("p=", p_value))
  
  text(x      = x_coord[[index]], 
       y      = locs$TrendLocs[TT], 
       adj    = 0, 
       cex    = 0.8,  
       labels = bquote(Trend: ~ chi[.(chi_index)]^2 ~ "=" ~ .(chi_val) ~ (.(p_value))) )
  
}

# stop writing to file
closeFile(type)

```


## Subgroup2 - Plotting region-specific analysis 

```{r}

# Get subgroup data for region --
urban_regions <- 
  filter(data_expanded[[1]], area=="Urban") %>% 
  pull(region) %>% 
  as.character(.) %>% 
  unique(.)

area_subgroup   <- map(.x=cox_strata, ~filter(.x, subgroup=="Area of residence"))
region_subgroup <- map(.x=cox_strata, ~filter(.x, subgroup=="Region"))     

# Get heterogeneity statistics and bind to dataset --
area_level <- levels(merged_data$area)

het_region_area <- map(
  .x=region_subgroup, 
  ~mutate(.x, area=factor(ifelse(term%in%urban_regions, "Urban", "Rural"), levels=area_level)) %>% 
    group_by(area) %>% 
    group_split() %>% 
    map( ~heterogeneity(I(.$est_corrected), .$se_corrected)) %>% 
    map2_dfr(
      .y = area_level, 
      ~tibble(
         DF=c(rep(NA, 5), pluck(., 1)), 
         Chi2=c(rep(NA, 5), pluck(., 2)), 
         p_int=c(rep(NA, 5), pluck(., 3)), 
         area=.y) 
      )
  ) 

## Split region dataset and bind that for area --
region_forest_temp <- list()
   
for (df in seq_along(region_subgroup)){
  
  region_forest_temp[[df]] <- mutate(
    region_subgroup[[df]],
    term=as.character(term),
    area=factor(ifelse(term%in%urban_regions, "Urban", "Rural"), levels=area_level)
    ) %>% 
    group_by(area) %>% 
    group_split() %>%
    map_dfr(
      .y = seq_along(area_subgroup), 
      ~rbind(
        .x, 
        filter(area_subgroup[[df]], term==unique(.x$area)) %>% mutate(area=term)) # Add a column for area to permit bind
      ) %>%  
    select(-c(DF:p_int)) %>%
    mutate(
      term=case_when(term%in%c("Urban", "Rural")~"All", TRUE~term), 
      IsDiamond=case_when(term=="All"~1, TRUE~0), 
      FillColour=case_when(term=="All"~0, TRUE~1))
  
  }    
   
# Join het data to main region data --
region_forest <- map2(
  .x=region_forest_temp, 
  .y=het_region_area, 
  ~cbind(.x, .y %>% select(-area)))
       
# Add table header -- 
region_forest <- map(
  .x=region_forest, 
  ~add_table_header(
     data=.x, 
     group_var=area, 
     group_level_var=term, 
     extra_space=TRUE) %>% 
    rename("Heading"=term) %>% 
    as.data.frame(.)
)

```


### Make forest plot (REGION)

```{r}

# Format dataset --

# set up an object that stores the forest and associated metadata
forest1 <- FormatForest(
  rawdata     = region_forest[[1]] %>%
    rename(
      "Het1"        = Chi2,
      "IsDiamond1"  = IsDiamond,
      "FillColour1" = FillColour
    ),
  forest.n    = 1,
  EstimateCol = "est_corrected",
  StdErrCol   = "se_corrected",
  logData     = FALSE,
  getBlanks   = TRUE,
  getHets     = TRUE
)

# set up an object that stores the forest and associated metadata
forest2 <- FormatForest(
  rawdata     = region_forest[[2]] %>%
    rename(
      "Het2"        = Chi2,
      "IsDiamond2"  = IsDiamond,
      "FillColour2" = FillColour
    ),
  forest.n    = 2,
  EstimateCol = "est_corrected",
  StdErrCol   = "se_corrected",
  logData     = FALSE,
  getBlanks   = TRUE,
  getHets     = TRUE
)

blank.rows  <- forest1$blank.rows 
 
# find labels to put in the left most column
left.labels <- convertUnicode(as.character(region_forest[[1]]$Heading))

# what other columns should be plotted
other.cols  <- "n_event"

# find column headings
print.headings <- parseColHeadings(region_forest[[1]]$ColHeadings, rd=region_forest[[1]])

# Make forest plot ---
type <- "JPG"

SetPage(orient          = "LANDSCAPE", 
        perpage         = 1, 
        type            = type, 
        filestem        = "eFigure 2 Subgroup analysis by region (met4)", 
        page_dpi        = 600,
        page_pointsize  = 9,
        page_height     = 6,
        page_width      = 7,
        append_datetime = FALSE, 
        suppress.date   = TRUE, 
        titlespace      = 0.01, 
        footerspace     = 0.03, 
        footer.cex      = 1.3)

# Set page margins: format is c(bottom, left, top, right)
par(mar=c(4.14537797266251, 2, 5.14537797266251, 2))

mainfont <- 1
blankPlot(c(0,100),c(0,100), mainfont)
par(xpd=NA) 

spacing    <- 0.8
plot.width <- 13
x_label    <- "HR (95% CI) per 4 MET-hr/day\nhigher usual TPA"

# draw the Forest plot(s)
xaxmin1 <- 22.2542
xaxmax1 <- xaxmin1 + plot.width 
locs    <- ForestBasic(
  forest1,
  LogScale          = TRUE,
  ExponentiateDataOnPlot = TRUE,
  xaxmin            = xaxmin1,
  xaxmax            = xaxmax1,
  xlim              = c(0.5, 1.5),
  xticks            = seq(0.5, 1.5, 0.5),
  ticklabs          = seq(0.5, 1.5, 0.5),
  xlab              = x_label,
  NLabel            = FALSE,
  mainfont          = 0.95,
  ValueLabels       = TRUE,
  ValueLabelsHeader = "HR (95% CI)",
  ValueDigits       = NULL,
  lwd               = 1,
  CISecond          = TRUE,
  separator         = " - ",
  spacing           = spacing / 2,
  pointGroupsFactor = 0.9,
  verbose           = FALSE,
  boxsizeoverride   = FALSE,
  boxparm.stderr    = 0.03
)

# add titles above forest (may be left empty, change labels="" to what you will)
text(
  x      = xaxmin1 + (xaxmax1 - xaxmin1 + (spacing)) / 2,
  y      = 115,
  labels = "A. Heart Failure",
  adj    = c(0.5, 0),
  font   = 2,
  cex    = 1.15
)

# draw the Forest plot(s)
xaxmin2 <- 68.0592
xaxmax2 <- xaxmin2 + plot.width
locs2 <- ForestBasic(
  forest2,
  LogScale          = TRUE,
  ExponentiateDataOnPlot = TRUE,
  xaxmin            = xaxmin2,
  xaxmax            = xaxmax2,
  xlim              = c(0.5, 1.5),
  xticks            = seq(0.5, 1.5, 0.5),
  ticklabs          = seq(0.5, 1.5, 0.5),
  xlab              = x_label,
  NLabel            = FALSE,
  mainfont          = 0.95,
  ValueLabels       = TRUE,
  ValueLabelsHeader = "HR (95% CI)",
  ValueDigits       = NULL,
  lwd               = 1,
  CISecond          = TRUE,
  separator         = " - ",
  spacing           = spacing / 2,
  pointGroupsFactor = 0.9,
  verbose           = FALSE,
  boxsizeoverride   = FALSE,
  boxparm.stderr    = 0.03)

# add titles above forest (may be left empty, change labels="" to what you will)
text(
  x      = xaxmin2 + (xaxmax2 - xaxmin2 + (spacing)) / 2,
  y      = 115,
  labels = "B. Pulmonary heart disease",
  adj    = c(0.5, 0),
  font   = 2,
  cex    = 1.15
)

# left hand column of labels
text(x = 0, y = 100, labels = "", adj = c(0, 0), font = 2, cex = 1)
text(x = 0, y = locs$YLocs, adj = 0, cex = 1, font = ifelse(forest1$IsDiamond, 2, 1), labels = left.labels[-blank.rows])
text(x = 0, y = locs$BlankLocs, adj = 0, font = 2, cex = 1, labels = left.labels[blank.rows])

# adding other columns ----

# For HF
column1.xpos <- xaxmin1 - 2
text(x = column1.xpos, y = 100, adj = c(1, 0), font = 2, cex = 1, labels = convertUnicode("No. of\nevents"))
text(
  x      = column1.xpos,
  y      = locs$YLocs,
  font   = ifelse(forest1$IsDiamond, 2, 1),
  adj    = 1,
  cex    = 1,
  labels = convertUnicode(as.character(region_forest[[1]][, other.cols[1]]))[-blank.rows]
)

text(
  x      = column1.xpos,
  y      = locs$BlankLocs,
  adj    = 1,
  cex    = 1,
  labels = convertUnicode(as.character(region_forest[[1]][, other.cols[1]]))[blank.rows]
)

# For PHD
column2.xpos <- xaxmin2 - 2
text(x = column2.xpos, y = 100, adj = c(1, 0), font = 2, cex = 1, labels = convertUnicode("No. of\nevents"))
text(
  x      = column2.xpos,
  y      = locs$YLocs,
  font   = ifelse(forest1$IsDiamond, 2, 1),
  adj    = 1,
  cex    = 1,
  labels = convertUnicode(as.character(region_forest[[2]][, other.cols[1]]))[-blank.rows]
)

text(
  x      = column2.xpos,
  y      = locs$BlankLocs,
  adj    = 1,
  cex    = 1,
  labels = convertUnicode(as.character(region_forest[[2]][, other.cols[1]]))[blank.rows]
)

# Heterogeneity labels
x_coord <- list("hf"  = 36.1003646765421, "phd" = 82.0423204683451)

# Get data for hetereogeneity--
het_df <- map(.x = region_forest, ~filter(.x, !is.na(Chi2)) %>% select(DF:p_int))
n_row_het <- map(.x = het_df, ~ nrow(.x))

index = 1

  for (H in seq_len(n_row_het[[index]])) {
    chi_DF   <- het_df[[index]]$DF[H]
    chi_val  <- round(het_df[[index]]$Chi2[H], 2)
    p_value  <- het_df[[index]]$p_int[H]
    p_value  <- ifelse(p_value < 0.0001, paste0("p", "<0.0001"), paste0("p=", round(p_value, 4)))
    text(
      x      = x_coord[[index]],
      y      = locs$HetLocs[H],
      adj    = 0,
      cex    = 0.8,
      labels = bquote(Het: ~ chi[.(chi_DF)] ^ 2 ~ "=" ~ .(chi_val) ~ (.(p_value)))
    )
    
  }

# Labels for PHD
# Heterogeneity labels for PHD
index = 2

  for (H in seq_len(n_row_het[[index]])) {
    chi_DF   <- het_df[[index]]$DF[H]
    chi_val  <- round(het_df[[index]]$Chi2[H], 2)
    p_value  <- het_df[[index]]$p_int[H]
    p_value  <- ifelse(p_value < 0.0001, paste0("p", "<0.0001"), paste0("p=", round(p_value, 4)))
    text(
      x      = x_coord[[index]],
      y      = locs$HetLocs[H],
      adj    = 0,
      cex    = 0.8,
      labels = bquote(Het: ~ chi[.(chi_DF)] ^ 2 ~ "=" ~ .(chi_val) ~ (.(p_value)))
    )
    
  }

# stop writing to file
closeFile(type)

```



# Effect of confounding (sequential and adjustment) --

## Proportion of Chi2 explained by predictors

Compute percentage of Chi2 explained by each predictor 

- Basic adjustment will include: stratification by age,sex, and area, and adjustment for education


```{r}

adjustment_vars
# Create a nested list to hold variable names and labels 
# Labels will be needed for the forest plot 

sequential_adjust_list <- 
  list(
    "minimal adjustment" = c("h_income"), 
    "ses" = list(
      "var_names" = c("edu", "agric_factory"), 
      "var_labels" = c(
            "     + Education", 
            "     + Occupation")
    ),
    "lifestyle" = list( # Lifestyle --
      "var_names" = c("smoking_status", "alcohol_recode","sed_time_hr_Q4"), 
      "var_labels" = c(
            "    + Smoking",
            "    + Alcohol consumption",
            "    + Sedentary time")
    ), 
    "cld" = list( #Chronic lung disease --
      "var_names" = c("copd", "emphysema_bronchitis"), 
      "var_labels" = c(
            "    + COPD",
            "    + Emphysema or bronchitis")
    )
)

adjustment_vars <- NULL
do_print <- FALSE
 
# 1. Minimal adjustments --

df_minimal <- 
  
      map(
        .x = data_expanded, 
        ~lrtest_change_chi2(
            dataset = .x, 
            main_expo_var  = "met4", 
            minimal_adjustment = TRUE,
            stratify_vars  = c("age_lexis5", "sex", "region"), 
            confounder_adjustment_label = "Minimal adjustment", 
            adjustment_vars  = sequential_adjust_list$`minimal adjustment`, 
            print_model_info = do_print)
        )
  
# 2. Socioeconomic status --

  # Simplify variable name and label 

  factors_ses <- sequential_adjust_list$ses$var_names  
  factors_lab_ses <- sequential_adjust_list$ses$var_labels
    
  df_ses <-  list()
  
  
  for (df in seq_along(data_expanded)) {
    
    
    list_ses <- list() 
        
        for (S in seq_along(factors_ses)){
          
          
          if(S > 1){
            
            adjust_ses <- c(
              
                sequential_adjust_list$`minimal adjustment`, # Covariates used for minimal adjustment 
                factors_ses[ seq_len(S-1) ] # Perform sequential adjustment for previous covariates
             
                )
          
          } else {adjust_ses <- c(sequential_adjust_list$`minimal adjustment`)}
          
          
          list_ses[[S]] <- 
            
            lrtest_change_chi2(
      
                dataset = data_expanded[[df]], 
                main_expo_var  = "met4", 
                confounder_vars = factors_ses[S],
                stratify_vars  = c("age_lexis5", "sex", "region"), 
                confounder_adjustment_label = factors_lab_ses[S], 
                adjustment_vars  = adjust_ses, 
                minimal_adjustment = FALSE,
                print_model_info = do_print) 
          
          
          }

    # Combine datasets --
    df_ses[[df]] <- bind_rows(list_ses)%>% 
                         dplyr::mutate(name_group = "Demographic and SES factors") # Create group name
  
  
  }
  
  
# 3. Lifestyle factors --

  # Simplify variable name and label 

  factors_ls <- sequential_adjust_list$lifestyle$var_names  
  factors_lab_ls <- sequential_adjust_list$lifestyle$var_labels
    
  df_lifestyle <-  list()
  
  
  for (df in seq_along(data_expanded)) {
    
    
    list_lifestyle <- list() 
        
        for (l in seq_along(factors_ls)){
          
          
          if(l > 1){
            
            adjust_ls <- c(
                
                sequential_adjust_list$`minimal adjustment`, # Covariates used for minimal adjustment
                sequential_adjust_list$ses$var_names,        # Covariates used for ses
                factors_ls[ seq_len(l-1) ] # In addition, adjust for previous lifestyle factors
             
                )
            
          
          } else {adjust_ls <- c(sequential_adjust_list$`minimal adjustment`, 
                                 sequential_adjust_list$ses$var_names)}
          
          
          
          list_lifestyle[[l]] <- 
            
            lrtest_change_chi2(
      
                dataset = data_expanded[[df]], 
                main_expo_var  = "met4", 
                confounder_vars = factors_ls[l],
                stratify_vars  = c("age_lexis5", "sex", "region"), 
                confounder_adjustment_label = factors_lab_ls[l], 
                adjustment_vars  = adjust_ls, 
                minimal_adjustment = FALSE,
                print_model_info = do_print) 
          
          }

    # Combine datasets --
    df_lifestyle[[df]] <- bind_rows(list_lifestyle)%>% 
                               dplyr::mutate(name_group = "Lifestyle factors")
  
  }


# 3. CLD --
  
  
  factors_pm <- sequential_adjust_list$cld$var_names  
  factors_lab_pm <- sequential_adjust_list$cld$var_labels
    
  df_pm <-  list()
  
  
  for (df in seq_along(data_expanded)) {
    
    
    list_pm <- list() 
        
        for (p in seq_along(factors_pm)){
           
          
          if(p > 1){
            
            adjust_pm <- c(
                sequential_adjust_list$`minimal adjustment`,
                sequential_adjust_list$ses$var_names,
                sequential_adjust_list$lifestyle$var_names,
                factors_pm[ seq_len(p-1) ] 
             )
            
          
            } else{
            
            adjust_pm <- c(
                sequential_adjust_list$`minimal adjustment`,
                sequential_adjust_list$ses$var_names,
                sequential_adjust_list$lifestyle$var_names
          
                )
            
          }
          
          
          
          list_pm[[p]] <- 
            
            lrtest_change_chi2(
      
                dataset = data_expanded[[df]], 
                main_expo_var  = "met4", 
                confounder_vars = factors_pm[p],
                stratify_vars  = c("age_lexis5", "sex", "region"), 
                confounder_adjustment_label = factors_lab_pm[p], 
                adjustment_vars  = adjust_pm, 
                minimal_adjustment = FALSE,
                print_model_info = do_print
                
              )   
          
          }

    # Combine datasets --
    df_pm[[df]] <- bind_rows(list_pm) %>% 
                       dplyr::mutate(name_group = "Chronic lung disease")
  
  }


  # Prepare to bind rest of dataset from the minimally adjusted results ---
  # Harmonise column names before binding 
  # Bind datasets 
  
   df_minimal_temp <- 
    
     map(.x = df_minimal, 
         ~.x %>% 
           select(-c(p_value_before, confounder_adjust_before, adjustment)) %>% 
           mutate(chi2_after = chi2_before) %>%  # For minimally adjusted models, use Chi2 before 
           rename("df" = df_before)
         )
  
   
   
  df_bind_temp <- 
    
    map2(
      .x = df_ses, 
      .y = df_lifestyle, 
      ~bind_rows(.x, .y)) %>% 
    
   map2(.y = df_pm, 
        ~bind_rows(.x, .y) %>% 
          select(-c(p_value_before, 
                    confounder_adjust_before, 
                    df_after, 
                    p_value_after, 
                    confounder_adjust, 
                    chi_change)
                 ) %>% 
          rename("df" = df_before)
        
        )
  
  

  # Bind all datasets --
  
  df_mediation <-  map2(
    
        .x = df_minimal_temp, 
        .y = df_bind_temp, 
        ~bind_rows(.x, .y) %>% 
          
          mutate(
            est_corrected = estimate/RDR,   # Correct estimates and SE for regression dilution
            se_corrected = std.error/RDR,
            chi2_after = format(round(chi2_after, 1), nsmall = 1, scientific = FALSE),
            IsDiamond = 0, 
            FillColour = 1
            ) %>%  
          rename("Heading" = adjust_label) %>% 
         as.data.frame(.)                   # Force into a dataframe for plotting with Jasper
        
        )  
  

source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/add_table_header.R")

df_mediation <- 
    map(.x = df_mediation,
        ~dplyr::mutate(.x, name_group = ifelse(is.na(name_group), Heading, name_group)) %>% 
          add_table_header(data = .,
                          group_var       = name_group, 
                          group_level_var = Heading, 
                          extra_space     = FALSE) %>% 
          slice(-1) %>%
          dplyr::mutate(Show = ifelse(is.na(FillColour), NA, 1)) %>%
          as.data.frame(.)
        )



```

## Mediation plotting 

```{r}

n_label <- 
  
  map(.x = data_expanded, 
      ~paste0( "(n=", prettyNum(sum(.x$lex.Xst, na.rm = TRUE), big.mark = ",",  scientific = FALSE),  ")"  ) )

# Format dataset ----

# set up an object that stores the forest and associated metadata
forest1 <- FormatForest(
              rawdata     = df_mediation[[1]] %>% 
                                 rename("IsDiamond1" = IsDiamond, 
                                        "FillColour1" = FillColour,
                                        "Show1" = Show), 
              forest.n    = 1, 
              EstimateCol = "est_corrected",  
              StdErrCol   = "se_corrected",
              logData     = FALSE, 
              getBlanks   = TRUE)

# set up an object that stores the forest and associated metadata
forest2 <- FormatForest(
             rawdata     = df_mediation[[2]] %>% 
                                 rename(
                                   "IsDiamond2" = IsDiamond,
                                   "FillColour2" = FillColour, 
                                   "Show2" = Show) ,  
             forest.n    = 2, 
             EstimateCol = "est_corrected",  
             StdErrCol   = "se_corrected",
             logData     = FALSE,  
             getBlanks   = TRUE)

blank.rows  <- forest1$blank.rows 

# Format headings to incorporate expressions -----

# find labels to put in the left most column
left.labels <- convertUnicode(as.character(df_mediation[[1]]$Heading))


# what other columns should be plotted
other.cols  <- "chi2_after"

# find column headings
print.headings <- parseColHeadings(df_mediation[[1]]$ColHeadings, rd=df_mediation[[1]])


# Make forest plot -----

type <- "PNG"

SetPage(orient          = "LANDSCAPE",
        png_bg          = "white",
        perpage         = 1, 
        type            = type, 
        filestem        = "eFigure 1 serial adjustment for confounding", 
        page_dpi        = 300,
        page_pointsize  = 10,
        # page_height     = 14,
        page_width      = 10,
        append_datetime = FALSE, 
        suppress.date   = TRUE, 
        titlespace      = 0.05, 
        footerspace     = 0.06, 
        footer.cex      = 1.5, 
        footer    = "The minimally adjusted model was stratified by age-at-risk, sex, and all 10 study areas and adjusted for income. 
COPD = Chronic obstructive pulmonary disease; SES = Socioeconomic status\n\n" 
        )

# Set page margins: format is c(bottom, left, top, right)
par(mar=c(5.14537797266251, 0.5, 9.14537797266251, 0.5))

mainfont <- 1.0
blankPlot(c(0,100),c(0,100), mainfont)
par(xpd=NA)

spacing <- 1
plot.width <- 10

# draw the Forest plot(s)
xaxmin1 <- 24.2542
xaxmax1 <- xaxmin1 + plot.width

xaxmin2 <- 63.5592
xaxmax2 <- xaxmin2 + plot.width

x_label <- "HR (95% CI) per 4 MET-hr/day\n higher usual total physical acitivity"

locs <- list()

for (df in seq_along(df_mediation)) {
  
  
  locs[[df]] <- ForestBasic( 
                list(forest1, forest2)[[df]],
              	LogScale=TRUE,
              	ExponentiateDataOnPlot=TRUE,
              	xaxmin= c(xaxmin1, xaxmin2)[df],
              	xaxmax= c(xaxmax1, xaxmax2)[df],
              	xlim=c(0.7, 1.1),
              	xticks=c(0.7, 1.0, 1.1),
              	ticklabs=c("0.7", "1.0", ""),
              	xlab= x_label,
              	NLabel=FALSE,
              	mainfont=1,
              	ValueLabels=TRUE,
              	ValueLabelsHeader="HR (95% CI)",
              	ValueDigits=NULL,
              	lwd=0.8,
              	CISecond=TRUE,
              	spacing=spacing,
              	pointGroupsFactor=0.9,
              	verbose=FALSE,
              	boxsizeoverride=FALSE,
              	boxparm.stderr = 0.005)


# Adding headings and other columns ----

## Panel titles --
  
    # Main title --
    x_main_pos <- c(xaxmin1 + (xaxmax1 - xaxmin1 + (spacing) )/2, 
                    xaxmin2 + (xaxmax2 - xaxmin2 + (spacing) )/2)
    text(
      x= x_main_pos[df] , 
      y=115, 
      labels= c("A. Heart failure", "B. Pulmonary heart disease")[df], 
      adj=c(0.5,0), 
      font=2, 
      cex = 1.1, 
      col="black")
    
    # Event title --
    text(x=x_main_pos[df], y=110, labels= n_label[df], adj=c(0.5,0), font=1, cex = 1)

    ## Add other columns for both outcomes --
    x.positions <- c(xaxmax1 + 18, xaxmax2 + 18)
    
    # Header --
    text(x= x.positions[df], y=100, labels=expression(chi[1]^2), adj=c(1,0), font=2, cex=1)
    
    # Contents --
    if(is.null(blank.rows)){
      
      text(
       x=x.positions[df], 
       y= locs[[df]]$YLocs, 
       labels=convertUnicode(as.character(df_mediation[[df]] [,other.cols[1]])), 
       font=ifelse(forest1$IsDiamond, 2, 1),, 
       adj=1, 
       cex=1)
      
    } else {
      
      text(
       x=x.positions[df], 
       y= locs[[df]]$YLocs, 
       labels=convertUnicode(as.character(df_mediation[[df]] [,other.cols[1]]))[-blank.rows], 
       font=ifelse(forest1$IsDiamond, 2, 1),, 
       adj=1, 
       cex=1)
      
    }
    
    
    # Labels for blank rows -- 
    if(is.null(blank.rows)){
      
      text(
       x=x.positions[df],
       y= locs[[df]]$BlankLocs,
       labels=convertUnicode(as.character(df_mediation[[df]] [,other.cols[1]])), ,
       adj=1,
       cex=1)
      
    } else {
      
      text(
       x=x.positions[df],
       y= locs[[df]]$BlankLocs,
       labels=convertUnicode(as.character(df_mediation[[df]] [,other.cols[1]]))[blank.rows], ,
       adj=1,
       cex=1)
    }
    
  
}


# left hand column of labels for HF forest --

text(x=4, y=100, labels="Adjustments", adj=c(0,0), font=2, cex=1.1)

  if(is.null(blank.rows)){
    
    text(x=4, y=locs[[1]]$YLocs, labels=left.labels, adj=0, cex=1, font=ifelse(forest1$IsDiamond, 2,1))
    text(x=4, y=locs[[1]]$BlankLocs, labels=left.labels, adj=0, font=2, cex=1)
  
    } else {
      
    text(x=4, y=locs[[1]]$YLocs, labels=left.labels[-blank.rows], adj=0, cex=1, font=ifelse(forest1$IsDiamond, 2,1))
    text(x=4, y=locs[[1]]$BlankLocs, labels=left.labels[blank.rows], adj=0, font=2, cex=1)
  
  }



##Plot title 
text(x=50.5, 
     y= 125, 
     font=2, 
     cex = 1.1,
     adj=c(0.5, 0),
     col="black",
     labels="eFigure 1: Hazard ratio (95% CI) of heart failure and pulmonary heart disease per 4 MET-hr/day higher usual total physical acitivity\nwith sequential adjustment for confounding")

# stop writing to file
closeFile(type)

```



# Sensitivity analysis

Sensitivity analysis will include the following 

1. Further adjustments for waist circumference and BMI 

2. Sequential exclusion based on the following criteria 
  a. Excluding the first two years of follow-up
  b. Excluding participants with poor self-rated heath at baseline
  c. Excluding participants with chronic lung disease 
  d. Excluding participants with SOB on walking at baseline 
  f. Excluding participants with co-occurring PHD or HF 

**Sex-specific quintiles were recalculated after each exclusion**

Show the association between studied over time? (shape and strength?)


## select relevant variables
To save memory

```{r}

adjust <- c(ses_vars, 
            lifestyle_vars, 
            "heart_rate_mean_Q4", 
            "waist_circ_cm_Q4", 
            "diabetes",  
            "emphysema_bronchitis", 
            "HTN",
            "copd", 
            "waist_circ_cm_Q4", 
            "bmi_calc_Q4") 

strata_vars <- c("age_lexis5", "sex","region")

expos       <- c("met_q5_sex", "met4", "metsd", "met")

outcome     <- c("lex.dur", "lex.Xst")

exclusion   <- c("poor_health", "SOB_walking", "CLD")

exit_status <- c("HF_combined_ep", "PHD_combined_ep")


sensitivity_vars <- c(adjust, strata_vars, expos, outcome, exclusion, exit_status)

# Select variables --------------------------------------------------------------------------------------------------------------------

data_expanded <- map(.x = data_expanded, ~select(.x, all_of(sensitivity_vars)))

```


## 1. Further adjustments

Do further adjustments for BMI, WC, hypertension, and diabetes

```{r}

# source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/Cox_shape_strength_data.R")

main_adjust <- c(
  
  ses_vars, 
  lifestyle_vars,   
  "emphysema_bronchitis", 
  "copd"
  
           ) 


sens_adjust_vars <- c(
  
  "bmi_calc_Q4", 
  "waist_circ_cm_Q4", 
  "diabetes",
  "HTN"
  )

# Create lists to hold data 
shape_sens1    <- list()
met_cont_sens1 <- list()
metsd_sens1    <- list()


for (m in seq_along(sens_adjust_vars)) { 
  
  sens_adjust_vars_temp <- NULL
  sens_adjust_vars_temp <- sens_adjust_vars[seq_len(m)]

  adjust <- NULL  
  adjust <- c(main_adjust, sens_adjust_vars_temp)


# SHape ------------------------------------------------------------------------------------------------------------------

shape_sens1[[m]] <- 
  
  map(.x = data_expanded, 
                   
       ~Cox_shape_strength_data(
         
             dataset                     = .x, 
             exposure_var_cat            = "met_q5_sex", 
             expo_type_shape             = TRUE,
             correct_regression_dilution = FALSE,
             adjustment_vars             = adjust, 
             print_model_info = FALSE
                                      
      ) %>% 
         
       pluck(., 2) %>%
       dplyr::mutate(PA_resurv_mean = resurv_met_df$mean_met_resurvey,
                     analysis = paste0("Further adjustment for ",
                                            paste0(sens_adjust_vars_temp, collapse = ", "))
                     )
                     
 )



# Met4 --------------------------------------------------------------------------------------------------------------------
  
met_cont_sens1[[m]] <- 
    
    map(
      
      .x = data_expanded,
                   
         ~Cox_shape_strength_data(
           
           dataset                      = .x, 
           exposure_var_cont           = "met4", 
           expo_type_continuous        = TRUE,
           correct_regression_dilution = TRUE, 
           regression_dilution_ratio   = RDR,
           adjustment_vars             = adjust, 
           print_model_info = FALSE
                                    
                                    
           ) %>% 
           
           pluck(., 2) %>%
           dplyr::mutate(analysis = paste0("Further adjustment for ",
                                            paste0(sens_adjust_vars_temp, collapse = ", ")))
         
      )


# METSD -------------------------------------------------------------------------------------------------------------------

metsd_sens1[[m]] <- 
    
    map(
      
      .x = data_expanded,
                   
         ~Cox_shape_strength_data(
           
           dataset           = .x, 
           exposure_var_sd   = "metsd",
           expo_type_sd      = TRUE,
           correct_regression_dilution = TRUE,
           adjustment_vars   = adjust, 
           print_model_info = FALSE
                                    
           ) %>% 
            
           pluck(., 2) %>%
           dplyr::mutate(analysis = paste0("Further adjustment for ",
                                           paste0(sens_adjust_vars_temp, collapse = ", ")))
         
      )

}


```


### Re-arrange lists

The exposures should be nested within the datasets. Not the other way around 

That is 

list 1 - Heart failure 
    Sublists
       - Exposure 1
       - Exposure 2
       - Exposure 3
       - Exposure 4

list 2 - PHD
    Sublists
       - Exposure 1
       - Exposure 2
       - Exposure 3
       - Exposure 4
       
Then flatten the list


```{r}

shape_sens_df    <- list()
met_cont_sens_df <- list()
metsd_sens_df    <- list()


for (df in seq_along(data_expanded)) {
  
  shape_sens_df[[df]]    <- map(.x = shape_sens1, ~pluck(.x, df) %>% 
                                  dplyr::mutate(outcome = c("hf", "phd")[df])) 
  
  met_cont_sens_df[[df]] <- map(.x = met_cont_sens1, ~pluck(.x, df)%>% 
                                  dplyr::mutate(outcome = c("hf", "phd")[df])) 
  
  metsd_sens_df[[df]] <- map(.x = metsd_sens1, ~pluck(.x, df)%>% 
                                  dplyr::mutate(outcome = c("hf", "phd")[df])) 

}


# Bind data for main model (for plotting)
#========================================

shape_sens_df <- 
  
  map2(
    
    .x = FAR,
    .y = seq_along(FAR),
    
    ~c(
      list(.x %>% 
             # Manipulate column headings 
             
             rename("PA_resurv_mean" = mean_met) %>% 
             dplyr::mutate(
               
               analysis = "main", 
               outcome  = c("hf", "phd")[.y])
           
           ), 
      
      shape_sens_df[[.y]]
      
      )
    
)

# Bind MET4 data from main analysis
#==================================

met_cont_sens_df <- 
  
  map2(
    
      .x = model_cont,
      .y = seq_along(model_cont),
      
      ~c(
        list(.x %>% 
               # Manipulate column headings 
               filter(exposure == "met4") %>% 
               rename("term" = exposure) %>% 
               
               dplyr::mutate(
                 
                 analysis = "main", 
                 outcome  = c("hf", "phd")[.y])
             
             ), 
        
        met_cont_sens_df[[.y]]
        
        )
      
)


# Bind METSD data from main analysis
#====================================

metsd_sens_df <- 
  
  map2(
    
      .x = model_cont,
      .y = seq_along(model_cont),
      
      ~c(
        list(.x %>% 
               # Manipulate column headings 
               filter(exposure == "metsd") %>% 
               rename("term" = exposure) %>% 
               
               dplyr::mutate(
                 
                 analysis = "main", 
                 outcome  = c("hf", "phd")[.y])
             
             ), 
        
        metsd_sens_df[[.y]]
        
        )
      
)



# Flatten the datasets

shape_sens_df    <- flatten(shape_sens_df)
met_cont_sens_df <- flatten(met_cont_sens_df)
metsd_sens_df    <- flatten(metsd_sens_df)


```


### Plot shape data 

```{r}

# Get plot data 
#==============

plotdata <- 
  
  map (
    
    .x = shape_sens_df, 
    
    ~data.frame(
      
      RF_Level = .x$PA_resurv_mean, 
      Estimate = .x$estimate, 
      StdErr   = .x$quasiSE, 
      Events   = .x$n, 
      exp_est  =  exp(.x$estimate), 
      outcome  = .x$outcome
      
      ) %>% 
      
  `row.names<-`(NULL)
) 

    
# Get labels for number of events 
#================================
    
events_sum <- map(
  
  .x =shape_sens_df, 
  
  ~paste0(
    
    "(n=", 
    prettyNum(sum(.x$n), big.mark   = ",", scientific = FALSE), 
    ")"
    
    )
                        
)

# Get labels for continuous 
#==========================

met4_labels <- 
     map(
       
       .x = met_cont_sens_df, 
         
         ~.x %>% 
           dplyr::mutate(
             
             term_level  = "4 MET-hour/day", 
             hr_ci = paste0(
               
               format(round(hr_corrected,  2), nsmall = 2L), " (",
               format(round(lci_corrected, 2), nsmall = 2L), " - ", 
               format(round(uci_corrected, 2), nsmall = 2L), ")"
                
               )
             
             ) %>%
         
           select(term, term_level, hr_ci, analysis, outcome)
         )
    
# Get labels for metsd
#=====================

metsd_labels <- 
     map(
       
       .x = metsd_sens_df,  
         
         ~.x %>%    
           dplyr::mutate(
             
             term_level = "1 SD MET-hour/day", 
             hr_ci = paste0(
               
               format(round(hr_corrected,  2), nsmall = 2L), " (",
               format(round(lci_corrected, 2), nsmall = 2L), " - ", 
               format(round(uci_corrected, 2), nsmall = 2L), ")"
               
               )
             
             ) %>% 
         
           select(term, term_level, hr_ci, analysis, outcome)
         )

# Bind met4 and metsd 
#====================

hr_cont_labels <- 
         
  map2(
           
     .x = met4_labels, 
     .y = metsd_labels, 
        
     ~rbind(.x, .y)
     
  )
    

 
headers <- c(
  
  "A: Main model",
  "B: (A) + BMI",
  "C: (B) + WC",
  "D: (C) + diabetes",
  "E: (D) + hypertension")


## Subheadings for panels: A. Heart failure and B. Pulmonary heart disease 
n_expo <- length(sens_adjust_vars)

outcome <- c(
  
  "Heart failure", 
  rep(NA, n_expo),
  
  "Pulmonary heart disease", 
  rep(NA, n_expo)
  
  )


yaxisL  <- c(
  
  "Hazard ratio (95% CI)", 
  rep(NA, n_expo),
  
  "Hazard ratio (95% CI)", 
  rep(NA, n_expo)
  
  )

xaxisL  <- c(rep(NA, n_expo+1), 
             rep("Usual total physical activity, MET-hour/day", n_expo+1))



# set up the Jasper page
type <- "PNG"
SetPage(
  
  orient         = "LANDSCAPE",
  perpage        = 10,
  type           = type, 
  png_bg         = "white",
  page_width     = 18,
  page_height    = 12,
  page_dpi       = 600,
  page_pointsize = 11,
  suppress.date  = TRUE,
  titlespace     = 0.12, 
  footerspace    = 0.06,
  footer.cex = 1.5,
  footer  ="The main model was stratified by age-at-risk, sex, and study area and adjusted for income, education, occupation, alcohol, smoking, sedentary time, ephysema, bronchitis and COPD
  \n
        ",
  filestem       = "eFigure 3 - Sensitivity analysis PA (further adjustments)"
  
  )

par(mar=c(1,1,1,1))


# loop over the panels in a slightly strange order, to match data
for (j in seq_along(plotdata)) {

	LinearPlot( 
	  
	   plotdata[[j]], 
     new.plot          = TRUE, 
     mainfont          = 1,   
     YLogScale         = TRUE, 
     ExponentiateDataOnPlot = TRUE,
     boxparm.stderr    = 0.025, 
     xlim              = c(10,30),  
     xticks            = seq(10,30, 5), 
     ylim              = c(0.25, 2), 
     yticks            = c(0.25, 0.5, 1, 2), 
     margins           = c(5,5,3,2),  
     xticklabs.cex     = 0.9, 
     yticklabs.cex     = 0.9,
     PointLabelsTop    = "exp_est",
     PointLabelsBottom = "Events",
     PointLabelsCEX    = 0.8, 
     TruncateAtPlotLims = FALSE,
     CIsOnTop           = TRUE
	   
	   )
	
	# add axis labels
	AxisLabels(ylab=yaxisL[[j]],  
	           xlab=xaxisL[[j]], 
	           mainfont=0.9)
	
	par(xpd=NA)
	
	
	# add the column heading
	
	if(j <= n_expo+1) {
	 text(x=20, y=log(3.2), labels=headers[j], font=2, cex = 1)
	}
	
	 text(x=20,  y=log(1.9), labels = events_sum[[j]], font=1, cex = 1)
	 text(x=10,  y=log(2.2), labels = outcome[[j]], font=2, adj=c(0,0), cex = 1.2)
	
	
	# Add labels for HR 
	text(x      = 10, 
	     y      = log(0.26), 
	     labels = paste0("Per usual level\n", paste0(hr_cont_labels[[j]]$term_level, ":", collapse = "\n")), 
	     font   = 1, 
	     cex    = 0.8, 
	     adj    = c(0, 0)
	     )
	
	text(x      = 20.5, 
	     y      = log(0.26), 
	     labels = paste0("HR (95% CI)\n", paste0(hr_cont_labels[[j]]$hr_ci, collapse = "\n")), 
	     font   = 1, 
	     cex    = 0.8, 
	     adj    = c(0, 0)
	     )

 
  
}

## Plot title 
##Plot title

new.plot=TRUE

text(x      = -45, 
     y      = log(82), 
     font   = 2, 
     cex    = 1.3,
     adj    = c(0.5, 0),
     labels = "eFigure 3: Associations of total physical activity with heart failure and pulmonary heart disease after further sequential adjustment for body mass index (BMI), \nwaist circumference (WC), diabetes and hypertension")


closeFile(type)






```


## Further exclusion

## 2. Exclude 2 years follow up

```{r}

# Drop merged data to free memory
rm(merged_data)

adjust <- c(ses_vars, 
            lifestyle_vars,  
            "emphysema_bronchitis", 
            "copd") 

# Drop follow up time 
data_expanded_fu2 <- map(.x = data_expanded, ~.x[.x$lex.dur > 2, ])

# Recalculate met4, metsd, sex-specific Q5 ---------------------------------------------------------------------------------------------
data_expanded_fu2 <- 
  
  map(.x = data_expanded_fu2, 
    
    ~.x %>% dplyr::group_by(sex) %>% 
                   dplyr::group_split() %>% 
                   map( ~ .x %>% 
                           dplyr::mutate(met_q5_sex = factor(quantcut(met, 5), 
                                                             labels = c("Q1", "Q2", "Q3", "Q4", "Q5")), 
                                         
                                         met4       = met/4, 
                                         metsd      = scale(met)
                                         )
                        ) %>%
            map_dfr( ~rbind(.x))
      )

# Shape ------------------------------------------------------------------------------------------------------------------

shape_fu2 <- map(.x = data_expanded_fu2, 
                   
                   ~Cox_shape_strength_data(dataset                      = .x, 
                                             exposure_var_cat            = "met_q5_sex", 
                                             expo_type_shape             = TRUE,
                                             correct_regression_dilution = FALSE,
                                             adjustment_vars             = adjust, 
                                             print_model_info = FALSE ) %>% 
                     
                     pluck(., 2) %>% 
                     dplyr::mutate(PA_resurv_mean = resurv_met_df$mean_met_resurvey, 
                                   analysis       = "Exclude 2 years follow up")
                   )




# Met4 --------------------------------------------------------------------------------------------------------------------
  
met_cont_fu2 <- map(.x = data_expanded_fu2,
                   
         ~Cox_shape_strength_data(dataset                      = .x, 
                                   exposure_var_cont           = "met4", 
                                   expo_type_continuous        = TRUE,
                                   correct_regression_dilution = TRUE, 
                                   regression_dilution_ratio   = RDR,
                                   adjustment_vars             = adjust, 
                                   print_model_info = FALSE) %>% 
           
           pluck(., 2) %>% 
           dplyr::mutate(analysis = "Exclude 2 years follow up")
         )


# METSD -------------------------------------------------------------------------------------------------------------------

metsd_fu2 <- map(.x = data_expanded_fu2,
                   
         ~Cox_shape_strength_data(dataset           = .x, 
                                  exposure_var_sd   = "metsd",
                                  expo_type_sd      = TRUE,
                                  correct_regression_dilution = TRUE,
                                  adjustment_vars   = adjust,
                                  print_model_info = FALSE) %>% 
            
           pluck(., 2) %>% 
           dplyr::mutate(analysis = "Exclude 2 years follow up")
         )

rm(data_expanded_fu2)

```


## 3. Exclude poor self-rated health 

```{r}

adjust <- c(ses_vars, 
            lifestyle_vars, 
            "emphysema_bronchitis", 
            "copd"
           ) 

# Drop 
## 1. follow up time +
## 2. Poor health + 

data_expanded_poorh <- map(.x = data_expanded, 
                           ~.x[.x$lex.dur > 2, ] %>% 
                             filter (poor_health == "No")
                           )


# Calculate sex-specific Q5 ---------------------------------------------------------------------------------------------
data_expanded_poorh <- 
  
  map(.x = data_expanded_poorh, 
    
    ~.x %>% dplyr::group_by(sex) %>% 
                   dplyr::group_split() %>% 
                   map( ~ .x %>% 
                           dplyr::mutate(met_q5_sex = factor(quantcut(met, 5), 
                                                             labels = c("Q1", "Q2", "Q3", "Q4", "Q5")), 
                                         
                                         met4       = met/4, 
                                         metsd      = scale(met)
                                         )
                        ) %>%
            map_dfr( ~rbind(.x))
      )


# Shape -----------------------------------------------------------------------------------------------------------------

shape_poorh <- map(.x = data_expanded_poorh, 
                   
                   ~Cox_shape_strength_data(dataset                      = .x, 
                                             exposure_var_cat            = "met_q5_sex", 
                                             expo_type_shape             = TRUE,
                                             correct_regression_dilution = FALSE,
                                             adjustment_vars             = adjust, 
                                             print_model_info = FALSE) %>% 
                     
                     pluck(., 2) %>% 
                     dplyr::mutate(PA_resurv_mean = resurv_met_df$mean_met_resurvey, 
                                   analysis       = "2 years fu + poor health")
                   )




# Met4 --------------------------------------------------------------------------------------------------------------------
  
met_cont_poorh <- map(.x = data_expanded_poorh,
                   
         ~Cox_shape_strength_data(dataset                      = .x, 
                                   exposure_var_cont           = "met4", 
                                   expo_type_continuous        = TRUE,
                                   correct_regression_dilution = TRUE, 
                                   regression_dilution_ratio   = RDR,
                                   adjustment_vars             = adjust, 
                                   print_model_info = FALSE
                                    
                                    ) %>% 
           
           pluck(., 2) %>% 
           dplyr::mutate(analysis = "2 years fu + poor health")
         )


# METSD -------------------------------------------------------------------------------------------------------------------

metsd_poorh <- map(.x = data_expanded_poorh,
                   
         ~Cox_shape_strength_data(dataset           = .x, 
                                  exposure_var_sd   = "metsd",
                                  expo_type_sd      = TRUE,
                                  correct_regression_dilution = TRUE,
                                  adjustment_vars   = adjust, 
                                  print_model_info = FALSE) %>% 
            
           pluck(., 2) %>% 
           dplyr::mutate(analysis = "2 years fu + poor health")
         )

rm(data_expanded_poorh)

```


## 4. Exclude participants with SOB at baseline 

```{r}


adjust <- c(ses_vars, 
            lifestyle_vars,  
            "emphysema_bronchitis", 
            "copd") 

# Drop 
## 1. follow up time +
## 2. Poor health + 

data_expanded_sob <- map(.x = data_expanded, 
                           ~.x[.x$lex.dur > 2, ] %>% 
                             filter (poor_health == "No", 
                                     SOB_walking == "No")
                           )


# Calculate sex-specific Q5 ---------------------------------------------------------------------------------------------
data_expanded_sob <- 
  
  map(.x = data_expanded_sob, 
    
    ~.x %>% dplyr::group_by(sex) %>% 
                   dplyr::group_split() %>% 
                   map( ~ .x %>% 
                           dplyr::mutate(met_q5_sex = factor(quantcut(met, 5), 
                                                             labels = c("Q1", "Q2", "Q3", "Q4", "Q5")), 
                                         
                                         met4       = met/4, 
                                         metsd      = scale(met)
                                         )
                        ) %>%
            map_dfr( ~rbind(.x))
      )

# Shape -----------------------------------------------------------------------------------------------------------------
shape_sob <- map(.x = data_expanded_sob, 
                   
                   ~Cox_shape_strength_data(dataset                      = .x, 
                                             exposure_var_cat            = "met_q5_sex", 
                                             expo_type_shape             = TRUE,
                                             correct_regression_dilution = FALSE,
                                             adjustment_vars             = adjust, 
                                             print_model_info = FALSE
                                              
                                              ) %>% 
                     
                     pluck(., 2) %>% 
                     dplyr::mutate(PA_resurv_mean = resurv_met_df$mean_met_resurvey, 
                                   analysis       = "2 years fu + poor health + SOB")
                   )




# Met4 --------------------------------------------------------------------------------------------------------------------
  
met_cont_sob <- map(.x = data_expanded_sob,
                   
         ~Cox_shape_strength_data(dataset                      = .x, 
                                   exposure_var_cont           = "met4", 
                                   expo_type_continuous        = TRUE,
                                   correct_regression_dilution = TRUE, 
                                   regression_dilution_ratio   = RDR,
                                   adjustment_vars             = adjust, 
                                  print_model_info = FALSE
                                    
                                    ) %>% 
           
           pluck(., 2) %>% 
           dplyr::mutate(analysis = "2 years fu + poor health + SOB")
         )


# METSD -------------------------------------------------------------------------------------------------------------------

metsd_sob <- map(.x = data_expanded_sob,
                   
         ~Cox_shape_strength_data(dataset           = .x, 
                                  exposure_var_sd   = "metsd",
                                  expo_type_sd      = TRUE,
                                  correct_regression_dilution = TRUE,
                                  adjustment_vars   = adjust,
                                  print_model_info = FALSE
                                    
                                    ) %>% 
            
           pluck(., 2) %>% 
           dplyr::mutate(analysis = "2 years fu + poor health + SOB")
         )

rm(data_expanded_sob)


```


## 5. Exclude chronic lung disease 

Chronic lung disease in this analysis includes 
- COPD
- TB
- Emphysema or bronchitis
- Asthma


```{r}


adjust <- c(ses_vars, lifestyle_vars) 

# Drop 
## 1. follow up time +
## 2. Poor health + 

data_expanded_cld <- map(.x = data_expanded, 
                           ~.x[.x$lex.dur > 2, ] %>% 
                             filter (poor_health == "No", 
                                     SOB_walking == "No", 
                                     CLD         == "No")
                           )


# Calculate sex-specific Q5 ---------------------------------------------------------------------------------------------
data_expanded_cld <- 
  
  map(.x = data_expanded_cld, 
    
    ~.x %>% dplyr::group_by(sex) %>% 
                   dplyr::group_split() %>% 
                   map( ~ .x %>% 
                           dplyr::mutate(met_q5_sex = factor(quantcut(met, 5), 
                                                             labels = c("Q1", "Q2", "Q3", "Q4", "Q5")), 
                                         
                                         met4       = met/4, 
                                         metsd      = scale(met)
                                         )
                        ) %>%
            map_dfr( ~rbind(.x))
      )

# Shape -----------------------------------------------------------------------------------------------------------------
shape_cld <- map(.x = data_expanded_cld, 
                   
                   ~Cox_shape_strength_data(dataset                      = .x, 
                                             exposure_var_cat            = "met_q5_sex", 
                                             expo_type_shape             = TRUE,
                                             correct_regression_dilution = FALSE,
                                             adjustment_vars             = adjust, 
                                             print_model_info = FALSE) %>% 
                     
                     pluck(., 2) %>% 
                     dplyr::mutate(PA_resurv_mean = resurv_met_df$mean_met_resurvey, 
                                   analysis       = "2 years fu + poor health + SOB + CLD")
                   )




# Met4 --------------------------------------------------------------------------------------------------------------------
  
met_cont_cld <- map(.x = data_expanded_cld,
                   
         ~Cox_shape_strength_data(dataset                      = .x, 
                                   exposure_var_cont           = "met4", 
                                   expo_type_continuous        = TRUE,
                                   correct_regression_dilution = TRUE, 
                                   regression_dilution_ratio   = RDR,
                                   adjustment_vars             = adjust, 
                                   print_model_info = FALSE) %>% 
           
           pluck(., 2) %>% 
           dplyr::mutate(analysis = "2 years fu + poor health + SOB + CLD")
         )


# METSD -------------------------------------------------------------------------------------------------------------------

metsd_cld <- map(.x = data_expanded_cld,
                   
         ~Cox_shape_strength_data(dataset           = .x, 
                                  exposure_var_sd   = "metsd",
                                  expo_type_sd      = TRUE,
                                  correct_regression_dilution = TRUE,
                                  adjustment_vars   = adjust,
                                  print_model_info = FALSE) %>% 
            
           pluck(., 2) %>% 
           dplyr::mutate(analysis = "2 years fu + poor health + SOB + CLD")
         )
    
rm(data_expanded_cld)



```


# 6. HF and PHD co-occurrence 
```{r}


# Continue here ---------------------------------------------------------------------------------------------------------------

adjust <- c(ses_vars, lifestyle_vars) 

# Drop 
## 1. follow up time +
## 2. Poor health + 

data_expanded_co_hf_phd <- map(.x = data_expanded, 
                               ~.x[.x$lex.dur > 2, ] %>% 
                                 filter (poor_health == "No", 
                                         SOB_walking == "No", 
                                         CLD         == "No") %>% 
                                 #Define co-morbid HF and PHD 
                                 dplyr::mutate(co_hf_phd = ifelse(HF_combined_ep == 1 & PHD_combined_ep == 1, "Yes", "No")) %>% 
                                 filter(co_hf_phd == "No")
                              )


# Calculate sex-specific Q5 ---------------------------------------------------------------------------------------------
data_expanded_co_hf_phd <- 
  
  map(.x = data_expanded_co_hf_phd, 
    
    ~.x %>% dplyr::group_by(sex) %>% 
                   dplyr::group_split() %>% 
                   map( ~ .x %>% 
                           dplyr::mutate(met_q5_sex = factor(quantcut(met, 5), 
                                                             labels = c("Q1", "Q2", "Q3", "Q4", "Q5")), 
                                         
                                         met4       = met/4, 
                                         metsd      = scale(met)
                                         )
                        ) %>%
            map_dfr( ~rbind(.x))
      )

# Shape -----------------------------------------------------------------------------------------------------------------
shape_hf_phd <- map(.x = data_expanded_co_hf_phd, 
                   
                   ~Cox_shape_strength_data(dataset                      = .x, 
                                             exposure_var_cat            = "met_q5_sex", 
                                             expo_type_shape             = TRUE,
                                             correct_regression_dilution = FALSE,
                                             adjustment_vars             = adjust, 
                                             print_model_info = FALSE) %>% 
                     
                     pluck(., 2) %>% 
                     dplyr::mutate(PA_resurv_mean = resurv_met_df$mean_met_resurvey, 
                                   analysis       = "2 years fu + poor health + SOB + CLD + co-HF and PHD")
                   )




# Met4 --------------------------------------------------------------------------------------------------------------------
  
met_cont_hf_phd <- map(.x = data_expanded_co_hf_phd,
                   
         ~Cox_shape_strength_data(dataset                      = .x, 
                                   exposure_var_cont           = "met4", 
                                   expo_type_continuous        = TRUE,
                                   correct_regression_dilution = TRUE, 
                                   regression_dilution_ratio   = RDR,
                                   adjustment_vars             = adjust, 
                                   print_model_info = FALSE) %>% 
           
           pluck(., 2) %>% 
           dplyr::mutate(analysis = "2 years fu + poor health + SOB + CLD + co-HF and PHD")
         )


# METSD -------------------------------------------------------------------------------------------------------------------

metsd_hf_phd <- map(.x = data_expanded_co_hf_phd,
                   
         ~Cox_shape_strength_data(dataset           = .x, 
                                  exposure_var_sd   = "metsd",
                                  expo_type_sd      = TRUE,
                                  correct_regression_dilution = TRUE,
                                  adjustment_vars   = adjust, 
                                  print_model_info = FALSE) %>% 
            
           pluck(., 2) %>% 
           dplyr::mutate(analysis = "2 years fu + poor health + SOB + CLD + co-HF and PHD")
         )

rm(data_expanded_co_hf_phd)



```


## Bind all data for sensitivity analysis 

```{r}

shape      <- map(.x = seq_along(shape_fu2), 
                  ~c(shape_fu2[.x], 
                     shape_poorh[.x], 
                     shape_sob[.x], 
                     shape_cld[.x], 
                     shape_hf_phd[.x]
                     )
                  )

strng_cont <- map(.x = seq_along(met_cont_fu2), 
                  ~c(met_cont_fu2[.x], 
                     met_cont_poorh[.x], 
                     met_cont_sob[.x], 
                     met_cont_cld[.x], 
                     met_cont_hf_phd[.x]
                     )
                  )

metsd      <- map(.x = seq_along(metsd_fu2),
                  ~c(metsd_fu2[.x], 
                     metsd_poorh[.x], 
                     metsd_sob[.x], 
                     metsd_cld[.x], 
                     metsd_hf_phd[.x]
                     )
                  )
```


## Plot data for sensitivity analysis 

```{r}


# select which columns we want, and give them appropriate names
plotdata   <- list()
events_sum <- list()

hr_cont_labels <- list()
met4_labels    <- list()
metsd_labels   <- list()

for (sh in seq_along(shape)) {
  
    plotdata[[sh]] <- map(.x = shape[[sh]], ~data.frame(RF_Level = resurv_met_df$mean_met_resurvey, 
                                                        Estimate = .x$estimate, 
                                                        StdErr   = .x$quasiSE, 
                                                        Events   = .x$n, 
                                                        exp_est  = exp(.x$estimate)
                                                        ) %>% 
                                             `row.names<-`(NULL)
                          )
    
    # Get labels for number of events 
    events_sum[[sh]] <- map(.x = shape[[sh]], ~paste0("(n=", 
                                                      prettyNum(sum(.x$n), 
                                                                big.mark   = ",", 
                                                                scientific = FALSE), 
                                                      ")")
                            )
    
    # Get labels for continuous 
    met4_labels[[sh]] <- 
             map(.x = strng_cont[[sh]], 
                 
                 ~.x %>% 
                   dplyr::mutate(term_level  = "4 MET-hour/day", 
                                 hr_ci = paste0(format(round(hr_corrected,  2), nsmall = 2L), " (",
                                                format(round(lci_corrected, 2), nsmall = 2L), " - ", 
                                                format(round(uci_corrected, 2), nsmall = 2L), ")")) %>% 
                   select(term, term_level, hr_ci, analysis)
                 )
    
    # Get labels for metsd
    metsd_labels[[sh]] <- 
             map(.x = metsd[[sh]], 
                 
                 ~.x %>%  
                   dplyr::mutate(term_level  = "1 SD MET-hour/day", 
                                 hr_ci = paste0(format(round(hr_corrected,  2), nsmall = 2L), " (",
                                                format(round(lci_corrected, 2), nsmall = 2L), " - ", 
                                                format(round(uci_corrected, 2), nsmall = 2L), ")")) %>% 
                   select(term, term_level, hr_ci, analysis)
                 )
    
    # Bind met4 and metsd 
    hr_cont_labels[[sh]] <- 
             map2(.x = met4_labels[[sh]], 
                  .y = metsd_labels[[sh]], 
                  
                  ~rbind(.x, .y))
    
} 
 

headers <- c("A: Excluding the first two years\nof follow-up",
             "B: (A) + excluding poor self-rated health",
             "C: (B) + excluding shortness of breath\n on walking",
             "D: (C) + excluding chronic \nrespiratory disease",
             "E: (D) + excluding co-occurring HF\nand PHD")


## Subheadings for panels: A. Heart failure and B. Pulmonary heart disease 
outcome <- list(c("Heart failure", rep(NA, 4)),
                c("Pulmonary heart disease", rep(NA, 4)))

yaxisL  <- list(c("Hazard ratio (95% CI)", rep(NA, 4)),
                c("Hazard ratio (95% CI)", rep(NA, 4)))

xaxisL  <- list(rep(NA, 5), 
                rep("Usual total physical activity, MET-hour/day", 5))



# set up the Jasper page
type <- "PNG"
SetPage(orient         = "LANDSCAPE",
        perpage        = 10,
        type           = type, 
        png_bg = "white",
        page_width     = 18,
        page_height    = 12,
        page_dpi       = 600,
        page_pointsize = 11.5,
        suppress.date  = TRUE,
        titlespace     = 0.13, 
        footerspace    = 0.06,
        filestem       = "eFigure 4 - Sensitivity analysis PA (exclusion)", 
        footer.cex      = 1.5, 
        footer    = "Analyses were stratified by age-at-risk, sex, and study area and adjusted for income, education, occupation, alcohol, smoking, sedentary time, ephysema, bronchitis and COPD (where applicable)
        
        \n \n")


# loop over the panels in a slightly strange order, to match data
for (j in seq_along(plotdata)) {
  
  for (k in seq_along(plotdata[[1]])) {
    
 
	# do the linear plot for this set of data
	LinearPlot(plotdata[[j]][[k]], 
	           new.plot          = TRUE, 
	           mainfont          = 1,   
	           YLogScale         = TRUE, 
	           ExponentiateDataOnPlot = TRUE,
	           boxparm.stderr    = 0.025, 
	           xlim              = c(10,30),  
	           xticks            = seq(10,30, 5), 
	           ylim              = c(0.25, 2), 
	           yticks            = c(0.25, 0.5, 1, 2), 
	           margins           = c(5,5,3,2),  
	           xticklabs.cex     = 0.9, 
	           yticklabs.cex     = 0.9,
	           PointLabelsTop    = "exp_est",
	           PointLabelsBottom = "Events",
	           PointLabelsCEX    = 0.8, 
	           TruncateAtPlotLims = FALSE,
	           CIsOnTop           = TRUE)
	
	# add axis labels
	AxisLabels(ylab=yaxisL[[j]][k], 
	           xlab=xaxisL[[j]][k], 
	           mainfont=0.9)
	
	par(xpd=NA)
	
	
	# add the column heading
	
	if(j == 1) {
	 text(x=20, y=log(3.2), labels=headers[k], font=2, cex = 1)
	}
	
	 text(x=20, y=log(1.9), labels=events_sum[[j]][[k]], font=1, cex = 1)
	 text(x=10,  y=log(2.2), labels= outcome[[j]][[k]], font=2, adj=c(0,0), cex = 1.2)
	
	
	# Add labels for HR 
	text(x      = 10, 
	     y      = log(0.26), 
	     labels = paste0("Per usual level\n", paste0(hr_cont_labels[[j]][[k]]$term_level, ":", collapse = "\n")), 
	     font   = 1, 
	     cex    = 0.8, 
	     adj    = c(0, 0)
	     )
	
	text(x      = 20.5, 
	     y      = log(0.26), 
	     labels = paste0("HR (95% CI)\n", paste0(hr_cont_labels[[j]][[k]]$hr_ci, collapse = "\n")), 
	     font   = 1, 
	     cex    = 0.8, 
	     adj    = c(0, 0)
	     )

  }
  
}

## Plot title 
##Plot title

new.plot=TRUE

text(x      = -45, 
     y      = log(90), 
     font   = 2, 
     cex    = 1.2,
     adj    = c(0.5, 0),
     labels = "eFigure 4: Associations of total physical activity with heart failure and pulmonary heart disease after sequential exclusion of participants with prior diseases")


closeFile(type)




```


